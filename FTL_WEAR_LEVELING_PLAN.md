# EC模块完善与FTL磨损均衡开发计划表
## 2025年11月7日 - 2025年12月31日

> **项目目标**：
> 1. 完善EC模块基本框架，实现完整的EC纠删码功能（I/O处理、故障恢复、重建等）
> 2. 实现基于磨损均衡的FTL模块，通过EC模块的扩展接口控制数据分布，根据设备磨损情况分散数据写入

---

## 第一阶段：EC模块核心功能完善（11月7日 - 11月20日）

### 11月7日（周四）
1. **完善EC模块数据结构**：完善`ec_bdev`结构体，添加缺失的字段（strip_size、k、p、状态管理等）
2. **实现EC模块注册**：实现模块初始化函数`ec_bdev_init()`和清理函数，完成SPDK模块注册
3. **实现EC bdev创建接口**：实现`ec_bdev_create()`函数，支持通过RPC创建EC bdev

### 11月8日（周五）
1. **实现base bdev添加功能**：实现`ec_bdev_add_base_bdev()`函数，支持动态添加底层设备
2. **实现base bdev移除功能**：实现`ec_bdev_remove_base_bdev()`函数，支持动态移除底层设备
3. **实现EC bdev删除接口**：实现`ec_bdev_delete()`函数，支持通过RPC删除EC bdev

### 11月9日（周六）
1. **实现I/O通道创建**：实现`ec_bdev_get_io_channel()`和`ec_bdev_create_cb()`，为每个线程创建I/O通道
2. **实现I/O请求提交框架**：实现`ec_bdev_submit_request()`函数框架，处理读写请求的路由
3. **实现I/O类型支持检查**：实现`ec_bdev_io_type_supported()`函数，声明支持的I/O类型

### 11月10日（周日）
1. **实现完整条带写入路径**：实现完整条带写入逻辑，包括数据准备、ISA-L编码、并行写入
2. **实现ISA-L编码集成**：集成ISA-L库，实现EC编码功能，生成校验块
3. **实现数据块和校验块分布**：实现轮询分布算法，将数据块和校验块分布到k+p个设备

### 11月11日（周一）
1. **实现完整条带读取路径**：实现完整条带读取逻辑，直接从k个数据块读取，无需解码
2. **实现部分条带读取路径**：实现部分条带读取，支持读取条带的一部分数据
3. **实现读取错误处理**：实现读取失败时的错误处理，包括设备故障检测

### 11月12日（周二）
1. **实现RMW（Read-Modify-Write）路径**：实现部分写入的RMW逻辑，读取旧数据、合并、重新编码
2. **实现RMW读取阶段**：实现RMW中的读取阶段，读取所有k个数据块
3. **实现RMW编码阶段**：实现RMW中的编码阶段，合并新数据并重新生成校验块

### 11月13日（周三）
1. **实现RMW写入阶段**：实现RMW中的写入阶段，写入修改的数据块和所有校验块
2. **实现I/O完成回调处理**：实现`ec_base_bdev_io_complete()`函数，处理底层I/O完成事件
3. **实现I/O错误处理**：完善I/O错误处理逻辑，包括部分失败的回滚机制

### 11月14日（周四）
1. **实现Superblock机制**：设计并实现superblock结构，用于持久化EC bdev配置信息
2. **实现Superblock写入**：实现`ec_bdev_write_superblock()`函数，将配置写入每个base bdev
3. **实现Superblock读取**：实现`ec_bdev_read_superblock()`函数，从base bdev读取配置

### 11月15日（周五）
1. **实现自动重建机制**：实现examine机制，系统重启后自动检测并重建EC bdev配置
2. **实现examine回调**：实现`ec_bdev_examine()`函数，当base bdev添加时自动调用
3. **实现UUID匹配逻辑**：实现通过UUID匹配base bdev到EC bdev的逻辑

### 11月16日（周六）
1. **实现设备故障检测**：实现`ec_bdev_fail_base_bdev()`函数，标记故障设备
2. **实现降级模式**：实现降级模式支持，允许在部分设备故障时继续提供服务
3. **实现故障设备状态管理**：实现故障设备的状态跟踪和更新

### 11月17日（周日）
1. **实现数据重建框架**：实现`ec_bdev_start_rebuild()`函数，启动数据重建流程
2. **实现重建条带处理**：实现`ec_rebuild_next_stripe()`函数，处理下一个条带的重建
3. **实现重建读取逻辑**：实现重建中的读取逻辑，从k个可用设备读取数据

### 11月18日（周一）
1. **实现重建解码逻辑**：实现重建中的解码逻辑，使用ISA-L解码恢复故障设备数据
2. **实现重建写入逻辑**：实现重建中的写入逻辑，将恢复的数据写入新设备
3. **实现重建进度跟踪**：实现重建进度跟踪，记录当前重建的条带和总进度

### 11月19日（周二）
1. **实现RPC创建接口**：实现`rpc_bdev_ec_create()`函数，支持通过JSON-RPC创建EC bdev
2. **实现RPC删除接口**：实现`rpc_bdev_ec_delete()`函数，支持通过JSON-RPC删除EC bdev
3. **实现RPC添加设备接口**：实现`rpc_bdev_ec_add_base_bdev()`函数，支持通过RPC添加设备

### 11月20日（周三）
1. **实现RPC查询接口**：实现`rpc_bdev_ec_get_bdevs()`函数，支持查询EC bdev信息
2. **实现JSON信息输出**：实现`ec_bdev_write_info_json()`函数，输出EC bdev的详细信息
3. **第一阶段测试和修复**：执行第一阶段功能测试，修复发现的问题

---

## 第二阶段：EC扩展接口实现与FTL磨损均衡基础（11月21日 - 12月5日）

### 11月21日（周四）
1. **设计EC扩展接口架构**：设计`ec_bdev_extension_if`结构体，定义扩展接口的回调函数类型
2. **实现扩展接口注册机制**：实现`ec_bdev_register_extension()`函数，支持外部模块注册扩展接口
3. **实现扩展接口注销机制**：实现`ec_bdev_unregister_extension()`函数，支持注销扩展接口

### 11月22日（周五）
1. **在I/O路径中集成扩展接口**：在`ec_bdev_submit_request()`中检查并使用扩展接口选择设备
2. **实现select_base_bdevs调用**：在写入路径中调用扩展接口的`select_base_bdevs`回调
3. **实现notify_io_complete调用**：在I/O完成回调中调用扩展接口的`notify_io_complete`回调

### 11月23日（周六）
1. **创建FTL磨损均衡模块框架**：在`module/bdev/ec/`下创建`ftl_wear_leveling.c`和`ftl_wear_leveling.h`文件
2. **定义磨损统计数据结构**：设计磨损统计结构体（wear_stats），包含每个base bdev的写入计数、磨损等级等字段
3. **实现磨损统计初始化函数**：创建`ftl_wl_init()`函数，初始化磨损统计数据结构，为每个base bdev分配统计信息

### 11月24日（周日）
1. **实现磨损统计清理函数**：创建`ftl_wl_fini()`函数，正确释放所有分配的资源
2. **设计磨损等级计算算法**：设计从写入计数到磨损等级（0-100）的映射算法，考虑设备容量和写入次数
3. **实现磨损等级获取函数**：实现`ftl_wl_get_wear_level()`函数，根据base bdev的写入统计计算当前磨损等级

### 11月25日（周一）
1. **实现磨损统计更新机制**：设计并实现写入计数更新逻辑，支持原子操作更新统计信息
2. **添加线程安全保护**：为磨损统计数据结构添加互斥锁或原子操作，确保多线程环境下的数据一致性
3. **实现扩展接口init回调**：实现FTL磨损均衡模块的init回调，完成模块初始化

### 11月26日（周二）
1. **实现扩展接口fini回调**：实现FTL磨损均衡模块的fini回调，完成模块清理
2. **实现select_base_bdevs回调框架**：实现`ftl_wl_select_base_bdevs()`函数框架，接收EC模块的参数
3. **实现基础设备选择算法**：实现简单的磨损均衡选择算法，优先选择磨损等级较低的设备

### 11月27日（周三）
1. **实现数据块选择逻辑**：在select_base_bdevs中实现数据块（k个）的选择逻辑，优先选择磨损低的设备
2. **实现校验块选择逻辑**：在select_base_bdevs中实现校验块（p个）的选择逻辑，平衡磨损分布
3. **实现设备磨损排序算法**：实现快速排序或堆排序算法，对base bdevs按磨损等级排序

### 11月28日（周四）
1. **实现notify_io_complete回调**：实现`ftl_wl_notify_io_complete()`函数，在I/O完成时更新磨损统计
2. **添加写入计数更新逻辑**：在notify_io_complete中，对写入操作更新对应base bdev的写入计数
3. **实现get_wear_level回调**：实现`ftl_wl_get_wear_level()`回调函数，供EC模块查询磨损等级

### 11月29日（周五）
1. **实现轮询+磨损混合策略**：实现混合选择策略，结合轮询分布和磨损均衡，避免单一策略的问题
2. **优化选择算法性能**：优化select_base_bdevs函数，减少不必要的排序操作，使用缓存结果
3. **添加选择算法配置参数**：设计配置结构体，支持不同的选择策略（最小磨损优先、轮询+磨损等）

### 11月30日（周六）
1. **实现磨损统计持久化设计**：设计磨损统计信息的持久化方案，考虑保存到EC superblock
2. **实现磨损统计保存到superblock**：将磨损统计信息保存到EC superblock，支持系统重启后恢复
3. **实现superblock读取和解析**：实现从superblock读取磨损统计信息的逻辑

### 12月1日（周日）
1. **实现磨损统计查询接口**：实现RPC接口或函数，允许查询每个base bdev的磨损统计信息
2. **添加磨损统计JSON输出**：实现`ftl_wl_write_stats_json()`函数，将磨损统计信息输出为JSON格式
3. **实现磨损均衡状态监控**：添加状态监控机制，跟踪磨损均衡模块的运行状态和效果

### 12月2日（周一）
1. **添加磨损阈值检查**：实现磨损阈值检查机制，当设备磨损超过阈值时发出警告或采取特殊策略
2. **实现设备健康状态跟踪**：添加设备健康状态字段，跟踪设备是否可用、是否故障等状态
3. **实现磨损均衡效果评估**：添加评估函数，计算磨损分布的方差或标准差，评估均衡效果

### 12月3日（周二）
1. **添加调试日志输出**：实现详细的调试日志，记录设备选择过程、磨损等级变化等关键信息
2. **实现错误处理机制**：完善错误处理，添加错误码定义，确保所有错误路径都有适当的处理
3. **添加单元测试框架**：创建测试文件`ftl_wear_leveling_ut.c`，搭建单元测试框架

### 12月4日（周三）
1. **编写基础功能单元测试**：编写磨损统计初始化、更新、查询等基础功能的单元测试
2. **编写选择算法单元测试**：编写设备选择算法的单元测试，验证不同场景下的选择结果
3. **编写错误处理单元测试**：编写错误处理路径的单元测试，验证异常情况下的行为

### 12月5日（周四）
1. **修复第二阶段发现的问题**：修复单元测试中发现的问题，完善代码逻辑
2. **EC模块与FTL模块集成测试**：执行EC模块和FTL磨损均衡模块的集成测试
3. **第二阶段总结文档**：编写第二阶段总结文档，记录已完成的功能和遇到的问题

---

## 第三阶段：FTL磨损均衡高级功能与优化（12月6日 - 12月20日）

### 12月6日（周五）
1. **实现高级选择策略：最小磨损优先**：实现最小磨损优先策略，总是选择磨损等级最低的k+p个设备
2. **实现高级选择策略：加权随机**：实现加权随机选择策略，根据磨损等级分配选择权重
3. **实现高级选择策略：负载均衡**：实现负载均衡策略，考虑当前I/O负载和磨损等级

### 12月7日（周六）
1. **实现磨损均衡触发机制**：实现自动触发机制，当磨损分布不均时自动触发重新均衡
2. **实现数据迁移规划**：设计数据迁移规划算法，计算需要迁移的数据块和目标设备
3. **实现迁移优先级计算**：实现迁移优先级计算，优先迁移磨损差异大的数据

### 12月8日（周日）
1. **实现superblock更新机制**：实现定期或按需更新superblock中磨损统计信息的机制
2. **实现磨损均衡后台任务**：实现后台任务，定期检查磨损分布并执行均衡操作
3. **实现任务调度机制**：实现任务调度机制，控制后台任务的执行频率和优先级

### 12月9日（周一）
1. **实现任务暂停和恢复**：实现任务暂停和恢复功能，允许动态控制后台任务
2. **实现磨损预测算法**：实现简单的磨损预测算法，基于历史数据预测未来磨损趋势
3. **实现预防性均衡**：实现预防性均衡机制，在设备磨损达到阈值前提前进行均衡

### 12月10日（周二）
1. **优化选择算法时间复杂度**：优化设备选择算法，使用堆或优先队列降低时间复杂度
2. **实现选择结果缓存**：实现选择结果缓存机制，对相同条带索引的请求复用选择结果
3. **优化统计更新性能**：优化磨损统计更新性能，使用无锁数据结构或批量更新

### 12月11日（周三）
1. **实现异步统计更新**：将统计更新改为异步操作，避免阻塞I/O路径
2. **实现批量统计更新**：实现批量更新机制，累积多个I/O完成事件后批量更新统计
3. **添加更新队列管理**：实现更新队列管理，控制批量更新的频率和大小

### 12月12日（周四）
1. **实现磨损均衡RPC接口**：实现RPC接口，允许通过JSON-RPC控制磨损均衡模块
2. **实现查询磨损统计RPC**：实现查询接口，通过RPC查询指定EC bdev的磨损统计
3. **实现配置磨损均衡RPC**：实现配置接口，通过RPC动态配置磨损均衡参数

### 12月13日（周五）
1. **实现磨损均衡启动/停止RPC**：实现启动和停止接口，允许动态启用或禁用磨损均衡
2. **实现重置统计RPC**：实现重置接口，通过RPC重置磨损统计信息
3. **实现导出统计RPC**：实现导出接口，通过RPC导出磨损统计信息到文件

### 12月14日（周六）
1. **实现磨损均衡状态查询RPC**：实现状态查询接口，查询磨损均衡模块的运行状态
2. **实现均衡操作触发RPC**：实现手动触发接口，允许通过RPC手动触发均衡操作
3. **添加RPC参数验证**：添加RPC参数验证，确保输入参数的有效性和安全性

### 12月15日（周日）
1. **实现磨损均衡效果可视化**：实现可视化接口，输出磨损分布的图表或统计信息
2. **实现实时监控接口**：实现实时监控接口，允许外部程序查询当前磨损状态
3. **添加性能指标收集**：添加性能指标收集，跟踪磨损均衡对I/O性能的影响

### 12月16日（周一）
1. **实现自适应策略选择**：实现自适应机制，根据系统负载和磨损分布自动选择最优策略
2. **实现策略效果评估**：实现策略效果评估，比较不同策略的均衡效果和性能影响
3. **实现策略切换机制**：实现策略动态切换机制，允许运行时切换不同的选择策略

### 12月17日（周二）
1. **实现磨损均衡集成测试**：创建集成测试，测试磨损均衡模块与EC模块的完整集成
2. **实现端到端测试场景**：创建端到端测试场景，模拟真实使用情况下的磨损均衡
3. **实现压力测试**：创建压力测试，测试高并发I/O下的磨损均衡性能和稳定性

### 12月18日（周三）
1. **修复第三阶段发现的问题**：修复集成测试和压力测试中发现的问题
2. **性能优化和调优**：根据测试结果进行性能优化，提升关键路径的性能
3. **第三阶段总结文档**：编写第三阶段总结文档，记录高级功能实现情况

### 12月19日（周四）
1. **执行完整功能测试**：执行完整的功能测试，覆盖所有核心功能和高级功能
2. **执行性能测试**：执行性能测试，测量磨损均衡对I/O性能的影响
3. **分析性能测试结果**：分析性能测试结果，识别性能瓶颈

### 12月20日（周五）
1. **优化I/O路径性能**：优化I/O路径中的磨损均衡逻辑，减少性能开销
2. **优化统计更新性能**：进一步优化统计更新性能，减少对I/O性能的影响
3. **优化内存使用**：优化内存使用，减少内存占用和碎片

---

## 第四阶段：测试、优化与文档完善（12月21日 - 12月31日）

### 12月21日（周六）
1. **实现内存泄漏检测**：添加内存泄漏检测机制，确保没有内存泄漏
2. **修复内存泄漏问题**：修复检测到的所有内存泄漏问题
3. **实现资源使用监控**：实现资源使用监控，跟踪内存、CPU等资源使用情况

### 12月22日（周日）
1. **编写用户使用文档**：编写用户使用文档，说明如何配置和使用磨损均衡功能
2. **编写API参考文档**：编写API参考文档，详细说明所有公开接口
3. **编写配置参数文档**：编写配置参数文档，说明所有配置参数的含义和用法

### 12月23日（周一）
1. **编写架构设计文档**：编写架构设计文档，说明EC模块和磨损均衡模块的设计思路
2. **编写算法说明文档**：编写算法说明文档，详细说明各种选择策略的算法
3. **编写性能调优文档**：编写性能调优文档，说明如何优化EC和磨损均衡性能

### 12月24日（周二）
1. **编写故障排查文档**：编写故障排查文档，说明常见问题和解决方法
2. **编写最佳实践文档**：编写最佳实践文档，说明使用EC和磨损均衡的最佳实践
3. **编写示例代码**：编写示例代码，演示如何使用EC模块和磨损均衡功能

### 12月25日（周三）
1. **代码风格检查和修复**：检查代码风格，修复不符合规范的代码
2. **添加代码注释**：为所有公共接口和复杂逻辑添加详细的代码注释
3. **完善错误消息**：完善所有错误消息，使其更加清晰和有用

### 12月26日（周四）
1. **实现日志级别控制**：实现日志级别控制，允许用户配置日志详细程度
2. **优化日志输出格式**：优化日志输出格式，使其更加易读和有用
3. **添加关键操作审计日志**：添加关键操作的审计日志，记录重要操作和状态变化

### 12月27日（周五）
1. **执行完整回归测试**：执行完整的回归测试，确保所有功能正常
2. **执行长时间稳定性测试**：执行长时间稳定性测试，验证系统长期运行的稳定性
3. **修复稳定性测试中发现的问题**：修复稳定性测试中发现的所有问题

### 12月28日（周六）
1. **代码审查和优化**：进行最终代码审查，进行最后的优化
2. **文档审查和更新**：审查所有文档，确保文档的准确性和完整性
3. **准备交付材料**：准备交付材料，包括代码、文档、测试报告等

### 12月29日（周日）
1. **最终功能验证**：进行最终功能验证，确保所有功能符合需求
2. **性能基准测试**：执行性能基准测试，记录性能指标
3. **执行最终集成测试**：执行最终集成测试，验证与整个系统的集成

### 12月30日（周一）
1. **执行兼容性测试**：执行兼容性测试，验证与不同版本SPDK的兼容性
2. **修复最终测试问题**：修复最终测试中发现的所有问题
3. **交付准备完成**：完成所有交付准备工作

### 12月31日（周二）
1. **最终交付**：完成最终交付，提交所有代码和文档
2. **项目总结**：编写项目总结，记录项目完成情况和经验教训
3. **庆祝完成**：庆祝项目完成！🎉

---

## 关键里程碑

- **11月20日**：第一阶段完成，EC模块核心功能完善完成
- **12月5日**：第二阶段完成，EC扩展接口和FTL磨损均衡基础功能完成
- **12月20日**：第三阶段完成，FTL磨损均衡高级功能和优化完成
- **12月31日**：第四阶段完成，项目交付完成

---

## 风险与应对

1. **EC模块复杂度风险**：EC模块实现复杂度可能超出预期
   - 应对：分阶段实现，先实现核心I/O功能，再逐步完善故障恢复和重建

2. **性能影响风险**：磨损均衡可能影响I/O性能
   - 应对：优化关键路径，使用异步和批量更新

3. **集成复杂度风险**：EC模块和FTL模块集成可能遇到问题
   - 应对：提前设计扩展接口，确保接口清晰和稳定

4. **测试不充分风险**：测试可能不够充分
   - 应对：制定详细的测试计划，覆盖各种场景

5. **文档不完善风险**：文档可能不够完善
   - 应对：边开发边写文档，及时更新文档

---

## 备注

- 每天的工作量可以根据实际情况调整
- 如果某个功能提前完成，可以提前开始下一个功能
- 如果遇到技术难题，可以适当延长相关功能的开发时间
- 建议每天提交代码，保持代码库的更新
- 建议定期进行代码审查，确保代码质量
- EC模块是基础，需要优先完成并充分测试
- FTL磨损均衡模块依赖EC模块的扩展接口，需要在EC模块稳定后再深入开发

