# SPDK Bdevæ¨¡å—å®Œæ•´å¼€å‘æŒ‡å—

> **ç›®æ ‡**ï¼šé€šè¿‡æœ¬æŒ‡å—ï¼Œå³ä½¿ä½ å®Œå…¨ä¸ä¼šSPDKï¼Œä¹Ÿèƒ½è·Ÿç€æ–‡æ¡£ä¸€æ­¥æ­¥åˆ›å»ºè‡ªå·±çš„bdevæ¨¡å—ã€‚æœ¬æŒ‡å—é‡‡ç”¨**è‡ªé¡¶å‘ä¸‹åˆ†è§£ã€è‡ªåº•å‘ä¸Šå®ç°**çš„æ€æƒ³ï¼Œä»æœ€ç®€å•çš„éœ€æ±‚å¼€å§‹ï¼Œé€æ­¥æ·±å…¥åˆ°å¤æ‚çš„å®ç°ã€‚

---

## ç›®å½•

1. [ç¬¬ä¸€éƒ¨åˆ†ï¼šåˆ›å»ºä¸€ä¸ªå±äºè‡ªå·±çš„Bdevéœ€è¦ä»€ä¹ˆ](#ç¬¬ä¸€éƒ¨åˆ†åˆ›å»ºä¸€ä¸ªå±äºè‡ªå·±çš„bdevéœ€è¦ä»€ä¹ˆ)
2. [ç¬¬äºŒéƒ¨åˆ†ï¼šRAID 0å®ç°ç¤ºä¾‹](#ç¬¬äºŒéƒ¨åˆ†raid-0å®ç°ç¤ºä¾‹)
3. [ç¬¬ä¸‰éƒ¨åˆ†ï¼šECï¼ˆçº åˆ ç ï¼‰å®ç°ç¤ºä¾‹](#ç¬¬ä¸‰éƒ¨åˆ†ecçº åˆ ç å®ç°ç¤ºä¾‹)
4. [æ€»ç»“ä¸è¿›é˜¶](#æ€»ç»“ä¸è¿›é˜¶)

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šåˆ›å»ºä¸€ä¸ªå±äºè‡ªå·±çš„Bdevéœ€è¦ä»€ä¹ˆ

### ğŸ¯ é¡¶å±‚ç›®æ ‡

**æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ**

åˆ›å»ºä¸€ä¸ªSPDK Bdevæ¨¡å—ï¼Œå¯ä»¥é€šè¿‡RPCåˆ›å»ºè™šæ‹Ÿç£ç›˜ï¼Œæ”¯æŒè¯»å†™æ“ä½œã€‚

### ç¬¬ä¸€å±‚åˆ†è§£ï¼šéœ€è¦ä»€ä¹ˆï¼Ÿ

**â“ å®ç°ä¸€ä¸ªSPDK Bdevæ¨¡å—éœ€è¦ä»€ä¹ˆï¼Ÿ**

éœ€è¦5ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š

1. **æ¨¡å—æ³¨å†Œ** - å‘Šè¯‰SPDKè¿™æ˜¯ä¸€ä¸ªbdevæ¨¡å—
2. **æ•°æ®ç»“æ„** - å®šä¹‰bdevã€I/Oã€é€šé“ç­‰ç»“æ„
3. **å‡½æ•°è¡¨** - å®ç°bdevçš„æ“ä½œå‡½æ•°ï¼ˆåˆ›å»ºã€é”€æ¯ã€I/Oå¤„ç†ç­‰ï¼‰
4. **I/Oå¤„ç†** - å¤„ç†è¯»å†™ç­‰I/Oè¯·æ±‚
5. **RPCæ¥å£** - é€šè¿‡RPCåˆ›å»ºå’Œåˆ é™¤bdev

### ç¬¬äºŒå±‚åˆ†è§£ï¼šæ¯ä¸ªç»„ä»¶éœ€è¦ä»€ä¹ˆï¼Ÿ

#### ç»„ä»¶1ï¼šæ¨¡å—æ³¨å†Œ

**ğŸ¯ æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ** è®©SPDKè¯†åˆ«å¹¶åŠ è½½æˆ‘ä»¬çš„æ¨¡å—

**â“ éœ€è¦ä»€ä¹ˆï¼Ÿ**
- `struct spdk_bdev_module` ç»“æ„
- æ¨¡å—åˆå§‹åŒ–å‡½æ•°
- æ¨¡å—æ¸…ç†å‡½æ•°
- I/Oä¸Šä¸‹æ–‡å¤§å°å‡½æ•°
- æ¨¡å—æ³¨å†Œå®

**âœ… å¦‚ä½•å®ç°ï¼Ÿ**

```c
/* æ­¥éª¤1ï¼šå®šä¹‰æ¨¡å—æ¥å£ç»“æ„ */
static struct spdk_bdev_module demo_if = {
    .name = "demo",
    .module_init = bdev_demo_initialize,  // åˆå§‹åŒ–å‡½æ•°
    .module_fini = bdev_demo_finish,      // æ¸…ç†å‡½æ•°
    .get_ctx_size = bdev_demo_get_ctx_size, // I/Oä¸Šä¸‹æ–‡å¤§å°
};

/* æ­¥éª¤2ï¼šæ³¨å†Œæ¨¡å— */
SPDK_BDEV_MODULE_REGISTER(demo, &demo_if)
```

**ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ** SPDKåœ¨å¯åŠ¨æ—¶ä¼šæ‰«ææ‰€æœ‰æ³¨å†Œçš„æ¨¡å—ï¼Œè°ƒç”¨åˆå§‹åŒ–å‡½æ•°ï¼Œå¹¶åˆ†é…I/Oä¸Šä¸‹æ–‡ç©ºé—´ã€‚

#### ç»„ä»¶2ï¼šæ•°æ®ç»“æ„

**ğŸ¯ æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ** å®šä¹‰å­˜å‚¨bdevä¿¡æ¯ã€I/Oä¿¡æ¯ã€é€šé“ä¿¡æ¯çš„æ•°æ®ç»“æ„

**â“ éœ€è¦ä»€ä¹ˆï¼Ÿ**
- `struct demo_bdev` - å­˜å‚¨bdevä¿¡æ¯
- `struct demo_bdev_io` - å­˜å‚¨æ¯ä¸ªI/Oçš„ç§æœ‰æ•°æ®
- `struct demo_io_channel` - å­˜å‚¨æ¯ä¸ªçº¿ç¨‹çš„I/Oé˜Ÿåˆ—

**âœ… å¦‚ä½•å®ç°ï¼Ÿ**

```c
/* æ­¥éª¤1ï¼šå®šä¹‰I/Oä¸Šä¸‹æ–‡ç»“æ„ */
struct demo_bdev_io {
    TAILQ_ENTRY(demo_bdev_io) link;  /* ç”¨äºæ”¾å…¥é˜Ÿåˆ— */
};

/* æ­¥éª¤2ï¼šå®šä¹‰Bdevç»“æ„ */
struct demo_bdev {
    struct spdk_bdev bdev;        /* å¿…é¡»æ”¾åœ¨ç¬¬ä¸€ä¸ªå­—æ®µ */
    TAILQ_ENTRY(demo_bdev) tailq; /* ç”¨äºæ”¾å…¥å…¨å±€é“¾è¡¨ */
    /* ä½ çš„ç§æœ‰æ•°æ® */
};

/* æ­¥éª¤3ï¼šå®šä¹‰I/Oé€šé“ç»“æ„ */
struct demo_io_channel {
    struct spdk_poller *poller;           /* å¤„ç†I/Oçš„poller */
    TAILQ_HEAD(, demo_bdev_io) io_queue;   /* I/Oè¯·æ±‚é˜Ÿåˆ— */
};
```

**ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ**
- `spdk_bdev`å¿…é¡»æ”¾åœ¨ç¬¬ä¸€ä¸ªå­—æ®µï¼Œå› ä¸ºSPDKä¼šé€šè¿‡`container_of`å®è·å–æˆ‘ä»¬çš„ç»“æ„
- I/Oä¸Šä¸‹æ–‡ç”¨äºå­˜å‚¨æ¯ä¸ªI/Oçš„ç§æœ‰æ•°æ®
- I/Oé€šé“æ˜¯çº¿ç¨‹æœ¬åœ°çš„ï¼Œé¿å…é”ç«äº‰

#### ç»„ä»¶3ï¼šå‡½æ•°è¡¨

**ğŸ¯ æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ** å®ç°bdevçš„æ‰€æœ‰æ“ä½œå‡½æ•°

**â“ éœ€è¦ä»€ä¹ˆï¼Ÿ**
- `destruct` - é”€æ¯bdev
- `submit_request` - æäº¤I/Oè¯·æ±‚
- `io_type_supported` - æ£€æŸ¥I/Oç±»å‹æ˜¯å¦æ”¯æŒ
- `get_io_channel` - è·å–I/Oé€šé“

**âœ… å¦‚ä½•å®ç°ï¼Ÿ**

```c
/* æ­¥éª¤1ï¼šå®šä¹‰å‡½æ•°è¡¨ */
static const struct spdk_bdev_fn_table demo_fn_table = {
    .destruct = bdev_demo_destruct,
    .submit_request = bdev_demo_submit_request,
    .io_type_supported = bdev_demo_io_type_supported,
    .get_io_channel = bdev_demo_get_io_channel,
};

/* æ­¥éª¤2ï¼šåœ¨åˆ›å»ºbdevæ—¶è®¾ç½®å‡½æ•°è¡¨ */
demo_bdev->bdev.fn_table = &demo_fn_table;
```

**ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ** SPDKé€šè¿‡å‡½æ•°è¡¨è°ƒç”¨æˆ‘ä»¬çš„å‡½æ•°ï¼Œå®ç°bdevçš„å„ç§æ“ä½œã€‚

#### ç»„ä»¶4ï¼šI/Oå¤„ç†

**ğŸ¯ æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ** å¤„ç†è¯»å†™ç­‰I/Oè¯·æ±‚

**â“ éœ€è¦ä»€ä¹ˆï¼Ÿ**
- `submit_request` - å°†I/Oæ”¾å…¥é˜Ÿåˆ—
- `poll_io` - ä»é˜Ÿåˆ—å–å‡ºI/Oå¹¶å¤„ç†
- I/Oå®Œæˆå›è°ƒ

**âœ… å¦‚ä½•å®ç°ï¼Ÿ**

```c
/* æ­¥éª¤1ï¼šæäº¤I/Oè¯·æ±‚ */
static void bdev_demo_submit_request(struct spdk_io_channel *_ch, 
                                     struct spdk_bdev_io *bdev_io)
{
    struct demo_io_channel *ch = spdk_io_channel_get_ctx(_ch);
    struct demo_bdev_io *demo_io = (struct demo_bdev_io *)bdev_io->driver_ctx;
    
    /* å°†I/Oæ”¾å…¥é˜Ÿåˆ— */
    TAILQ_INSERT_TAIL(&ch->io_queue, demo_io, link);
}

/* æ­¥éª¤2ï¼šå¤„ç†I/Oï¼ˆåœ¨pollerä¸­è°ƒç”¨ï¼‰ */
static int bdev_demo_poll_io(void *arg)
{
    struct demo_io_channel *ch = arg;
    struct demo_bdev_io *demo_io = TAILQ_FIRST(&ch->io_queue);
    if (demo_io == NULL) return 0;
    
    TAILQ_REMOVE(&ch->io_queue, demo_io, link);
    struct spdk_bdev_io *bdev_io = spdk_bdev_io_from_ctx(demo_io);
    
    /* å¤„ç†I/O */
    switch (bdev_io->type) {
    case SPDK_BDEV_IO_TYPE_READ:
        /* è¯»å–ï¼šè¿”å›é›¶æ•°æ® */
        memset(bdev_io->u.bdev.iovs[0].iov_base, 0, 
               bdev_io->u.bdev.num_blocks * bdev_io->bdev->blocklen);
        spdk_bdev_io_complete(bdev_io, SPDK_BDEV_IO_STATUS_SUCCESS);
        break;
    case SPDK_BDEV_IO_TYPE_WRITE:
        /* å†™å…¥ï¼šç›´æ¥æˆåŠŸ */
        spdk_bdev_io_complete(bdev_io, SPDK_BDEV_IO_STATUS_SUCCESS);
        break;
    }
    return 1;
}
```

**ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ** SPDKä½¿ç”¨å¼‚æ­¥I/Oæ¨¡å‹ï¼ŒI/Oæäº¤åç«‹å³è¿”å›ï¼Œå®é™…å¤„ç†ç”±pollerå¼‚æ­¥å®Œæˆã€‚

#### ç»„ä»¶5ï¼šRPCæ¥å£

**ğŸ¯ æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ** é€šè¿‡RPCåˆ›å»ºå’Œåˆ é™¤bdev

**â“ éœ€è¦ä»€ä¹ˆï¼Ÿ**
- RPCè¯·æ±‚ç»“æ„
- JSONè§£ç å™¨
- RPCå¤„ç†å‡½æ•°
- RPCæ³¨å†Œ

**âœ… å¦‚ä½•å®ç°ï¼Ÿ**

```c
/* æ­¥éª¤1ï¼šå®šä¹‰RPCè¯·æ±‚ç»“æ„ */
struct rpc_create_demo_bdev {
    char *name;
    uint64_t num_blocks;
    uint32_t block_size;
};

/* æ­¥éª¤2ï¼šå®šä¹‰JSONè§£ç å™¨ */
static const struct spdk_json_object_decoder rpc_create_demo_bdev_decoders[] = {
    {"name", offsetof(struct rpc_create_demo_bdev, name), spdk_json_decode_string},
    {"num_blocks", offsetof(struct rpc_create_demo_bdev, num_blocks), spdk_json_decode_uint64},
    {"block_size", offsetof(struct rpc_create_demo_bdev, block_size), spdk_json_decode_uint32},
};

/* æ­¥éª¤3ï¼šå®ç°RPCå¤„ç†å‡½æ•° */
static void rpc_bdev_demo_create(struct spdk_jsonrpc_request *request,
                                 const struct spdk_json_val *params)
{
    struct rpc_create_demo_bdev req = {};
    
    /* è§£ç JSONå‚æ•° */
    if (spdk_json_decode_object(params, rpc_create_demo_bdev_decoders,
                                SPDK_COUNTOF(rpc_create_demo_bdev_decoders),
                                &req)) {
        spdk_jsonrpc_send_error_response(request, SPDK_JSONRPC_ERROR_PARSE_ERROR,
                                         "Invalid parameters");
        return;
    }
    
    /* åˆ›å»ºbdev */
    int rc = bdev_demo_create(&bdev, req.name, req.num_blocks, req.block_size);
    if (rc != 0) {
        spdk_jsonrpc_send_error_response(request, -rc, spdk_strerror(-rc));
        return;
    }
    
    /* å‘é€æˆåŠŸå“åº” */
    spdk_jsonrpc_send_bool_response(request, true);
}

/* æ­¥éª¤4ï¼šæ³¨å†ŒRPCæ–¹æ³• */
SPDK_RPC_REGISTER("bdev_demo_create", rpc_bdev_demo_create, SPDK_RPC_RUNTIME)
```

**ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ** RPCæ˜¯SPDKç®¡ç†bdevçš„æ ‡å‡†æ–¹å¼ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡JSON-RPCåˆ›å»ºã€åˆ é™¤ã€æŸ¥è¯¢bdevã€‚

### å®Œæ•´å®ç°æ­¥éª¤ï¼ˆ18æ­¥ï¼‰

å‚è€ƒ `bdev_demo_step_by_step.c` æ–‡ä»¶ï¼ŒåŒ…å«å®Œæ•´çš„18æ­¥å®ç°ï¼Œæ¯ä¸€æ­¥éƒ½æœ‰è¯¦ç»†çš„æ³¨é‡Šè¯´æ˜ã€‚

---

### æ•°æ®æµè½¬è¯¦è§£ï¼šDemoæ¨¡å—

**ğŸ¯ æˆ‘è¦ç†è§£ä»€ä¹ˆï¼Ÿ** ä¸€ä»½æ•°æ®ä»ç”¨æˆ·åº”ç”¨å‘å‡ºï¼Œåˆ°Demo bdevå¤„ç†å®Œæˆï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸­æ•°æ®æ˜¯å¦‚ä½•æµè½¬çš„ã€‚

#### å†™å…¥æ•°æ®æµè½¬ï¼ˆWriteï¼‰

**åœºæ™¯**ï¼šç”¨æˆ·åº”ç”¨å†™å…¥1000å­—èŠ‚æ•°æ®åˆ°Demo bdevçš„ç¬¬10å—

**å®Œæ•´æµç¨‹**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ1ï¼šç”¨æˆ·åº”ç”¨å‘èµ·å†™å…¥è¯·æ±‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ç”¨æˆ·åº”ç”¨è°ƒç”¨ï¼š
  spdk_bdev_write(bdev_desc, ch, buffer, offset, length, cb, cb_arg)
  â†“
SPDKæ¡†æ¶å±‚ï¼ˆlib/bdev/bdev.cï¼‰ï¼š
  - åˆ›å»º spdk_bdev_io ç»“æ„
  - è®¾ç½® bdev_io->type = SPDK_BDEV_IO_TYPE_WRITE
  - è®¾ç½® bdev_io->u.bdev.offset_blocks = 10
  - è®¾ç½® bdev_io->u.bdev.num_blocks = 1000 / blocklen
  - è®¾ç½® bdev_io->u.bdev.iovs[0].iov_base = buffer
  - è®¾ç½® bdev_io->u.bdev.iovs[0].iov_len = 1000
  â†“
è°ƒç”¨ bdev->fn_table->submit_request(ch, bdev_io)
  â†“
è¿›å…¥æˆ‘ä»¬çš„æ¨¡å—ï¼šbdev_demo_submit_request()

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ2ï¼šDemoæ¨¡å—æ¥æ”¶I/Oè¯·æ±‚                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
bdev_demo_submit_request(struct spdk_io_channel *_ch, 
                        struct spdk_bdev_io *bdev_io)
  â†“
1. è·å–I/Oé€šé“ä¸Šä¸‹æ–‡ï¼š
   struct demo_io_channel *ch = spdk_io_channel_get_ctx(_ch);
   â†“
2. è·å–I/Oä¸Šä¸‹æ–‡ï¼ˆdriver_ctxï¼‰ï¼š
   struct demo_bdev_io *demo_io = (struct demo_bdev_io *)bdev_io->driver_ctx;
   â†“
3. å°†I/Oæ”¾å…¥é˜Ÿåˆ—ï¼š
   TAILQ_INSERT_TAIL(&ch->io_queue, demo_io, link);
   â†“
4. å‡½æ•°è¿”å›ï¼ˆå¼‚æ­¥å¤„ç†ï¼‰
   â†“
æ³¨æ„ï¼šæ­¤æ—¶æ•°æ®è¿˜åœ¨ç”¨æˆ·æä¾›çš„bufferä¸­ï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰è®¿é—®æ•°æ®

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ3ï¼šPollerå¼‚æ­¥å¤„ç†I/O                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Pollerè¢«å®šæœŸè°ƒç”¨ï¼ˆç”±SPDKæ¡†æ¶è°ƒåº¦ï¼‰ï¼š
  bdev_demo_poll_io(void *arg)
  â†“
1. ä»é˜Ÿåˆ—å–å‡ºI/Oï¼š
   struct demo_bdev_io *demo_io = TAILQ_FIRST(&ch->io_queue);
   if (demo_io == NULL) return 0;  // é˜Ÿåˆ—ä¸ºç©ºï¼Œè¿”å›
   â†“
2. è·å–åŸå§‹bdev_ioï¼š
   struct spdk_bdev_io *bdev_io = spdk_bdev_io_from_ctx(demo_io);
   â†“
3. å¤„ç†å†™å…¥è¯·æ±‚ï¼š
   switch (bdev_io->type) {
   case SPDK_BDEV_IO_TYPE_WRITE:
       /* Demoæ¨¡å—ï¼šå†™å…¥æ“ä½œç›´æ¥æˆåŠŸï¼Œä¸å®é™…å­˜å‚¨æ•°æ® */
       /* æ³¨æ„ï¼šæ­¤æ—¶å¯ä»¥è®¿é—® bdev_io->u.bdev.iovs[0].iov_base ä¸­çš„æ•°æ® */
       /* ä½†Demoæ¨¡å—é€‰æ‹©ä¸å¤„ç†ï¼Œç›´æ¥å®ŒæˆI/O */
       spdk_bdev_io_complete(bdev_io, SPDK_BDEV_IO_STATUS_SUCCESS);
       break;
   }
   â†“
4. ä»é˜Ÿåˆ—ç§»é™¤ï¼š
   TAILQ_REMOVE(&ch->io_queue, demo_io, link);
   â†“
5. è¿”å›1ï¼ˆè¡¨ç¤ºå¤„ç†äº†1ä¸ªI/Oï¼‰

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ4ï¼šI/Oå®Œæˆå›è°ƒ                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
spdk_bdev_io_complete() è¢«è°ƒç”¨ï¼š
  â†“
1. SPDKæ¡†æ¶è°ƒç”¨ç”¨æˆ·æä¾›çš„å›è°ƒå‡½æ•°ï¼š
   cb(bdev_io, success, cb_arg)
   â†“
2. ç”¨æˆ·åº”ç”¨æ”¶åˆ°å†™å…¥å®Œæˆé€šçŸ¥
   â†“
3. æ•°æ®æµè½¬ç»“æŸ

**å…³é”®ç‚¹æ€»ç»“**ï¼š
- æ•°æ®å§‹ç»ˆåœ¨ç”¨æˆ·æä¾›çš„bufferä¸­ï¼ŒDemoæ¨¡å—ä¸å¤åˆ¶æ•°æ®
- Demoæ¨¡å—æ˜¯å¼‚æ­¥å¤„ç†ï¼ŒI/Oæäº¤åç«‹å³è¿”å›
- Pollerè´Ÿè´£å®é™…å¤„ç†ï¼Œå¯ä»¥è®¿é—®æ•°æ®ä½†Demoé€‰æ‹©ä¸å¤„ç†
```

#### è¯»å–æ•°æ®æµè½¬ï¼ˆReadï¼‰

**åœºæ™¯**ï¼šç”¨æˆ·åº”ç”¨ä»Demo bdevçš„ç¬¬10å—è¯»å–1000å­—èŠ‚æ•°æ®

**å®Œæ•´æµç¨‹**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ1ï¼šç”¨æˆ·åº”ç”¨å‘èµ·è¯»å–è¯·æ±‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ç”¨æˆ·åº”ç”¨è°ƒç”¨ï¼š
  spdk_bdev_read(bdev_desc, ch, buffer, offset, length, cb, cb_arg)
  â†“
SPDKæ¡†æ¶å±‚ï¼š
  - åˆ›å»º spdk_bdev_io ç»“æ„
  - è®¾ç½® bdev_io->type = SPDK_BDEV_IO_TYPE_READ
  - è®¾ç½® bdev_io->u.bdev.iovs[0].iov_base = bufferï¼ˆç”¨æˆ·æä¾›çš„ç¼“å†²åŒºï¼‰
  - è®¾ç½® bdev_io->u.bdev.iovs[0].iov_len = 1000
  â†“
è°ƒç”¨ bdev->fn_table->submit_request(ch, bdev_io)
  â†“
è¿›å…¥æˆ‘ä»¬çš„æ¨¡å—ï¼šbdev_demo_submit_request()

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ2ï¼šDemoæ¨¡å—æ¥æ”¶I/Oè¯·æ±‚                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
bdev_demo_submit_request()ï¼š
  â†“
1. è·å–I/Oé€šé“å’Œä¸Šä¸‹æ–‡
   â†“
2. å°†I/Oæ”¾å…¥é˜Ÿåˆ—
   â†“
3. å‡½æ•°è¿”å›ï¼ˆå¼‚æ­¥å¤„ç†ï¼‰

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ3ï¼šPollerå¤„ç†è¯»å–è¯·æ±‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
bdev_demo_poll_io()ï¼š
  â†“
1. ä»é˜Ÿåˆ—å–å‡ºI/O
   â†“
2. å¤„ç†è¯»å–è¯·æ±‚ï¼š
   case SPDK_BDEV_IO_TYPE_READ:
       /* è·å–ç”¨æˆ·æä¾›çš„ç¼“å†²åŒº */
       void *user_buffer = bdev_io->u.bdev.iovs[0].iov_base;
       size_t length = bdev_io->u.bdev.num_blocks * bdev_io->bdev->blocklen;
       â†“
       /* Demoæ¨¡å—ï¼šå°†ç¼“å†²åŒºæ¸…é›¶ï¼ˆæ¨¡æ‹Ÿè¿”å›é›¶æ•°æ®ï¼‰ */
       memset(user_buffer, 0, length);
       â†“
       /* å®ŒæˆI/O */
       spdk_bdev_io_complete(bdev_io, SPDK_BDEV_IO_STATUS_SUCCESS);
   â†“
3. å…³é”®ç‚¹ï¼šæ•°æ®ç›´æ¥å†™å…¥ç”¨æˆ·æä¾›çš„bufferï¼Œä¸éœ€è¦é¢å¤–å¤åˆ¶

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ4ï¼šç”¨æˆ·åº”ç”¨æ”¶åˆ°æ•°æ®                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ç”¨æˆ·å›è°ƒè¢«è°ƒç”¨ï¼š
  cb(bdev_io, success, cb_arg)
  â†“
ç”¨æˆ·åº”ç”¨çš„bufferä¸­ç°åœ¨æœ‰æ•°æ®ï¼ˆDemoæ¨¡å—è¿”å›çš„æ˜¯å…¨é›¶æ•°æ®ï¼‰
```

**æ•°æ®æµè½¬å…³é”®ç‚¹**ï¼š

1. **é›¶æ‹·è´**ï¼šæ•°æ®ç›´æ¥åœ¨ç”¨æˆ·bufferä¸­ï¼Œä¸éœ€è¦é¢å¤–å¤åˆ¶
2. **å¼‚æ­¥å¤„ç†**ï¼šI/Oæäº¤åç«‹å³è¿”å›ï¼Œå®é™…å¤„ç†ç”±pollerå¼‚æ­¥å®Œæˆ
3. **çº¿ç¨‹å®‰å…¨**ï¼šæ¯ä¸ªçº¿ç¨‹æœ‰ç‹¬ç«‹çš„I/Oé˜Ÿåˆ—ï¼Œé¿å…é”ç«äº‰
4. **å†…å­˜ç®¡ç†**ï¼šç”¨æˆ·è´Ÿè´£æä¾›å’Œé‡Šæ”¾bufferï¼Œbdevæ¨¡å—ä¸ç®¡ç†

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šRAID 0å®ç°ç¤ºä¾‹

### ğŸ¯ é¡¶å±‚ç›®æ ‡

**æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ**

å®ç°RAID 0ï¼ˆæ¡å¸¦åŒ–ï¼‰ï¼Œå°†æ•°æ®åˆ†å¸ƒåˆ°å¤šä¸ªåº•å±‚bdevä¸Šï¼Œæé«˜æ€§èƒ½ã€‚

### ç¬¬ä¸€å±‚åˆ†è§£ï¼šRAID 0éœ€è¦ä»€ä¹ˆï¼Ÿ

**â“ å®ç°RAID 0éœ€è¦ä»€ä¹ˆï¼Ÿ**

1. **å¤šä¸ªåº•å±‚bdev** - RAID 0éœ€è¦å¤šä¸ªåº•å±‚bdev
2. **åœ°å€è½¬æ¢** - å°†RAIDé€»è¾‘åœ°å€è½¬æ¢ä¸ºåº•å±‚bdevç‰©ç†åœ°å€
3. **I/Oåˆ†å‘** - å°†I/Oåˆ†å‘åˆ°å¯¹åº”çš„åº•å±‚bdev
4. **æ¡å¸¦å¤§å°** - å®šä¹‰æ¡å¸¦å¤§å°ï¼Œç”¨äºåœ°å€è½¬æ¢

### ç¬¬äºŒå±‚åˆ†è§£ï¼šåœ°å€è½¬æ¢

**ğŸ¯ æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ** å°†RAIDé€»è¾‘åœ°å€è½¬æ¢ä¸ºåº•å±‚bdevç‰©ç†åœ°å€

**â“ ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ** RAID 0å°†æ•°æ®æ¡å¸¦åŒ–åˆ†å¸ƒåœ¨å¤šä¸ªåº•å±‚bdevä¸Šï¼Œéœ€è¦çŸ¥é“æ¯ä¸ªI/Oåº”è¯¥å»å“ªä¸ªbdevçš„å“ªä¸ªä½ç½®ã€‚

**â“ å®ç°è¿™ä¸ªéœ€è¦ä»€ä¹ˆï¼Ÿ**
- RAID bdevçš„æ¡å¸¦å¤§å° (strip_size)
- åº•å±‚bdevçš„æ•°é‡ (num_base_bdevs)
- å½“å‰I/Oçš„é€»è¾‘åç§» (raid_offset) å’Œé•¿åº¦ (raid_num_blocks)

**âœ… å¦‚ä½•å®ç°ï¼Ÿ**

```c
static void raid0_submit_rw_request(struct raid_bdev_io *raid_io)
{
    struct raid_bdev *raid_bdev = raid_io->raid_bdev;
    uint64_t strip_size = raid_bdev->strip_size;  // æ¡å¸¦å¤§å°ï¼ˆå—ï¼‰
    uint64_t raid_offset = raid_io->offset_blocks;
    uint8_t num_base_bdevs = raid_bdev->num_base_bdevs;
    
    /* ============================================
     * æ­¥éª¤1ï¼šè®¡ç®—I/Oæ‰€åœ¨çš„æ¡å¸¦å’Œç‰©ç†ç£ç›˜
     * ============================================
     */
    uint64_t start_strip_idx = raid_offset / strip_size;  // I/Oèµ·å§‹å—æ‰€åœ¨çš„æ¡å¸¦ç´¢å¼•
    uint64_t offset_in_strip = raid_offset % strip_size;    // I/Oèµ·å§‹å—åœ¨æ¡å¸¦å†…çš„åç§»
    
    uint8_t pd_idx = start_strip_idx % num_base_bdevs;     // å¯¹åº”çš„ç‰©ç†ç£ç›˜ç´¢å¼•
    uint64_t pd_strip_idx = start_strip_idx / num_base_bdevs; // ç‰©ç†ç£ç›˜ä¸Šçš„æ¡å¸¦ç´¢å¼•
    
    uint64_t pd_lba = pd_strip_idx * strip_size + offset_in_strip; // ç‰©ç†ç£ç›˜ä¸Šçš„LBA
    
    /* ============================================
     * æ­¥éª¤2ï¼šè·å–åº•å±‚bdevçš„æè¿°ç¬¦å’Œé€šé“
     * ============================================
     */
    struct raid_base_bdev_info *base_info = &raid_bdev->base_bdev_info[pd_idx];
    struct spdk_io_channel *base_ch = raid_io->raid_ch->base_channel[pd_idx];
    
    /* ============================================
     * æ­¥éª¤3ï¼šæäº¤I/Oåˆ°åº•å±‚bdev
     * ============================================
     */
    if (raid_io->type == SPDK_BDEV_IO_TYPE_READ) {
        spdk_bdev_readv_blocks(base_info->desc, base_ch,
                              raid_io->iovs, raid_io->iovcnt,
                              pd_lba, raid_io->num_blocks,
                              raid0_io_completion, raid_io);
    } else {
        spdk_bdev_writev_blocks(base_info->desc, base_ch,
                               raid_io->iovs, raid_io->iovcnt,
                               pd_lba, raid_io->num_blocks,
                               raid0_io_completion, raid_io);
    }
}
```

### åœ°å€è½¬æ¢ç¤ºä¾‹

**é…ç½®**ï¼š3ä¸ªç£ç›˜ï¼Œæ¡å¸¦å¤§å°=4å—

**ç¤ºä¾‹1**ï¼šRAIDåœ°å€=10å—
```
strip = 10 / 4 = 2
disk_idx = 2 % 3 = 2 (disk2)
disk_strip = 2 / 3 = 0
offset_in_strip = 10 % 4 = 2
disk_offset = 0 * 4 + 2 = 2å—
ç»“æœï¼šdisk2çš„ç¬¬2å—
```

**ç¤ºä¾‹2**ï¼šRAIDåœ°å€=15å—
```
strip = 15 / 4 = 3
disk_idx = 3 % 3 = 0 (disk0)
disk_strip = 3 / 3 = 1
offset_in_strip = 15 % 4 = 3
disk_offset = 1 * 4 + 3 = 7å—
ç»“æœï¼šdisk0çš„ç¬¬7å—
```

### RAID 0æ•°æ®ç»“æ„

```c
/* RAID I/Oä¸Šä¸‹æ–‡ */
struct raid_bdev_io {
    struct spdk_bdev_io *raid_io;      /* åŸå§‹çš„RAID I/Oè¯·æ±‚ */
    struct raid_bdev_io_channel *raid_ch; /* RAIDé€šé“ */
    struct raid_bdev *raid_bdev;       /* RAID bdev */
    enum spdk_bdev_io_type type;       /* I/Oç±»å‹ */
    uint64_t offset_blocks;           /* åœ¨RAIDä¸­çš„åç§»å’Œé•¿åº¦ï¼ˆå—ï¼‰ */
    uint64_t num_blocks;
    struct iovec *iovs;                /* æ•°æ®ç¼“å†²åŒº */
    int iovcnt;
    struct spdk_bdev_io *base_io;      /* å­I/Oè¯·æ±‚ */
    TAILQ_ENTRY(raid_bdev_io) link;
};

/* RAID bdevç»“æ„ */
struct raid_bdev {
    struct spdk_bdev bdev;             /* å¿…é¡»æ”¾åœ¨ç¬¬ä¸€ä¸ªå­—æ®µ */
    uint8_t num_base_bdevs;           /* åº•å±‚bdevæ•°é‡ */
    uint64_t strip_size;               /* æ¡å¸¦å¤§å°ï¼ˆå—ï¼‰ */
    struct raid_base_bdev_info *base_bdev_info; /* åº•å±‚bdevä¿¡æ¯æ•°ç»„ */
    TAILQ_ENTRY(raid_bdev) tailq;
};

/* RAID I/Oé€šé“ */
struct raid_bdev_io_channel {
    struct spdk_io_channel **base_channel; /* åº•å±‚bdevçš„I/Oé€šé“æ•°ç»„ */
};
```

### å®Œæ•´å®ç°å‚è€ƒ

å‚è€ƒ `bdev_raid0_example.c` æ–‡ä»¶ï¼ŒåŒ…å«ï¼š
- RAID 0çš„å®Œæ•´æ•°æ®ç»“æ„å®šä¹‰
- åœ°å€è½¬æ¢å‡½æ•°å®ç°
- I/Oæäº¤åˆ°åº•å±‚bdevçš„é€»è¾‘
- åˆ›å»ºå’Œé”€æ¯å‡½æ•°

---

### æ•°æ®æµè½¬è¯¦è§£ï¼šRAID 0æ¨¡å—

**ğŸ¯ æˆ‘è¦ç†è§£ä»€ä¹ˆï¼Ÿ** ä¸€ä»½æ•°æ®ä»ç”¨æˆ·åº”ç”¨å‘å‡ºï¼Œç»è¿‡RAID 0æ¨¡å—ï¼Œæœ€ç»ˆå†™å…¥åˆ°åº•å±‚bdevï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸­æ•°æ®æ˜¯å¦‚ä½•æµè½¬çš„ã€‚

#### å†™å…¥æ•°æ®æµè½¬ï¼ˆWriteï¼‰

**åœºæ™¯**ï¼šç”¨æˆ·åº”ç”¨å†™å…¥8192å­—èŠ‚æ•°æ®åˆ°RAID 0 bdevçš„ç¬¬100å—ï¼ˆå‡è®¾æ¡å¸¦å¤§å°=4å—ï¼Œ3ä¸ªåº•å±‚bdevï¼‰

**å®Œæ•´æµç¨‹**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ1ï¼šç”¨æˆ·åº”ç”¨å‘èµ·å†™å…¥è¯·æ±‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ç”¨æˆ·åº”ç”¨è°ƒç”¨ï¼š
  spdk_bdev_write(raid_desc, ch, buffer, offset=100, length=8192, cb, cb_arg)
  â†“
SPDKæ¡†æ¶å±‚ï¼š
  - åˆ›å»º spdk_bdev_io ç»“æ„
  - è®¾ç½® bdev_io->type = SPDK_BDEV_IO_TYPE_WRITE
  - è®¾ç½® bdev_io->u.bdev.offset_blocks = 100
  - è®¾ç½® bdev_io->u.bdev.num_blocks = 16ï¼ˆå‡è®¾blocklen=512ï¼‰
  - è®¾ç½® bdev_io->u.bdev.iovs[0].iov_base = bufferï¼ˆç”¨æˆ·æ•°æ®ï¼‰
  - è®¾ç½® bdev_io->u.bdev.iovs[0].iov_len = 8192
  â†“
è°ƒç”¨ raid_bdev->fn_table->submit_request(ch, bdev_io)
  â†“
è¿›å…¥RAID 0æ¨¡å—ï¼šraid0_submit_request()

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ2ï¼šRAID 0æ¨¡å—æ¥æ”¶I/Oè¯·æ±‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
raid0_submit_request(struct spdk_io_channel *_ch, 
                    struct spdk_bdev_io *bdev_io)
  â†“
1. è·å–RAID I/Oä¸Šä¸‹æ–‡ï¼š
   struct raid_bdev_io *raid_io = (struct raid_bdev_io *)bdev_io->driver_ctx;
   â†“
2. å¡«å……RAID I/Oä¿¡æ¯ï¼š
   raid_io->raid_io = bdev_io;              // ä¿å­˜åŸå§‹I/Oå¼•ç”¨
   raid_io->offset_blocks = 100;            // RAIDé€»è¾‘åç§»
   raid_io->num_blocks = 16;                // å—æ•°é‡
   raid_io->iovs = bdev_io->u.bdev.iovs;    // æ•°æ®ç¼“å†²åŒºï¼ˆæŒ‡å‘ç”¨æˆ·bufferï¼‰
   raid_io->iovcnt = bdev_io->u.bdev.iovcnt;
   â†“
3. è°ƒç”¨åœ°å€è½¬æ¢å’ŒI/Oæäº¤ï¼š
   raid0_submit_rw_request(raid_io)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ3ï¼šåœ°å€è½¬æ¢å’Œæ•°æ®åˆ†å‘                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
raid0_submit_rw_request(struct raid_bdev_io *raid_io)
  â†“
1. è®¡ç®—åœ°å€è½¬æ¢ï¼š
   offset = 100å—
   strip_size = 4å—
   num_base_bdevs = 3
   â†“
   è®¡ç®—ï¼š
   start_strip_idx = 100 / 4 = 25
   offset_in_strip = 100 % 4 = 0
   pd_idx = 25 % 3 = 1ï¼ˆæ•°æ®åœ¨ç¬¬1ä¸ªåº•å±‚bdevï¼‰
   pd_strip_idx = 25 / 3 = 8
   pd_lba = 8 * 4 + 0 = 32å—
   â†“
   ç»“æœï¼šæ•°æ®åº”è¯¥å†™å…¥ base_bdev[1] çš„ç¬¬32å—
   â†“
2. è·å–åº•å±‚bdevä¿¡æ¯ï¼š
   struct raid_base_bdev_info *base_info = &raid_bdev->base_bdev_info[1];
   struct spdk_io_channel *base_ch = raid_ch->base_channel[1];
   â†“
3. å…³é”®ç‚¹ï¼šæ•°æ®ä»ç„¶åœ¨ç”¨æˆ·æä¾›çš„bufferä¸­ï¼ŒRAID 0æ¨¡å—ä¸å¤åˆ¶æ•°æ®
   â†“
4. æäº¤I/Oåˆ°åº•å±‚bdevï¼š
   spdk_bdev_writev_blocks(base_info->desc, base_ch,
                          raid_io->iovs,      // ç›´æ¥ä½¿ç”¨ç”¨æˆ·çš„iovs
                          raid_io->iovcnt,
                          pd_lba=32,         // è½¬æ¢åçš„ç‰©ç†åœ°å€
                          raid_io->num_blocks=16,
                          raid0_io_completion,  // å®Œæˆå›è°ƒ
                          raid_io);            // å›è°ƒå‚æ•°

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ4ï¼šåº•å±‚bdevå¤„ç†I/O                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
åº•å±‚bdevï¼ˆä¾‹å¦‚NVMe bdevï¼‰æ¥æ”¶I/Oï¼š
  â†“
1. åº•å±‚bdevä»ç”¨æˆ·bufferè¯»å–æ•°æ®
   â†“
2. é€šè¿‡NVMeåè®®å†™å…¥ç‰©ç†ç£ç›˜
   â†“
3. å†™å…¥å®Œæˆåè°ƒç”¨å®Œæˆå›è°ƒï¼š
   raid0_io_completion(bdev_io, success, raid_io)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ5ï¼šI/Oå®Œæˆå›è°ƒé“¾                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
raid0_io_completion(struct spdk_bdev_io *bdev_io, bool success, void *cb_arg)
  â†“
1. è·å–RAID I/Oä¸Šä¸‹æ–‡ï¼š
   struct raid_bdev_io *raid_io = cb_arg;
   â†“
2. é‡Šæ”¾åº•å±‚bdevçš„I/Oï¼š
   spdk_bdev_free_io(bdev_io);
   â†“
3. å®ŒæˆRAID I/Oï¼š
   spdk_bdev_io_complete(raid_io->raid_io, 
                        success ? SPDK_BDEV_IO_STATUS_SUCCESS 
                                : SPDK_BDEV_IO_STATUS_FAILED);
   â†“
4. SPDKæ¡†æ¶è°ƒç”¨ç”¨æˆ·å›è°ƒï¼š
   cb(raid_io->raid_io, success, user_cb_arg)
   â†“
5. ç”¨æˆ·åº”ç”¨æ”¶åˆ°å†™å…¥å®Œæˆé€šçŸ¥

**å…³é”®ç‚¹æ€»ç»“**ï¼š
- æ•°æ®é›¶æ‹·è´ï¼šæ•°æ®å§‹ç»ˆåœ¨ç”¨æˆ·bufferä¸­ï¼ŒRAID 0æ¨¡å—ä¸å¤åˆ¶æ•°æ®
- åœ°å€è½¬æ¢ï¼šRAIDé€»è¾‘åœ°å€è½¬æ¢ä¸ºåº•å±‚bdevç‰©ç†åœ°å€
- å¼‚æ­¥å¤„ç†ï¼šI/Oæäº¤åˆ°åº•å±‚bdevåç«‹å³è¿”å›ï¼Œç­‰å¾…å®Œæˆå›è°ƒ
- å›è°ƒé“¾ï¼šåº•å±‚bdevå®Œæˆ â†’ RAIDæ¨¡å—å®Œæˆ â†’ ç”¨æˆ·åº”ç”¨å›è°ƒ
```

#### è¯»å–æ•°æ®æµè½¬ï¼ˆReadï¼‰

**åœºæ™¯**ï¼šç”¨æˆ·åº”ç”¨ä»RAID 0 bdevçš„ç¬¬100å—è¯»å–8192å­—èŠ‚æ•°æ®

**å®Œæ•´æµç¨‹**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ1ï¼šç”¨æˆ·åº”ç”¨å‘èµ·è¯»å–è¯·æ±‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ç”¨æˆ·åº”ç”¨è°ƒç”¨ï¼š
  spdk_bdev_read(raid_desc, ch, buffer, offset=100, length=8192, cb, cb_arg)
  â†“
SPDKæ¡†æ¶å±‚åˆ›å»º spdk_bdev_ioï¼Œè®¾ç½®ç”¨æˆ·buffer
  â†“
è¿›å…¥RAID 0æ¨¡å—ï¼šraid0_submit_request()

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ2ï¼šRAID 0æ¨¡å—åœ°å€è½¬æ¢                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
raid0_submit_rw_request()ï¼š
  â†“
1. åœ°å€è½¬æ¢ï¼ˆåŒå†™å…¥æµç¨‹ï¼‰ï¼š
   è®¡ç®—å¾—åˆ°ï¼šä» base_bdev[1] çš„ç¬¬32å—è¯»å–
   â†“
2. æäº¤è¯»å–I/Oåˆ°åº•å±‚bdevï¼š
   spdk_bdev_readv_blocks(base_info->desc, base_ch,
                         raid_io->iovs,      // ç”¨æˆ·çš„buffer
                         raid_io->iovcnt,
                         pd_lba=32,
                         num_blocks=16,
                         raid0_io_completion,
                         raid_io);

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ3ï¼šåº•å±‚bdevè¯»å–æ•°æ®                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
åº•å±‚bdevï¼ˆä¾‹å¦‚NVMe bdevï¼‰ï¼š
  â†“
1. ä»ç‰©ç†ç£ç›˜è¯»å–æ•°æ®
   â†“
2. æ•°æ®ç›´æ¥å†™å…¥ç”¨æˆ·æä¾›çš„bufferï¼ˆé›¶æ‹·è´ï¼‰
   â†“
3. è¯»å–å®Œæˆåè°ƒç”¨å›è°ƒï¼š
   raid0_io_completion(bdev_io, success, raid_io)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ4ï¼šæ•°æ®è¿”å›ç”¨æˆ·åº”ç”¨                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
raid0_io_completion()ï¼š
  â†“
1. é‡Šæ”¾åº•å±‚bdev I/O
   â†“
2. å®ŒæˆRAID I/O
   â†“
3. è°ƒç”¨ç”¨æˆ·å›è°ƒ
   â†“
4. ç”¨æˆ·åº”ç”¨çš„bufferä¸­ç°åœ¨æœ‰æ•°æ®ï¼ˆä»åº•å±‚bdevè¯»å–çš„æ•°æ®ï¼‰

**å…³é”®ç‚¹æ€»ç»“**ï¼š
- æ•°æ®ç›´æ¥å†™å…¥ç”¨æˆ·bufferï¼Œä¸éœ€è¦ä¸­é—´ç¼“å†²åŒº
- åœ°å€è½¬æ¢ç¡®ä¿ä»æ­£ç¡®çš„åº•å±‚bdevè¯»å–
- å¼‚æ­¥å›è°ƒé“¾ç¡®ä¿æ•°æ®è¯»å–å®Œæˆåé€šçŸ¥ç”¨æˆ·
```

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šECï¼ˆçº åˆ ç ï¼‰å®ç°ç¤ºä¾‹

### ğŸ¯ é¡¶å±‚ç›®æ ‡

**æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ**

å®ç°ECï¼ˆçº åˆ ç ï¼‰ï¼Œå°†kä¸ªæ•°æ®å—ç¼–ç æˆpä¸ªæ ¡éªŒå—ï¼Œå¯ä»¥å®¹å¿pä¸ªå—æ•…éšœã€‚

### ç¬¬ä¸€å±‚åˆ†è§£ï¼šECéœ€è¦ä»€ä¹ˆï¼Ÿ

**â“ å®ç°ECéœ€è¦ä»€ä¹ˆï¼Ÿ**

1. **ISA-Låº“** - ç”¨äºé«˜æ€§èƒ½ç¼–ç /è§£ç 
2. **ç¼–ç è¡¨** - é¢„è®¡ç®—çš„ç¼–ç çŸ©é˜µè¡¨
3. **æ¡å¸¦ç®¡ç†** - ç®¡ç†æ•°æ®æ¡å¸¦å’Œæ ¡éªŒæ¡å¸¦
4. **æ•…éšœæ¢å¤** - å½“å—æ•…éšœæ—¶ï¼Œä»å…¶ä»–å—æ¢å¤æ•°æ®
5. **RMWè·¯å¾„** - å¤„ç†éƒ¨åˆ†æ¡å¸¦å†™å…¥

### ç¬¬äºŒå±‚åˆ†è§£ï¼šISA-Lé›†æˆ

#### æ­¥éª¤1ï¼šåˆå§‹åŒ–ISA-Lç¼–ç è¡¨

**ğŸ¯ æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ** åˆå§‹åŒ–ISA-Lç¼–ç è¡¨ï¼Œç”¨äºåç»­çš„ç¼–ç æ“ä½œ

**â“ ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ** ISA-Lä½¿ç”¨é¢„è®¡ç®—çš„ç¼–ç è¡¨æ¥åŠ é€Ÿç¼–ç ï¼Œé¿å…æ¯æ¬¡ç¼–ç éƒ½é‡æ–°è®¡ç®—çŸ©é˜µã€‚

**â“ å®ç°è¿™ä¸ªéœ€è¦ä»€ä¹ˆï¼Ÿ**
- ISA-Låº“å¤´æ–‡ä»¶ (`<isa-l/erasure_code.h>`)
- ç¼–ç çŸ©é˜µå†…å­˜
- ç¼–ç è¡¨å†…å­˜ï¼ˆ64å­—èŠ‚å¯¹é½ï¼‰

**âœ… å¦‚ä½•å®ç°ï¼Ÿ**

```c
#include <isa-l/erasure_code.h>

int ec_bdev_init_tables(struct ec_bdev *ec_bdev, uint8_t k, uint8_t p)
{
    struct ec_bdev_module_private *mp = ec_bdev->module_private;
    uint8_t m = k + p;  // æ€»å—æ•°
    int matrix_size = k * m;
    int g_tbls_size = 32 * k * p;  // ç¼–ç è¡¨å¤§å°ï¼š32å­—èŠ‚ Ã— k Ã— p
    
    /* æ­¥éª¤1ï¼šåˆ†é…ç¼–ç çŸ©é˜µå†…å­˜ */
    mp->encode_matrix = malloc(matrix_size);
    if (mp->encode_matrix == NULL) {
        return -ENOMEM;
    }
    
    /* æ­¥éª¤2ï¼šç”ŸæˆCauchyçŸ©é˜µç”¨äºç¼–ç  */
    /* CauchyçŸ©é˜µæ˜¯ä¸€ç§ç‰¹æ®Šçš„ç¼–ç çŸ©é˜µï¼Œé€‚åˆçº åˆ ç  */
    gf_gen_cauchy1_matrix(mp->encode_matrix, m, k);
    
    /* æ­¥éª¤3ï¼šåˆ†é…ç¼–ç è¡¨å†…å­˜ï¼ˆ64å­—èŠ‚å¯¹é½ï¼ŒISA-Lè¦æ±‚ï¼‰ */
    mp->g_tbls = spdk_dma_malloc(g_tbls_size, 64, NULL);
    if (mp->g_tbls == NULL) {
        free(mp->encode_matrix);
        return -ENOMEM;
    }
    
    /* æ­¥éª¤4ï¼šåˆå§‹åŒ–ç¼–ç è¡¨ï¼ˆé¢„è®¡ç®—ï¼‰ */
    /* è¿™ä¸€æ­¥å°†ç¼–ç çŸ©é˜µè½¬æ¢ä¸ºæŸ¥æ‰¾è¡¨ï¼ŒåŠ é€Ÿåç»­ç¼–ç  */
    ec_init_tables(k, p, &mp->encode_matrix[0], mp->g_tbls);
    
    return 0;
}
```

**ç¼–ç è¡¨ä½œç”¨**ï¼š
- **é¢„è®¡ç®—**ï¼šå°†ç¼–ç çŸ©é˜µé¢„è®¡ç®—æˆæŸ¥æ‰¾è¡¨
- **åŠ é€Ÿ**ï¼šç¼–ç æ—¶ç›´æ¥æŸ¥è¡¨ï¼Œé¿å…é‡å¤è®¡ç®—
- **å¤§å°**ï¼š32å­—èŠ‚ Ã— k Ã— p
- **å¯¹é½**ï¼šå¿…é¡»64å­—èŠ‚å¯¹é½ï¼ŒISA-Lä½¿ç”¨SIMDæŒ‡ä»¤éœ€è¦å¯¹é½

#### æ­¥éª¤2ï¼šISA-Lç¼–ç å®ç°

**ğŸ¯ æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ** ä½¿ç”¨ISA-Lå°†kä¸ªæ•°æ®å—ç¼–ç æˆpä¸ªæ ¡éªŒå—

**â“ ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ** ISA-Lä½¿ç”¨SIMDæŒ‡ä»¤åŠ é€ŸGaloisåŸŸè¿ç®—ï¼Œæ€§èƒ½æ¯”è½¯ä»¶å®ç°é«˜2-4å€ã€‚

**â“ å®ç°è¿™ä¸ªéœ€è¦ä»€ä¹ˆï¼Ÿ**
- kä¸ªæ•°æ®å—æŒ‡é’ˆ
- pä¸ªæ ¡éªŒå—æŒ‡é’ˆï¼ˆå·²åˆ†é…å†…å­˜ï¼‰
- ç¼–ç è¡¨ï¼ˆg_tblsï¼‰
- å—é•¿åº¦ï¼ˆå­—èŠ‚ï¼‰

**âœ… å¦‚ä½•å®ç°ï¼Ÿ**

```c
int ec_encode_stripe(struct ec_bdev *ec_bdev, 
                     unsigned char **data_ptrs,    // kä¸ªæ•°æ®å—æŒ‡é’ˆ
                     unsigned char **parity_ptrs, // pä¸ªæ ¡éªŒå—æŒ‡é’ˆ
                     size_t len)                   // æ¯ä¸ªå—çš„é•¿åº¦ï¼ˆå­—èŠ‚ï¼‰
{
    struct ec_bdev_module_private *mp = ec_bdev->module_private;
    uint8_t k = ec_bdev->k;
    uint8_t p = ec_bdev->p;
    
    /* æ­¥éª¤1ï¼šéªŒè¯è¾“å…¥å‚æ•° */
    if (data_ptrs == NULL || parity_ptrs == NULL) {
        return -EINVAL;
    }
    
    /* æ­¥éª¤2ï¼šéªŒè¯æ‰€æœ‰æŒ‡é’ˆéNULL */
    for (uint8_t i = 0; i < k; i++) {
        if (data_ptrs[i] == NULL) {
            return -EINVAL;
        }
    }
    for (uint8_t i = 0; i < p; i++) {
        if (parity_ptrs[i] == NULL) {
            return -EINVAL;
        }
    }
    
    /* æ­¥éª¤3ï¼šé¢„å–ä¼˜åŒ–ï¼ˆå¯é€‰ï¼Œæå‡æ€§èƒ½ï¼‰ */
    /* é¢„å–ç¼–ç è¡¨åˆ°CPUç¼“å­˜ */
    EC_PREFETCH(mp->g_tbls, 0);
    
    /* é¢„å–æ•°æ®å—åˆ°CPUç¼“å­˜ */
    for (uint8_t i = 0; i < k; i++) {
        EC_PREFETCH(data_ptrs[i], 0);
    }
    
    /* é¢„å–æ ¡éªŒå—åˆ°CPUç¼“å­˜ï¼ˆå†™æç¤ºï¼‰ */
    for (uint8_t i = 0; i < p; i++) {
        EC_PREFETCH(parity_ptrs[i], 1);  // 1è¡¨ç¤ºå†™æç¤º
    }
    
    /* æ­¥éª¤4ï¼šè°ƒç”¨ISA-Lç¼–ç å‡½æ•° */
    /* è¿™æ˜¯ISA-Lçš„æ ¸å¿ƒå‡½æ•°ï¼Œä½¿ç”¨SIMDæŒ‡ä»¤åŠ é€Ÿç¼–ç  */
    ec_encode_data(len, k, p, mp->g_tbls, data_ptrs, parity_ptrs);
    
    return 0;
}
```

**ISA-Lç¼–ç åŸç†**ï¼ˆç®€åŒ–ï¼‰ï¼š
1. **GaloisåŸŸè¿ç®—**ï¼šåœ¨GF(2^8)åŸŸä¸Šè¿›è¡Œè¿ç®—
2. **çŸ©é˜µä¹˜æ³•**ï¼šä½¿ç”¨ç¼–ç çŸ©é˜µå°†kä¸ªæ•°æ®å—ç¼–ç æˆpä¸ªæ ¡éªŒå—
3. **SIMDåŠ é€Ÿ**ï¼šä½¿ç”¨SSE/AVXæŒ‡ä»¤å¹¶è¡Œè®¡ç®—å¤šä¸ªå­—èŠ‚

#### æ­¥éª¤3ï¼šECåœ°å€è½¬æ¢

**ğŸ¯ æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ** å°†ECé€»è¾‘åœ°å€è½¬æ¢ä¸ºåº•å±‚bdevç‰©ç†åœ°å€ï¼Œå¹¶ç¡®å®šæ•°æ®å—å’Œæ ¡éªŒå—çš„ä½ç½®

**â“ ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ** ECå°†æ•°æ®æ¡å¸¦åŒ–åˆ†å¸ƒåœ¨k+pä¸ªåº•å±‚bdevä¸Šï¼Œæ¯ä¸ªæ¡å¸¦åŒ…å«kä¸ªæ•°æ®stripå’Œpä¸ªæ ¡éªŒstripã€‚éœ€è¦çŸ¥é“ï¼š
1. I/Oè¯·æ±‚å¯¹åº”çš„æ¡å¸¦ç´¢å¼•
2. æ¡å¸¦å†…çš„stripç´¢å¼•
3. æ¯ä¸ªstripå¯¹åº”çš„åº•å±‚bdevç´¢å¼•
4. åº•å±‚bdevä¸Šçš„ç‰©ç†åç§»

**â“ å®ç°è¿™ä¸ªéœ€è¦ä»€ä¹ˆï¼Ÿ**
- EC bdevçš„æ¡å¸¦å¤§å° (strip_size)
- æ•°æ®å—æ•°é‡ (k) å’Œæ ¡éªŒå—æ•°é‡ (p)
- å½“å‰I/Oçš„é€»è¾‘åç§» (offset_blocks) å’Œé•¿åº¦ (num_blocks)

**âœ… å¦‚ä½•å®ç°ï¼Ÿ**

```c
void ec_submit_rw_request(struct ec_bdev_io *ec_io)
{
    struct ec_bdev *ec_bdev = ec_io->ec_bdev;
    uint8_t k = ec_bdev->k;
    uint8_t p = ec_bdev->p;
    uint32_t strip_size = ec_bdev->strip_size;
    uint32_t strip_size_shift = ec_bdev->strip_size_shift;
    
    /* ============================================
     * æ­¥éª¤1ï¼šè®¡ç®—stripç´¢å¼•å’Œæ¡å¸¦ç´¢å¼•
     * ============================================
     * ğŸ¯ æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ
     *   å°†ECé€»è¾‘åœ°å€è½¬æ¢ä¸ºstripç´¢å¼•å’Œæ¡å¸¦ç´¢å¼•
     * â“ ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªï¼Ÿ
     *   ECå°†æ•°æ®ç»„ç»‡æˆæ¡å¸¦ï¼Œæ¯ä¸ªæ¡å¸¦åŒ…å«kä¸ªæ•°æ®stripã€‚
     *   éœ€è¦çŸ¥é“I/Oè¯·æ±‚å±äºå“ªä¸ªæ¡å¸¦çš„å“ªä¸ªstripã€‚
     * âœ… å¦‚ä½•å®ç°ï¼Ÿ
     */
    uint64_t start_strip = ec_io->offset_blocks >> strip_size_shift;  // stripç´¢å¼•
    uint64_t end_strip = (ec_io->offset_blocks + ec_io->num_blocks - 1) >> strip_size_shift;
    
    /* æ£€æŸ¥I/Oæ˜¯å¦è·¨è¶Šstripè¾¹ç•Œï¼ˆECä¸æ”¯æŒï¼‰ */
    if (start_strip != end_strip && ec_bdev->num_base_bdevs > 1) {
        SPDK_ERRLOG("I/O spans strip boundary\n");
        ec_bdev_io_complete(ec_io, SPDK_BDEV_IO_STATUS_FAILED);
        return;
    }
    
    uint64_t stripe_index = start_strip / k;              // æ¡å¸¦ç´¢å¼•
    uint8_t strip_idx_in_stripe = start_strip % k;        // æ¡å¸¦å†…çš„stripç´¢å¼•ï¼ˆ0åˆ°k-1ï¼‰
    uint32_t offset_in_strip = ec_io->offset_blocks & (strip_size - 1);  // stripå†…çš„åç§»
    
    /* ============================================
     * æ­¥éª¤2ï¼šé€‰æ‹©æ•°æ®å—å’Œæ ¡éªŒå—çš„åº•å±‚bdevç´¢å¼•
     * ============================================
     * ğŸ¯ æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ
     *   æ ¹æ®æ¡å¸¦ç´¢å¼•ï¼Œç¡®å®škä¸ªæ•°æ®å—å’Œpä¸ªæ ¡éªŒå—å¯¹åº”çš„åº•å±‚bdevç´¢å¼•
     * â“ ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªï¼Ÿ
     *   ECä½¿ç”¨round-robinæ–¹å¼åˆ†å¸ƒæ ¡éªŒå—ï¼Œç¡®ä¿è´Ÿè½½å‡è¡¡ã€‚
     *   ä¸åŒæ¡å¸¦çš„æ ¡éªŒå—ä½ç½®ä¸åŒã€‚
     * âœ… å¦‚ä½•å®ç°ï¼Ÿ
     */
    uint8_t data_indices[EC_MAX_K];
    uint8_t parity_indices[EC_MAX_P];
    
    /* è°ƒç”¨é€‰æ‹©å‡½æ•°ï¼ˆé»˜è®¤å®ç°ä½¿ç”¨round-robinï¼‰ */
    int rc = ec_select_base_bdevs_default(ec_bdev, stripe_index, 
                                          data_indices, parity_indices);
    if (rc != 0) {
        SPDK_ERRLOG("Failed to select base bdevs\n");
        ec_bdev_io_complete(ec_io, SPDK_BDEV_IO_STATUS_FAILED);
        return;
    }
    
    /* ============================================
     * æ­¥éª¤3ï¼šè®¡ç®—åº•å±‚bdevçš„ç‰©ç†åç§»
     * ============================================
     * ğŸ¯ æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ
     *   è®¡ç®—æ¯ä¸ªåº•å±‚bdevä¸Šçš„ç‰©ç†åç§»ï¼ˆLBAï¼‰
     * â“ ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªï¼Ÿ
     *   éœ€è¦çŸ¥é“æ•°æ®åœ¨åº•å±‚bdevä¸Šçš„å…·ä½“ä½ç½®ï¼Œæ‰èƒ½æäº¤I/Oã€‚
     * âœ… å¦‚ä½•å®ç°ï¼Ÿ
     */
    uint64_t strip_index_on_bdev = stripe_index * k + strip_idx_in_stripe;
    uint64_t base_bdev_offset = strip_index_on_bdev * strip_size + offset_in_strip;
    
    /* ============================================
     * æ­¥éª¤4ï¼šæ ¹æ®I/Oç±»å‹å¤„ç†
     * ============================================
     */
    if (ec_io->type == SPDK_BDEV_IO_TYPE_READ) {
        /* è¯»å–ï¼šä»å¯¹åº”çš„æ•°æ®å—è¯»å– */
        uint8_t target_data_idx = data_indices[strip_idx_in_stripe];
        struct ec_base_bdev_info *base_info = &ec_bdev->base_bdev_info[target_data_idx];
        
        spdk_bdev_readv_blocks(base_info->desc, base_ch[target_data_idx],
                              ec_io->iovs, ec_io->iovcnt,
                              base_bdev_offset, ec_io->num_blocks,
                              ec_base_bdev_io_complete, ec_io);
    } else {
        /* å†™å…¥ï¼šæ ¹æ®æ˜¯å¦å…¨æ¡å¸¦å†™å…¥é€‰æ‹©è·¯å¾„ */
        if ((start_strip % k) == 0 && offset_in_strip == 0 && 
            ec_io->num_blocks == strip_size) {
            /* å…¨æ¡å¸¦å†™å…¥ */
            ec_submit_write_stripe(ec_io, stripe_index, data_indices, parity_indices);
        } else {
            /* éƒ¨åˆ†æ¡å¸¦å†™å…¥ï¼ˆRMWè·¯å¾„ï¼‰ */
            ec_submit_write_partial_stripe(ec_io, stripe_index, 
                                          strip_idx_in_stripe, offset_in_strip,
                                          data_indices, parity_indices);
        }
    }
}
```

**ECåœ°å€è½¬æ¢ç¤ºä¾‹**ï¼š

**é…ç½®**ï¼šk=4ï¼ˆ4ä¸ªæ•°æ®å—ï¼‰ï¼Œp=2ï¼ˆ2ä¸ªæ ¡éªŒå—ï¼‰ï¼Œstrip_size=8å—

**ç¤ºä¾‹1**ï¼šECåœ°å€=32å—ï¼ˆè¯»å–ï¼‰
```
start_strip = 32 >> 3 = 4
stripe_index = 4 / 4 = 1
strip_idx_in_stripe = 4 % 4 = 0
offset_in_strip = 32 & 7 = 0

é€‰æ‹©æ•°æ®å—å’Œæ ¡éªŒå—ï¼ˆstripe_index=1ï¼‰ï¼š
  parity_start = (6 - (1 % 6)) % 6 = 5
  æ•°æ®å—ï¼šbdev[0], bdev[1], bdev[2], bdev[3]
  æ ¡éªŒå—ï¼šbdev[5], bdev[0]  (wrap around)

target_data_idx = data_indices[0] = 0
strip_index_on_bdev = 1 * 4 + 0 = 4
base_bdev_offset = 4 * 8 + 0 = 32å—

ç»“æœï¼šä»bdev[0]çš„ç¬¬32å—è¯»å–
```

**ç¤ºä¾‹2**ï¼šECåœ°å€=50å—ï¼ˆè¯»å–ï¼‰
```
start_strip = 50 >> 3 = 6
stripe_index = 6 / 4 = 1
strip_idx_in_stripe = 6 % 4 = 2
offset_in_strip = 50 & 7 = 2

target_data_idx = data_indices[2] = 2
strip_index_on_bdev = 1 * 4 + 2 = 6
base_bdev_offset = 6 * 8 + 2 = 50å—

ç»“æœï¼šä»bdev[2]çš„ç¬¬50å—è¯»å–
```

**æ ¡éªŒå—åˆ†å¸ƒè¯´æ˜**ï¼š

ECä½¿ç”¨round-robinæ–¹å¼åˆ†å¸ƒæ ¡éªŒå—ï¼Œç¡®ä¿è´Ÿè½½å‡è¡¡ï¼š

```c
int ec_select_base_bdevs_default(struct ec_bdev *ec_bdev, uint64_t stripe_index,
                                 uint8_t *data_indices, uint8_t *parity_indices)
{
    uint8_t n = ec_bdev->num_base_bdevs;  // n = k + p
    uint8_t parity_start;
    
    /* è®¡ç®—æ ¡éªŒå—èµ·å§‹ä½ç½® */
    /* å¯¹äºstripe_index iï¼Œæ ¡éªŒå—èµ·å§‹ä½ç½®ï¼šparity_start = (n - (i % n)) % n */
    parity_start = (n - (stripe_index % n)) % n;
    
    /* é€‰æ‹©æ•°æ®å—å’Œæ ¡éªŒå— */
    uint8_t data_idx = 0;
    uint8_t parity_idx = 0;
    
    for (uint8_t i = 0; i < n; i++) {
        bool is_parity_pos = false;
        /* æ£€æŸ¥ä½ç½®iæ˜¯å¦æ˜¯æ ¡éªŒå—ä½ç½® */
        for (uint8_t p_idx = 0; p_idx < ec_bdev->p; p_idx++) {
            if (i == (parity_start + p_idx) % n) {
                is_parity_pos = true;
                break;
            }
        }
        
        if (is_parity_pos && parity_idx < ec_bdev->p) {
            parity_indices[parity_idx++] = i;
        } else if (!is_parity_pos && data_idx < ec_bdev->k) {
            data_indices[data_idx++] = i;
        }
    }
    
    return 0;
}
```

**æ ¡éªŒå—åˆ†å¸ƒç¤ºä¾‹**ï¼ˆk=4, p=2, n=6ï¼‰ï¼š

| stripe_index | parity_start | æ•°æ®å—ä½ç½® | æ ¡éªŒå—ä½ç½® |
|--------------|--------------|------------|------------|
| 0 | 0 | bdev[1,2,3,4] | bdev[0,5] |
| 1 | 5 | bdev[0,1,2,3] | bdev[5,4] |
| 2 | 4 | bdev[5,0,1,2] | bdev[4,3] |
| 3 | 3 | bdev[4,5,0,1] | bdev[3,2] |

### ç¬¬ä¸‰å±‚åˆ†è§£ï¼šå®Œæ•´å†™å…¥æµç¨‹

#### å…¨æ¡å¸¦å†™å…¥

**ğŸ¯ æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ** å†™å…¥å®Œæ•´çš„æ¡å¸¦ï¼ˆkä¸ªæ•°æ®å—ï¼‰

**æµç¨‹**ï¼š
1. å‡†å¤‡æ•°æ®æŒ‡é’ˆï¼ˆå¤„ç†è·¨iovæ•°æ®ï¼‰
2. åˆ†é…æ ¡éªŒç¼“å†²åŒº
3. ISA-Lç¼–ç ç”Ÿæˆæ ¡éªŒå—
4. å¹¶è¡Œå†™å…¥k+pä¸ªåº•å±‚bdev

**âœ… å¦‚ä½•å®ç°ï¼Ÿ**

```c
void ec_submit_write_stripe(struct ec_bdev_io *ec_io)
{
    struct ec_bdev *ec_bdev = ec_io->ec_bdev;
    uint8_t k = ec_bdev->k;
    uint8_t p = ec_bdev->p;
    
    /* æ­¥éª¤1ï¼šå‡†å¤‡æ•°æ®æŒ‡é’ˆ */
    unsigned char *data_ptrs[EC_MAX_K];
    /* å¤„ç†iovsï¼Œç¡®ä¿æ¯ä¸ªæ•°æ®å—æœ‰è¿ç»­å†…å­˜ */
    /* å¦‚æœæ•°æ®è·¨å¤šä¸ªiovï¼Œéœ€è¦å¤åˆ¶åˆ°ä¸´æ—¶ç¼“å†²åŒº */
    
    /* æ­¥éª¤2ï¼šåˆ†é…æ ¡éªŒç¼“å†²åŒº */
    unsigned char *parity_ptrs[EC_MAX_P];
    for (uint8_t i = 0; i < p; i++) {
        parity_ptrs[i] = ec_get_parity_buf(ec_io->ec_ch);
    }
    
    /* æ­¥éª¤3ï¼šISA-Lç¼–ç  */
    size_t len = ec_bdev->strip_size * ec_bdev->bdev.blocklen;
    ec_encode_stripe(ec_bdev, data_ptrs, parity_ptrs, len);
    
    /* æ­¥éª¤4ï¼šå¹¶è¡Œå†™å…¥k+pä¸ªåº•å±‚bdev */
    for (uint8_t i = 0; i < k; i++) {
        spdk_bdev_writev_blocks(base_info[i]->desc, base_ch[i],
                                data_iovs[i], data_iovcnt[i],
                                offset, num_blocks,
                                ec_base_bdev_io_complete, ec_io);
    }
    for (uint8_t i = 0; i < p; i++) {
        spdk_bdev_writev_blocks(parity_info[i]->desc, parity_ch[i],
                                &parity_iov[i], 1,
                                parity_offset, num_blocks,
                                ec_base_bdev_io_complete, ec_io);
    }
}
```

#### RMWï¼ˆRead-Modify-Writeï¼‰è·¯å¾„

**ğŸ¯ æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ** å¤„ç†éƒ¨åˆ†æ¡å¸¦å†™å…¥ï¼ˆåªå†™å…¥æ¡å¸¦çš„ä¸€éƒ¨åˆ†ï¼‰

**â“ ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ** å¦‚æœåªå†™å…¥æ¡å¸¦çš„ä¸€éƒ¨åˆ†ï¼Œéœ€è¦ï¼š
1. è¯»å–æ•´ä¸ªæ¡å¸¦ï¼ˆkä¸ªæ•°æ®å—ï¼‰
2. æ›´æ–°è¦å†™å…¥çš„æ•°æ®å—
3. é‡æ–°ç¼–ç ç”Ÿæˆæ–°çš„æ ¡éªŒå—
4. å†™å…¥æ›´æ–°çš„æ•°æ®å—å’Œæ ¡éªŒå—

**æµç¨‹**ï¼š
1. **è¯»å–é˜¶æ®µ**ï¼šè¯»å–kä¸ªæ•°æ®å—ï¼ˆå¦‚æœæŸä¸ªå—æ•…éšœï¼Œä»å…¶ä»–å—æ¢å¤ï¼‰
2. **ç¼–ç é˜¶æ®µ**ï¼šä½¿ç”¨ISA-Lé‡æ–°ç¼–ç ç”Ÿæˆæ ¡éªŒå—
3. **å†™å…¥é˜¶æ®µ**ï¼šå†™å…¥æ›´æ–°çš„æ•°æ®å—å’Œæ ¡éªŒå—

**âœ… å¦‚ä½•å®ç°ï¼Ÿ**

```c
void ec_submit_rmw_request(struct ec_bdev_io *ec_io)
{
    struct ec_bdev *ec_bdev = ec_io->ec_bdev;
    struct ec_rmw_private *rmw = (struct ec_rmw_private *)ec_io->private;
    
    /* æ­¥éª¤1ï¼šåˆ†é…æ¡å¸¦ç¼“å†²åŒº */
    rmw->stripe_buf = ec_get_rmw_stripe_buf(ec_io->ec_ch);
    
    /* æ­¥éª¤2ï¼šè®¾ç½®æ•°æ®æŒ‡é’ˆ */
    for (uint8_t i = 0; i < k; i++) {
        rmw->data_ptrs[i] = rmw->stripe_buf + i * strip_size_bytes;
    }
    
    /* æ­¥éª¤3ï¼šåˆ†é…æ ¡éªŒç¼“å†²åŒº */
    for (uint8_t i = 0; i < p; i++) {
        rmw->parity_bufs[i] = ec_get_parity_buf(ec_io->ec_ch);
    }
    
    /* æ­¥éª¤4ï¼šè¯»å–kä¸ªæ•°æ®å— */
    rmw->state = EC_RMW_STATE_READING;
    rmw->reads_completed = 0;
    rmw->reads_expected = k;
    
    for (uint8_t i = 0; i < k; i++) {
        spdk_bdev_readv_blocks(base_info[i]->desc, base_ch[i],
                               &read_iov[i], 1,
                               stripe_offset, strip_size_blocks,
                               ec_rmw_read_complete, ec_io);
    }
}

/* è¯»å–å®Œæˆå›è°ƒ */
void ec_rmw_read_complete(struct spdk_bdev_io *bdev_io, bool success, void *cb_arg)
{
    struct ec_bdev_io *ec_io = cb_arg;
    struct ec_rmw_private *rmw = (struct ec_rmw_private *)ec_io->private;
    
    rmw->reads_completed++;
    
    if (rmw->reads_completed == rmw->reads_expected) {
        /* æ‰€æœ‰æ•°æ®å—è¯»å–å®Œæˆï¼Œå¼€å§‹ç¼–ç  */
        rmw->state = EC_RMW_STATE_ENCODING;
        
        /* æ›´æ–°è¦å†™å…¥çš„æ•°æ®å— */
        memcpy(rmw->data_ptrs[rmw->strip_idx_in_stripe],
               ec_io->write_data, ec_io->write_len);
        
        /* ISA-Lç¼–ç  */
        size_t len = ec_bdev->strip_size * ec_bdev->bdev.blocklen;
        ec_encode_stripe(ec_bdev, rmw->data_ptrs, rmw->parity_bufs, len);
        
        /* å¼€å§‹å†™å…¥ */
        rmw->state = EC_RMW_STATE_WRITING;
        ec_rmw_submit_writes(ec_io);
    }
}
```

### ECæ•°æ®ç»“æ„

```c
/* EC bdevç»“æ„ */
struct ec_bdev {
    struct spdk_bdev bdev;              /* å¿…é¡»æ”¾åœ¨ç¬¬ä¸€ä¸ªå­—æ®µ */
    uint8_t k;                          /* æ•°æ®å—æ•°é‡ */
    uint8_t p;                          /* æ ¡éªŒå—æ•°é‡ */
    uint64_t strip_size;                /* æ¡å¸¦å¤§å°ï¼ˆå—ï¼‰ */
    struct ec_base_bdev_info *base_bdev_info; /* åº•å±‚bdevä¿¡æ¯æ•°ç»„ */
    struct ec_bdev_module_private *module_private; /* ISA-Lç›¸å…³æ•°æ® */
    TAILQ_ENTRY(ec_bdev) tailq;
};

/* ISA-Læ¨¡å—ç§æœ‰æ•°æ® */
struct ec_bdev_module_private {
    unsigned char *encode_matrix;       /* ç¼–ç çŸ©é˜µ (k Ã— (k+p)) */
    unsigned char *g_tbls;             /* ç¼–ç è¡¨ (32 Ã— k Ã— p) */
    /* å…¶ä»–æ•°æ®... */
};

/* EC I/Oä¸Šä¸‹æ–‡ */
struct ec_bdev_io {
    struct spdk_bdev_io *bdev_io;      /* åŸå§‹I/Oè¯·æ±‚ */
    struct ec_bdev *ec_bdev;            /* EC bdev */
    struct ec_bdev_io_channel *ec_ch;  /* ECé€šé“ */
    void *private;                      /* ç§æœ‰æ•°æ®ï¼ˆå…¨æ¡å¸¦æˆ–RMWï¼‰ */
    /* å…¶ä»–æ•°æ®... */
};

/* å…¨æ¡å¸¦å†™å…¥ç§æœ‰æ•°æ® */
struct ec_stripe_private {
    unsigned char *parity_bufs[EC_MAX_P]; /* æ ¡éªŒç¼“å†²åŒºæ•°ç»„ */
    uint8_t num_parity;
    unsigned char *temp_data_bufs[EC_MAX_K]; /* ä¸´æ—¶æ•°æ®ç¼“å†²åŒºï¼ˆè·¨iovæ—¶ä½¿ç”¨ï¼‰ */
    uint8_t num_temp_bufs;
};

/* RMWç§æœ‰æ•°æ® */
struct ec_rmw_private {
    unsigned char *stripe_buf;          /* æ¡å¸¦ç¼“å†²åŒºï¼ˆkä¸ªæ•°æ®å—ï¼‰ */
    unsigned char *parity_bufs[EC_MAX_P]; /* æ ¡éªŒç¼“å†²åŒº */
    unsigned char *data_ptrs[EC_MAX_K]; /* æ•°æ®æŒ‡é’ˆæ•°ç»„ */
    enum ec_rmw_state state;            /* RMWçŠ¶æ€ */
    uint8_t reads_completed;            /* å·²å®Œæˆçš„è¯»å–æ•° */
    uint8_t reads_expected;             /* æœŸæœ›çš„è¯»å–æ•° */
};
```

### ç¼“å†²åŒºæ± ç®¡ç†

**ğŸ¯ æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ** ç®¡ç†æ ¡éªŒç¼“å†²åŒºå’ŒRMWæ¡å¸¦ç¼“å†²åŒºï¼Œé¿å…é¢‘ç¹åˆ†é…/é‡Šæ”¾

**â“ ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ** é¢‘ç¹åˆ†é…/é‡Šæ”¾å†…å­˜ä¼šå½±å“æ€§èƒ½ï¼Œä½¿ç”¨ç¼“å†²åŒºæ± å¯ä»¥é‡ç”¨å†…å­˜ã€‚

**âœ… å¦‚ä½•å®ç°ï¼Ÿ**

```c
/* æ ¡éªŒç¼“å†²åŒºæ±  */
struct ec_parity_buf_entry {
    unsigned char *buf;
    SLIST_ENTRY(ec_parity_buf_entry) link;
};

struct ec_bdev_io_channel {
    SLIST_HEAD(, ec_parity_buf_entry) parity_buf_pool;  /* æ ¡éªŒç¼“å†²åŒºæ±  */
    SLIST_HEAD(, ec_parity_buf_entry) rmw_stripe_buf_pool; /* RMWæ¡å¸¦ç¼“å†²åŒºæ±  */
    uint8_t parity_buf_count;
    uint8_t rmw_buf_count;
    size_t parity_buf_size;  /* æ ¡éªŒç¼“å†²åŒºå¤§å° */
    size_t rmw_buf_size;     /* RMWç¼“å†²åŒºå¤§å° */
};

/* è·å–æ ¡éªŒç¼“å†²åŒº */
static unsigned char *ec_get_parity_buf(struct ec_bdev_io_channel *ec_ch)
{
    struct ec_parity_buf_entry *entry;
    
    /* ä»æ± ä¸­è·å– */
    entry = SLIST_FIRST(&ec_ch->parity_buf_pool);
    if (entry != NULL) {
        SLIST_REMOVE_HEAD(&ec_ch->parity_buf_pool, link);
        ec_ch->parity_buf_count--;
        return entry->buf;
    }
    
    /* æ± ä¸ºç©ºï¼Œåˆ†é…æ–°ç¼“å†²åŒº */
    size_t align = 64;  /* ISA-Lè¦æ±‚64å­—èŠ‚å¯¹é½ */
    unsigned char *buf = spdk_dma_malloc(ec_ch->parity_buf_size, align, NULL);
    return buf;
}

/* å½’è¿˜æ ¡éªŒç¼“å†²åŒº */
static void ec_put_parity_buf(struct ec_bdev_io_channel *ec_ch, unsigned char *buf)
{
    struct ec_parity_buf_entry *entry = malloc(sizeof(*entry));
    if (entry != NULL) {
        entry->buf = buf;
        SLIST_INSERT_HEAD(&ec_ch->parity_buf_pool, entry, link);
        ec_ch->parity_buf_count++;
    } else {
        /* åˆ†é…å¤±è´¥ï¼Œç›´æ¥é‡Šæ”¾ */
        spdk_dma_free(buf);
    }
}
```

### æ•…éšœæ¢å¤

**ğŸ¯ æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ** å½“æŸä¸ªå—æ•…éšœæ—¶ï¼Œä»å…¶ä»–kä¸ªå—æ¢å¤æ•°æ®

**â“ ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ** ECå¯ä»¥å®¹å¿pä¸ªå—æ•…éšœï¼Œå½“è¯»å–æ•…éšœå—æ—¶ï¼Œéœ€è¦ä»å…¶ä»–kä¸ªå—æ¢å¤ã€‚

**âœ… å¦‚ä½•å®ç°ï¼Ÿ**

```c
int ec_bdev_gen_decode_matrix(struct ec_bdev *ec_bdev,
                              uint8_t *frag_err_list,  /* æ•…éšœå—ç´¢å¼•åˆ—è¡¨ */
                              int nerrs)               /* æ•…éšœå—æ•°é‡ */
{
    struct ec_bdev_module_private *mp = ec_bdev->module_private;
    uint8_t k = ec_bdev->k;
    uint8_t p = ec_bdev->p;
    
    /* æ­¥éª¤1ï¼šç”Ÿæˆè§£ç çŸ©é˜µ */
    /* è§£ç çŸ©é˜µæ˜¯ç¼–ç çŸ©é˜µçš„å­çŸ©é˜µï¼ŒåªåŒ…å«å¯ç”¨çš„kä¸ªå— */
    unsigned char *decode_matrix = malloc(k * k);
    unsigned char *invert_matrix = malloc(k * k);
    unsigned char *g_tbls = malloc(32 * k * nerrs);
    
    /* æ­¥éª¤2ï¼šæ„å»ºè§£ç çŸ©é˜µ */
    /* ä»ç¼–ç çŸ©é˜µä¸­é€‰æ‹©kä¸ªå¯ç”¨å—çš„è¡Œ */
    for (int i = 0; i < k; i++) {
        int src_idx = /* æ‰¾åˆ°ç¬¬iä¸ªå¯ç”¨å—çš„ç´¢å¼• */;
        memcpy(&decode_matrix[i * k],
               &mp->encode_matrix[src_idx * k],
               k);
    }
    
    /* æ­¥éª¤3ï¼šæ±‚é€†çŸ©é˜µ */
    gf_invert_matrix(decode_matrix, invert_matrix, k);
    
    /* æ­¥éª¤4ï¼šç”Ÿæˆè§£ç è¡¨ */
    ec_init_tables(k, nerrs, invert_matrix, g_tbls);
    
    /* æ­¥éª¤5ï¼šä½¿ç”¨ISA-Lè§£ç  */
    /* ec_decode_data(len, k, nerrs, g_tbls, data_ptrs, parity_ptrs) */
    
    free(decode_matrix);
    free(invert_matrix);
    free(g_tbls);
    return 0;
}
```

### å®Œæ•´å®ç°å‚è€ƒ

å‚è€ƒ `module/bdev/ec/` ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼š
- `bdev_ec.c` - ECæ¨¡å—ä¸»å®ç°
- `bdev_ec_encode.c` - ISA-Lç¼–ç å®ç°
- `bdev_ec_io.c` - I/Oå¤„ç†å®ç°
- `bdev_ec_internal.h` - å†…éƒ¨æ•°æ®ç»“æ„å®šä¹‰

---

### æ•°æ®æµè½¬è¯¦è§£ï¼šECæ¨¡å—

**ğŸ¯ æˆ‘è¦ç†è§£ä»€ä¹ˆï¼Ÿ** ä¸€ä»½æ•°æ®ä»ç”¨æˆ·åº”ç”¨å‘å‡ºï¼Œç»è¿‡ECæ¨¡å—ç¼–ç ï¼Œæœ€ç»ˆå†™å…¥åˆ°k+pä¸ªåº•å±‚bdevï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸­æ•°æ®æ˜¯å¦‚ä½•æµè½¬çš„ã€‚

#### å…¨æ¡å¸¦å†™å…¥æ•°æ®æµè½¬ï¼ˆFull Stripe Writeï¼‰

**åœºæ™¯**ï¼šç”¨æˆ·åº”ç”¨å†™å…¥å®Œæ•´æ¡å¸¦æ•°æ®ï¼ˆk=4ä¸ªæ•°æ®å—ï¼Œp=2ä¸ªæ ¡éªŒå—ï¼Œstrip_size=8å—ï¼Œblocklen=512å­—èŠ‚ï¼‰

**å®Œæ•´æµç¨‹**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ1ï¼šç”¨æˆ·åº”ç”¨å‘èµ·å†™å…¥è¯·æ±‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ç”¨æˆ·åº”ç”¨è°ƒç”¨ï¼š
  spdk_bdev_write(ec_desc, ch, buffer, offset=0, length=16384, cb, cb_arg)
  â†“
æ•°æ®è¯´æ˜ï¼š
  - æ€»é•¿åº¦ï¼š16384å­—èŠ‚ = 32å—ï¼ˆk=4ä¸ªstripï¼Œæ¯ä¸ªstrip=8å—ï¼‰
  - ç”¨æˆ·bufferåŒ…å«4ä¸ªæ•°æ®å—çš„æ•°æ®
  - æ¯ä¸ªæ•°æ®å— = 8å— Ã— 512å­—èŠ‚ = 4096å­—èŠ‚
  â†“
SPDKæ¡†æ¶å±‚ï¼š
  - åˆ›å»º spdk_bdev_io ç»“æ„
  - è®¾ç½® bdev_io->type = SPDK_BDEV_IO_TYPE_WRITE
  - è®¾ç½® bdev_io->u.bdev.offset_blocks = 0
  - è®¾ç½® bdev_io->u.bdev.num_blocks = 32
  - è®¾ç½® bdev_io->u.bdev.iovs[0].iov_base = bufferï¼ˆç”¨æˆ·æ•°æ®ï¼‰
  - è®¾ç½® bdev_io->u.bdev.iovs[0].iov_len = 16384
  â†“
è°ƒç”¨ ec_bdev->fn_table->submit_request(ch, bdev_io)
  â†“
è¿›å…¥ECæ¨¡å—ï¼šec_bdev_submit_request()

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ2ï¼šECæ¨¡å—æ¥æ”¶I/Oè¯·æ±‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ec_bdev_submit_request(struct spdk_io_channel *ch, 
                      struct spdk_bdev_io *bdev_io)
  â†“
1. è·å–EC I/Oä¸Šä¸‹æ–‡ï¼š
   struct ec_bdev_io *ec_io = (struct ec_bdev_io *)bdev_io->driver_ctx;
   â†“
2. å¡«å……EC I/Oä¿¡æ¯ï¼š
   ec_io->bdev_io = bdev_io;
   ec_io->ec_bdev = ec_bdev;
   ec_io->ec_ch = ec_ch;
   ec_io->offset_blocks = 0;
   ec_io->num_blocks = 32;
   ec_io->iovs = bdev_io->u.bdev.iovs;  // æŒ‡å‘ç”¨æˆ·buffer
   ec_io->iovcnt = bdev_io->u.bdev.iovcnt;
   â†“
3. è°ƒç”¨I/Oå¤„ç†å‡½æ•°ï¼š
   ec_submit_rw_request(ec_io)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ3ï¼šåœ°å€è½¬æ¢å’Œæ¡å¸¦åˆ¤æ–­                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ec_submit_rw_request(struct ec_bdev_io *ec_io)
  â†“
1. è®¡ç®—stripå’Œstripeç´¢å¼•ï¼š
   start_strip = 0 >> 3 = 0
   stripe_index = 0 / 4 = 0
   offset_in_strip = 0 & 7 = 0
   â†“
2. åˆ¤æ–­æ˜¯å¦å…¨æ¡å¸¦å†™å…¥ï¼š
   (start_strip % k == 0) && (offset_in_strip == 0) && (num_blocks == strip_size)
   â†’ (0 % 4 == 0) && (0 == 0) && (32 == 32) â†’ true
   â†“
3. é€‰æ‹©æ•°æ®å—å’Œæ ¡éªŒå—çš„åº•å±‚bdevç´¢å¼•ï¼š
   ec_select_base_bdevs_default(ec_bdev, stripe_index=0, data_indices, parity_indices)
   â†“
   è®¡ç®—ï¼š
   n = 6 (k+p)
   parity_start = (6 - (0 % 6)) % 6 = 0
   æ•°æ®å—ï¼šbdev[1], bdev[2], bdev[3], bdev[4]
   æ ¡éªŒå—ï¼šbdev[0], bdev[5]
   â†“
4. è°ƒç”¨å…¨æ¡å¸¦å†™å…¥å‡½æ•°ï¼š
   ec_submit_write_stripe(ec_io, stripe_index=0, data_indices, parity_indices)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ4ï¼šå‡†å¤‡æ•°æ®æŒ‡é’ˆå’Œåˆ†é…æ ¡éªŒç¼“å†²åŒº                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ec_submit_write_stripe(struct ec_bdev_io *ec_io, ...)
  â†“
1. å‡†å¤‡æ•°æ®æŒ‡é’ˆæ•°ç»„ï¼ˆdata_ptrsï¼‰ï¼š
   unsigned char *data_ptrs[4];
   â†“
   å¤„ç†ç”¨æˆ·æä¾›çš„iovsï¼Œæå–4ä¸ªæ•°æ®å—çš„æŒ‡é’ˆï¼š
   - data_ptrs[0] = iovs[0].iov_base + 0      â†’ ç¬¬1ä¸ªæ•°æ®å—ï¼ˆ4096å­—èŠ‚ï¼‰
   - data_ptrs[1] = iovs[0].iov_base + 4096   â†’ ç¬¬2ä¸ªæ•°æ®å—ï¼ˆ4096å­—èŠ‚ï¼‰
   - data_ptrs[2] = iovs[0].iov_base + 8192   â†’ ç¬¬3ä¸ªæ•°æ®å—ï¼ˆ4096å­—èŠ‚ï¼‰
   - data_ptrs[3] = iovs[0].iov_base + 12288  â†’ ç¬¬4ä¸ªæ•°æ®å—ï¼ˆ4096å­—èŠ‚ï¼‰
   â†“
   å…³é”®ç‚¹ï¼šæ•°æ®æŒ‡é’ˆç›´æ¥æŒ‡å‘ç”¨æˆ·bufferï¼Œä¸å¤åˆ¶æ•°æ®
   â†“
2. åˆ†é…æ ¡éªŒç¼“å†²åŒºï¼ˆparity_bufsï¼‰ï¼š
   unsigned char *parity_ptrs[2];
   â†“
   ä»ç¼“å†²åŒºæ± è·å–æˆ–åˆ†é…æ–°ç¼“å†²åŒºï¼š
   - parity_ptrs[0] = ec_get_parity_buf(ec_ch)  â†’ 4096å­—èŠ‚ï¼Œ64å­—èŠ‚å¯¹é½
   - parity_ptrs[1] = ec_get_parity_buf(ec_ch)  â†’ 4096å­—èŠ‚ï¼Œ64å­—èŠ‚å¯¹é½
   â†“
   å…³é”®ç‚¹ï¼šæ ¡éªŒç¼“å†²åŒºæ˜¯æ–°åˆ†é…çš„DMAå†…å­˜ï¼Œç”¨äºå­˜å‚¨ç¼–ç åçš„æ ¡éªŒå—

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ5ï¼šISA-Lç¼–ç ç”Ÿæˆæ ¡éªŒå—                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ec_encode_stripe(ec_bdev, data_ptrs, parity_ptrs, len=4096)
  â†“
1. é¢„å–ä¼˜åŒ–ï¼ˆæå‡æ€§èƒ½ï¼‰ï¼š
   - é¢„å–ç¼–ç è¡¨ï¼ˆg_tblsï¼‰åˆ°CPUç¼“å­˜
   - é¢„å–æ•°æ®å—åˆ°CPUç¼“å­˜
   - é¢„å–æ ¡éªŒå—åˆ°CPUç¼“å­˜ï¼ˆå†™æç¤ºï¼‰
   â†“
2. è°ƒç”¨ISA-Lç¼–ç å‡½æ•°ï¼š
   ec_encode_data(len=4096, k=4, p=2, g_tbls, data_ptrs, parity_ptrs)
   â†“
   ISA-Lå†…éƒ¨å¤„ç†ï¼š
   - ä»ç”¨æˆ·bufferè¯»å–4ä¸ªæ•°æ®å—
   - ä½¿ç”¨ç¼–ç è¡¨ï¼ˆg_tblsï¼‰è¿›è¡ŒGaloisåŸŸè¿ç®—
   - ç”Ÿæˆ2ä¸ªæ ¡éªŒå—
   - å°†æ ¡éªŒå—å†™å…¥parity_ptrs[0]å’Œparity_ptrs[1]
   â†“
3. ç¼–ç å®Œæˆï¼š
   - parity_ptrs[0] ç°åœ¨åŒ…å«ç¬¬1ä¸ªæ ¡éªŒå—ï¼ˆ4096å­—èŠ‚ï¼‰
   - parity_ptrs[1] ç°åœ¨åŒ…å«ç¬¬2ä¸ªæ ¡éªŒå—ï¼ˆ4096å­—èŠ‚ï¼‰
   â†“
   å…³é”®ç‚¹ï¼šç¼–ç è¿‡ç¨‹ä¸­ï¼Œæ•°æ®ä»ç”¨æˆ·bufferè¯»å–ï¼Œæ ¡éªŒå—å†™å…¥æ–°åˆ†é…çš„ç¼“å†²åŒº

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ6ï¼šå¹¶è¡Œå†™å…¥k+pä¸ªåº•å±‚bdev                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ec_submit_write_stripe() ç»§ç»­æ‰§è¡Œï¼š
  â†“
1. å‡†å¤‡å†™å…¥I/Oçš„iovsï¼š
   æ•°æ®å—ä½¿ç”¨ç”¨æˆ·bufferçš„iovsï¼ˆé›¶æ‹·è´ï¼‰
   æ ¡éªŒå—ä½¿ç”¨æ–°åˆ†é…çš„ç¼“å†²åŒº
   â†“
2. å¹¶è¡Œæäº¤kä¸ªæ•°æ®å—å†™å…¥ï¼š
   for (i = 0; i < k; i++) {
       spdk_bdev_writev_blocks(
           base_info[data_indices[i]]->desc,
           base_ch[data_indices[i]],
           data_iovs[i],           // æŒ‡å‘ç”¨æˆ·buffer
           data_iovcnt[i],
           base_offset[i],         // è½¬æ¢åçš„ç‰©ç†åœ°å€
           strip_size_blocks=8,
           ec_base_bdev_io_complete,
           ec_io);
   }
   â†“
   ä¾‹å¦‚ï¼š
   - å†™å…¥ bdev[1]ï¼šä»ç”¨æˆ·bufferè¯»å–4096å­—èŠ‚ï¼Œå†™å…¥ç‰©ç†ç£ç›˜
   - å†™å…¥ bdev[2]ï¼šä»ç”¨æˆ·bufferè¯»å–4096å­—èŠ‚ï¼Œå†™å…¥ç‰©ç†ç£ç›˜
   - å†™å…¥ bdev[3]ï¼šä»ç”¨æˆ·bufferè¯»å–4096å­—èŠ‚ï¼Œå†™å…¥ç‰©ç†ç£ç›˜
   - å†™å…¥ bdev[4]ï¼šä»ç”¨æˆ·bufferè¯»å–4096å­—èŠ‚ï¼Œå†™å…¥ç‰©ç†ç£ç›˜
   â†“
3. å¹¶è¡Œæäº¤pä¸ªæ ¡éªŒå—å†™å…¥ï¼š
   for (i = 0; i < p; i++) {
       struct iovec parity_iov = {
           .iov_base = parity_ptrs[i],  // æ ¡éªŒç¼“å†²åŒº
           .iov_len = 4096
       };
       spdk_bdev_writev_blocks(
           base_info[parity_indices[i]]->desc,
           base_ch[parity_indices[i]],
           &parity_iov, 1,
           parity_offset[i],
           strip_size_blocks=8,
           ec_base_bdev_io_complete,
           ec_io);
   }
   â†“
   ä¾‹å¦‚ï¼š
   - å†™å…¥ bdev[0]ï¼šä»parity_ptrs[0]è¯»å–4096å­—èŠ‚ï¼Œå†™å…¥ç‰©ç†ç£ç›˜
   - å†™å…¥ bdev[5]ï¼šä»parity_ptrs[1]è¯»å–4096å­—èŠ‚ï¼Œå†™å…¥ç‰©ç†ç£ç›˜
   â†“
4. æ‰€æœ‰I/Oæäº¤å®Œæˆï¼Œå‡½æ•°è¿”å›ï¼ˆå¼‚æ­¥ç­‰å¾…å®Œæˆï¼‰

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ7ï¼šI/Oå®Œæˆå¤„ç†å’Œèµ„æºé‡Šæ”¾                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
åº•å±‚bdevå†™å…¥å®Œæˆåï¼Œè°ƒç”¨å®Œæˆå›è°ƒï¼š
  ec_base_bdev_io_complete(struct spdk_bdev_io *bdev_io, bool success, void *cb_arg)
  â†“
1. è·å–EC I/Oä¸Šä¸‹æ–‡ï¼š
   struct ec_bdev_io *ec_io = cb_arg;
   â†“
2. é‡Šæ”¾åº•å±‚bdev I/Oï¼š
   spdk_bdev_free_io(bdev_io);
   â†“
3. è®¡æ•°å®Œæˆçš„I/Oï¼š
   ec_io->base_io_remaining--;
   â†“
4. æ£€æŸ¥æ˜¯å¦æ‰€æœ‰I/Oéƒ½å®Œæˆï¼š
   if (ec_io->base_io_remaining == 0) {
       /* æ‰€æœ‰k+pä¸ªI/Oéƒ½å®Œæˆ */
       â†“
       å½’è¿˜æ ¡éªŒç¼“å†²åŒºåˆ°æ± ï¼š
       for (i = 0; i < p; i++) {
           ec_put_parity_buf(ec_ch, parity_ptrs[i]);
       }
       â†“
       å®ŒæˆEC I/Oï¼š
       spdk_bdev_io_complete(ec_io->bdev_io, SPDK_BDEV_IO_STATUS_SUCCESS);
   }
   â†“
5. SPDKæ¡†æ¶è°ƒç”¨ç”¨æˆ·å›è°ƒï¼š
   user_cb(ec_io->bdev_io, success, user_cb_arg)
   â†“
6. ç”¨æˆ·åº”ç”¨æ”¶åˆ°å†™å…¥å®Œæˆé€šçŸ¥

**å…³é”®ç‚¹æ€»ç»“**ï¼š
- æ•°æ®å—é›¶æ‹·è´ï¼šæ•°æ®å—ç›´æ¥ä»ç”¨æˆ·bufferå†™å…¥åº•å±‚bdev
- æ ¡éªŒå—éœ€è¦åˆ†é…ï¼šæ ¡éªŒå—æ˜¯æ–°ç”Ÿæˆçš„ï¼Œéœ€è¦åˆ†é…ç¼“å†²åŒº
- å¹¶è¡Œå†™å…¥ï¼šk+pä¸ªI/Oå¹¶è¡Œæäº¤ï¼Œæé«˜æ€§èƒ½
- å¼‚æ­¥å®Œæˆï¼šæ‰€æœ‰I/Oå®Œæˆåæ‰é€šçŸ¥ç”¨æˆ·
- èµ„æºç®¡ç†ï¼šæ ¡éªŒç¼“å†²åŒºä½¿ç”¨å®Œåå½’è¿˜åˆ°æ± ï¼Œå¯ä»¥é‡ç”¨
```

#### RMWï¼ˆRead-Modify-Writeï¼‰æ•°æ®æµè½¬

**åœºæ™¯**ï¼šç”¨æˆ·åº”ç”¨å†™å…¥éƒ¨åˆ†æ¡å¸¦æ•°æ®ï¼ˆåªå†™å…¥ç¬¬2ä¸ªæ•°æ®å—çš„ä¸€éƒ¨åˆ†ï¼‰

**å®Œæ•´æµç¨‹**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ1ï¼šç”¨æˆ·åº”ç”¨å‘èµ·éƒ¨åˆ†å†™å…¥è¯·æ±‚                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ç”¨æˆ·åº”ç”¨è°ƒç”¨ï¼š
  spdk_bdev_write(ec_desc, ch, buffer, offset=12, length=2048, cb, cb_arg)
  â†“
æ•°æ®è¯´æ˜ï¼š
  - offset = 12å—ï¼ˆåœ¨ç¬¬2ä¸ªstripå†…ï¼Œåç§»4å—ï¼‰
  - length = 2048å­—èŠ‚ï¼ˆ4å—ï¼‰
  - åªå†™å…¥éƒ¨åˆ†æ•°æ®
  â†“
SPDKæ¡†æ¶å±‚åˆ›å»º spdk_bdev_io
  â†“
è¿›å…¥ECæ¨¡å—ï¼šec_submit_rw_request()

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ2ï¼šåˆ¤æ–­ä¸ºéƒ¨åˆ†æ¡å¸¦å†™å…¥ï¼ˆRMWè·¯å¾„ï¼‰                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ec_submit_rw_request()ï¼š
  â†“
1. è®¡ç®—åœ°å€ï¼š
   start_strip = 12 >> 3 = 1
   stripe_index = 1 / 4 = 0
   strip_idx_in_stripe = 1 % 4 = 1ï¼ˆç¬¬2ä¸ªæ•°æ®å—ï¼‰
   offset_in_strip = 12 & 7 = 4
   â†“
2. åˆ¤æ–­ä¸æ˜¯å…¨æ¡å¸¦å†™å…¥ï¼š
   (start_strip % k == 1) â†’ ä¸æ˜¯å…¨æ¡å¸¦
   â†“
3. è°ƒç”¨RMWè·¯å¾„ï¼š
   ec_submit_write_partial_stripe(ec_io, stripe_index=0, 
                                  strip_idx_in_stripe=1, 
                                  offset_in_strip=4, ...)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ3ï¼šåˆ†é…RMWç¼“å†²åŒº                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ec_submit_write_partial_stripe()ï¼š
  â†“
1. åˆ†é…æ¡å¸¦ç¼“å†²åŒºï¼ˆstripe_bufï¼‰ï¼š
   rmw->stripe_buf = ec_get_rmw_stripe_buf(ec_ch)
   â†“
   å¤§å°ï¼šk Ã— strip_size_bytes = 4 Ã— 4096 = 16384å­—èŠ‚
   ç”¨é€”ï¼šå­˜å‚¨æ•´ä¸ªæ¡å¸¦çš„kä¸ªæ•°æ®å—
   â†“
2. è®¾ç½®æ•°æ®æŒ‡é’ˆï¼š
   rmw->data_ptrs[0] = rmw->stripe_buf + 0 * 4096      â†’ ç¬¬1ä¸ªæ•°æ®å—
   rmw->data_ptrs[1] = rmw->stripe_buf + 1 * 4096      â†’ ç¬¬2ä¸ªæ•°æ®å—
   rmw->data_ptrs[2] = rmw->stripe_buf + 2 * 4096      â†’ ç¬¬3ä¸ªæ•°æ®å—
   rmw->data_ptrs[3] = rmw->stripe_buf + 3 * 4096      â†’ ç¬¬4ä¸ªæ•°æ®å—
   â†“
3. åˆ†é…æ ¡éªŒç¼“å†²åŒºï¼š
   rmw->parity_bufs[0] = ec_get_parity_buf(ec_ch)  â†’ 4096å­—èŠ‚
   rmw->parity_bufs[1] = ec_get_parity_buf(ec_ch)  â†’ 4096å­—èŠ‚

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ4ï¼šè¯»å–æ•´ä¸ªæ¡å¸¦çš„æ•°æ®å—                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ec_submit_write_partial_stripe() ç»§ç»­ï¼š
  â†“
1. è®¾ç½®RMWçŠ¶æ€ï¼š
   rmw->state = EC_RMW_STATE_READING;
   rmw->reads_completed = 0;
   rmw->reads_expected = k = 4;
   â†“
2. å¹¶è¡Œè¯»å–kä¸ªæ•°æ®å—ï¼š
   for (i = 0; i < k; i++) {
       struct iovec read_iov = {
           .iov_base = rmw->data_ptrs[i],  // æŒ‡å‘stripe_buf
           .iov_len = 4096
       };
       spdk_bdev_readv_blocks(
           base_info[data_indices[i]]->desc,
           base_ch[data_indices[i]],
           &read_iov, 1,
           stripe_offset[i],
           8,  // strip_size_blocks
           ec_rmw_read_complete,
           ec_io);
   }
   â†“
   ä¾‹å¦‚ï¼š
   - ä» bdev[1] è¯»å–4096å­—èŠ‚ â†’ å†™å…¥ stripe_buf[0:4096]
   - ä» bdev[2] è¯»å–4096å­—èŠ‚ â†’ å†™å…¥ stripe_buf[4096:8192]
   - ä» bdev[3] è¯»å–4096å­—èŠ‚ â†’ å†™å…¥ stripe_buf[8192:12288]
   - ä» bdev[4] è¯»å–4096å­—èŠ‚ â†’ å†™å…¥ stripe_buf[12288:16384]

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ5ï¼šè¯»å–å®Œæˆï¼Œæ›´æ–°æ•°æ®å¹¶ç¼–ç                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
æ‰€æœ‰è¯»å–å®Œæˆåï¼Œè°ƒç”¨ï¼š
  ec_rmw_read_complete(struct spdk_bdev_io *bdev_io, bool success, void *cb_arg)
  â†“
1. æ£€æŸ¥æ‰€æœ‰è¯»å–æ˜¯å¦å®Œæˆï¼š
   rmw->reads_completed++;
   if (rmw->reads_completed == rmw->reads_expected) {
       /* æ‰€æœ‰æ•°æ®å—è¯»å–å®Œæˆ */
       â†“
2. æ›´æ–°è¦å†™å…¥çš„æ•°æ®å—ï¼š
       /* å°†ç”¨æˆ·æ•°æ®å¤åˆ¶åˆ°stripe_bufçš„å¯¹åº”ä½ç½® */
       memcpy(rmw->data_ptrs[strip_idx_in_stripe=1] + offset_in_strip * 512,
              user_buffer,  // ç”¨æˆ·æä¾›çš„2048å­—èŠ‚æ•°æ®
              2048);
       â†“
       ç°åœ¨stripe_bufåŒ…å«ï¼š
       - data_ptrs[0]ï¼šä»bdev[1]è¯»å–çš„åŸå§‹æ•°æ®
       - data_ptrs[1]ï¼šéƒ¨åˆ†æ›´æ–°ï¼ˆå‰4å—æ˜¯åŸå§‹æ•°æ®ï¼Œå4å—æ˜¯ç”¨æˆ·æ•°æ®ï¼‰
       - data_ptrs[2]ï¼šä»bdev[3]è¯»å–çš„åŸå§‹æ•°æ®
       - data_ptrs[3]ï¼šä»bdev[4]è¯»å–çš„åŸå§‹æ•°æ®
       â†“
3. ISA-Lç¼–ç ç”Ÿæˆæ–°çš„æ ¡éªŒå—ï¼š
       rmw->state = EC_RMW_STATE_ENCODING;
       ec_encode_stripe(ec_bdev, rmw->data_ptrs, rmw->parity_bufs, 4096);
       â†“
       ç¼–ç è¿‡ç¨‹ï¼š
       - ä»stripe_bufè¯»å–4ä¸ªæ•°æ®å—
       - ä½¿ç”¨ISA-Lç”Ÿæˆ2ä¸ªæ ¡éªŒå—
       - æ ¡éªŒå—å†™å…¥parity_bufs[0]å’Œparity_bufs[1]
       â†“
4. å¼€å§‹å†™å…¥é˜¶æ®µï¼š
       rmw->state = EC_RMW_STATE_WRITING;
       ec_rmw_submit_writes(ec_io);
   }

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ6ï¼šå†™å…¥æ›´æ–°çš„æ•°æ®å—å’Œæ ¡éªŒå—                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ec_rmw_submit_writes()ï¼š
  â†“
1. å†™å…¥æ›´æ–°çš„æ•°æ®å—ï¼š
   /* åªå†™å…¥è¢«ä¿®æ”¹çš„æ•°æ®å— */
   struct iovec write_iov = {
       .iov_base = rmw->data_ptrs[strip_idx_in_stripe=1] + offset_in_strip * 512,
       .iov_len = 2048
   };
   spdk_bdev_writev_blocks(
       base_info[data_indices[1]]->desc,
       base_ch[data_indices[1]],
       &write_iov, 1,
       updated_offset,
       4,  // åªå†™å…¥4å—
       ec_base_bdev_io_complete,
       ec_io);
   â†“
2. å†™å…¥æ‰€æœ‰æ ¡éªŒå—ï¼ˆå› ä¸ºæ•°æ®æ”¹å˜äº†ï¼‰ï¼š
   for (i = 0; i < p; i++) {
       struct iovec parity_iov = {
           .iov_base = rmw->parity_bufs[i],
           .iov_len = 4096
       };
       spdk_bdev_writev_blocks(
           base_info[parity_indices[i]]->desc,
           base_ch[parity_indices[i]],
           &parity_iov, 1,
           parity_offset[i],
           8,
           ec_base_bdev_io_complete,
           ec_io);
   }
   â†“
3. æ‰€æœ‰å†™å…¥I/Oæäº¤å®Œæˆ

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ7ï¼šå®Œæˆå¤„ç†å’Œèµ„æºé‡Šæ”¾                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
æ‰€æœ‰å†™å…¥å®Œæˆåï¼š
  â†“
1. å½’è¿˜ç¼“å†²åŒºåˆ°æ± ï¼š
   ec_put_rmw_stripe_buf(ec_ch, rmw->stripe_buf);
   for (i = 0; i < p; i++) {
       ec_put_parity_buf(ec_ch, rmw->parity_bufs[i]);
   }
   â†“
2. å®ŒæˆEC I/Oå¹¶é€šçŸ¥ç”¨æˆ·

**å…³é”®ç‚¹æ€»ç»“**ï¼š
- RMWéœ€è¦è¯»å–æ•´ä¸ªæ¡å¸¦ï¼šå³ä½¿åªæ›´æ–°éƒ¨åˆ†æ•°æ®ï¼Œä¹Ÿè¦è¯»å–kä¸ªæ•°æ®å—
- æ•°æ®å¤åˆ¶ï¼šç”¨æˆ·æ•°æ®éœ€è¦å¤åˆ¶åˆ°stripe_buf
- é‡æ–°ç¼–ç ï¼šæ•°æ®æ›´æ–°åå¿…é¡»é‡æ–°ç”Ÿæˆæ ¡éªŒå—
- å†™å…¥å¼€é”€ï¼šéœ€è¦å†™å…¥æ›´æ–°çš„æ•°æ®å—å’Œæ‰€æœ‰æ ¡éªŒå—
- æ€§èƒ½å½±å“ï¼šRMWè·¯å¾„æ¯”å…¨æ¡å¸¦å†™å…¥æ…¢å¾ˆå¤šï¼ˆéœ€è¦è¯»å–+ç¼–ç +å†™å…¥ï¼‰
```

#### è¯»å–æ•°æ®æµè½¬ï¼ˆReadï¼‰

**åœºæ™¯**ï¼šç”¨æˆ·åº”ç”¨ä»EC bdevè¯»å–æ•°æ®

**å®Œæ•´æµç¨‹**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ1ï¼šç”¨æˆ·åº”ç”¨å‘èµ·è¯»å–è¯·æ±‚                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ç”¨æˆ·åº”ç”¨è°ƒç”¨ï¼š
  spdk_bdev_read(ec_desc, ch, buffer, offset=8, length=4096, cb, cb_arg)
  â†“
æ•°æ®è¯´æ˜ï¼š
  - offset = 8å—ï¼ˆç¬¬2ä¸ªstripï¼Œç¬¬1ä¸ªæ•°æ®å—ï¼‰
  - length = 4096å­—èŠ‚ï¼ˆ1ä¸ªstripï¼‰
  â†“
SPDKæ¡†æ¶å±‚åˆ›å»º spdk_bdev_ioï¼Œè®¾ç½®ç”¨æˆ·buffer
  â†“
è¿›å…¥ECæ¨¡å—ï¼šec_submit_rw_request()

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ2ï¼šåœ°å€è½¬æ¢å’Œé€‰æ‹©æ•°æ®å—                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ec_submit_rw_request()ï¼š
  â†“
1. è®¡ç®—åœ°å€ï¼š
   start_strip = 8 >> 3 = 1
   stripe_index = 1 / 4 = 0
   strip_idx_in_stripe = 1 % 4 = 1ï¼ˆç¬¬2ä¸ªæ•°æ®å—ï¼‰
   â†“
2. é€‰æ‹©æ•°æ®å—å’Œæ ¡éªŒå—ï¼š
   ec_select_base_bdevs_default(ec_bdev, stripe_index=0, ...)
   æ•°æ®å—ï¼šbdev[1], bdev[2], bdev[3], bdev[4]
   â†“
3. ç¡®å®šç›®æ ‡æ•°æ®å—ï¼š
   target_data_idx = data_indices[strip_idx_in_stripe=1] = 2
   ç»“æœï¼šä» bdev[2] è¯»å–
   â†“
4. è®¡ç®—ç‰©ç†åç§»ï¼š
   base_bdev_offset = (stripe_index * k + strip_idx_in_stripe) * strip_size
                    = (0 * 4 + 1) * 8 = 8å—
   â†“
5. æäº¤è¯»å–I/Oï¼š
   spdk_bdev_readv_blocks(
       base_info[2]->desc,
       base_ch[2],
       ec_io->iovs,      // ç”¨æˆ·buffer
       ec_io->iovcnt,
       base_bdev_offset=8,
       num_blocks=8,
       ec_base_bdev_io_complete,
       ec_io);

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ3ï¼šåº•å±‚bdevè¯»å–æ•°æ®                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
åº•å±‚bdevï¼ˆä¾‹å¦‚NVMe bdevï¼‰ï¼š
  â†“
1. ä»ç‰©ç†ç£ç›˜è¯»å–4096å­—èŠ‚æ•°æ®
   â†“
2. æ•°æ®ç›´æ¥å†™å…¥ç”¨æˆ·æä¾›çš„bufferï¼ˆé›¶æ‹·è´ï¼‰
   â†“
3. è¯»å–å®Œæˆåè°ƒç”¨å›è°ƒï¼š
   ec_base_bdev_io_complete(bdev_io, success, ec_io)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ4ï¼šæ•°æ®è¿”å›ç”¨æˆ·åº”ç”¨                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ec_base_bdev_io_complete()ï¼š
  â†“
1. é‡Šæ”¾åº•å±‚bdev I/O
   â†“
2. å®ŒæˆEC I/O
   â†“
3. è°ƒç”¨ç”¨æˆ·å›è°ƒ
   â†“
4. ç”¨æˆ·åº”ç”¨çš„bufferä¸­ç°åœ¨æœ‰æ•°æ®ï¼ˆä»åº•å±‚bdevè¯»å–çš„æ•°æ®ï¼‰

**å…³é”®ç‚¹æ€»ç»“**ï¼š
- è¯»å–é›¶æ‹·è´ï¼šæ•°æ®ç›´æ¥ä»åº•å±‚bdevå†™å…¥ç”¨æˆ·buffer
- åœ°å€è½¬æ¢ï¼šç¡®å®šä»å“ªä¸ªåº•å±‚bdevçš„å“ªä¸ªä½ç½®è¯»å–
- ç®€å•é«˜æ•ˆï¼šè¯»å–è·¯å¾„æ¯”å†™å…¥è·¯å¾„ç®€å•ï¼Œä¸éœ€è¦ç¼–ç 
```

**ECæ•°æ®æµè½¬å…³é”®ç‚¹æ€»ç»“**ï¼š

1. **å…¨æ¡å¸¦å†™å…¥**ï¼š
   - æ•°æ®å—é›¶æ‹·è´ï¼šç›´æ¥ä»ç”¨æˆ·bufferå†™å…¥
   - æ ¡éªŒå—éœ€è¦åˆ†é…ï¼šæ–°ç”Ÿæˆçš„æ ¡éªŒå—éœ€è¦ç¼“å†²åŒº
   - å¹¶è¡Œå†™å…¥ï¼šk+pä¸ªI/Oå¹¶è¡Œæäº¤

2. **RMWè·¯å¾„**ï¼š
   - éœ€è¦è¯»å–æ•´ä¸ªæ¡å¸¦ï¼šå³ä½¿åªæ›´æ–°éƒ¨åˆ†æ•°æ®
   - æ•°æ®å¤åˆ¶ï¼šç”¨æˆ·æ•°æ®å¤åˆ¶åˆ°stripe_buf
   - é‡æ–°ç¼–ç ï¼šå¿…é¡»é‡æ–°ç”Ÿæˆæ ¡éªŒå—
   - æ€§èƒ½å¼€é”€å¤§ï¼šè¯»å–+ç¼–ç +å†™å…¥

3. **è¯»å–**ï¼š
   - é›¶æ‹·è´ï¼šæ•°æ®ç›´æ¥å†™å…¥ç”¨æˆ·buffer
   - ç®€å•é«˜æ•ˆï¼šä¸éœ€è¦ç¼–ç ï¼Œç›´æ¥è¯»å–å¯¹åº”æ•°æ®å—

4. **èµ„æºç®¡ç†**ï¼š
   - ç¼“å†²åŒºæ± ï¼šé‡ç”¨æ ¡éªŒç¼“å†²åŒºå’ŒRMWç¼“å†²åŒº
   - å¼‚æ­¥å®Œæˆï¼šæ‰€æœ‰I/Oå®Œæˆåæ‰é€šçŸ¥ç”¨æˆ·

---

## æ€»ç»“ä¸è¿›é˜¶

### ä¸‰ä¸ªç¤ºä¾‹çš„å¯¹æ¯”

| ç‰¹æ€§ | Demo | RAID 0 | EC |
|------|------|--------|-----|
| **å¤æ‚åº¦** | â­ | â­â­ | â­â­â­â­â­ |
| **åº•å±‚bdevæ•°é‡** | 0ï¼ˆè™šæ‹Ÿï¼‰ | å¤šä¸ª | k+pä¸ª |
| **åœ°å€è½¬æ¢** | ä¸éœ€è¦ | éœ€è¦ | éœ€è¦ |
| **ç¼–ç /è§£ç ** | ä¸éœ€è¦ | ä¸éœ€è¦ | éœ€è¦ï¼ˆISA-Lï¼‰ |
| **æ•…éšœå®¹å¿** | 0 | 0 | pä¸ªå— |
| **æ€§èƒ½ä¼˜åŒ–** | æ—  | æ¡å¸¦åŒ– | ç¼–ç åŠ é€Ÿã€ç¼“å†²åŒºæ±  |

### å­¦ä¹ è·¯å¾„å»ºè®®

1. **ç¬¬ä¸€æ­¥**ï¼šç†è§£Demoæ¨¡å—
   - ç†è§£åŸºæœ¬çš„æ•°æ®ç»“æ„å’Œå‡½æ•°
   - ç†è§£I/Oå¤„ç†æµç¨‹
   - ç†è§£RPCæ¥å£

2. **ç¬¬äºŒæ­¥**ï¼šå®ç°RAID 0
   - ç†è§£åœ°å€è½¬æ¢é€»è¾‘
   - ç†è§£å¦‚ä½•æäº¤I/Oåˆ°åº•å±‚bdev
   - ç†è§£I/Oå®Œæˆå›è°ƒ

3. **ç¬¬ä¸‰æ­¥**ï¼šç†è§£ECæ¨¡å—
   - ç†è§£ISA-Lç¼–ç åŸç†
   - ç†è§£RMWè·¯å¾„
   - ç†è§£æ•…éšœæ¢å¤

4. **ç¬¬å››æ­¥**ï¼šåˆ›å»ºè‡ªå·±çš„æ¨¡å—
   - åŸºäºDemoæ¨¡å—åˆ›å»ºæ–°åŠŸèƒ½
   - å‚è€ƒRAID 0å®ç°åœ°å€è½¬æ¢
   - å‚è€ƒECå®ç°ç¼–ç /è§£ç 

### å…³é”®APIæ€»ç»“

| API | ä½œç”¨ | ä½¿ç”¨åœºæ™¯ |
|-----|------|----------|
| `SPDK_BDEV_MODULE_REGISTER` | æ³¨å†Œæ¨¡å— | æ¨¡å—åˆå§‹åŒ– |
| `spdk_bdev_register` | æ³¨å†Œbdev | åˆ›å»ºbdevæ—¶ |
| `spdk_bdev_unregister` | æ³¨é”€bdev | åˆ é™¤bdevæ—¶ |
| `spdk_bdev_io_complete` | å®ŒæˆI/O | I/Oå¤„ç†å®Œæˆæ—¶ |
| `spdk_io_device_register` | æ³¨å†ŒI/Oè®¾å¤‡ | åˆ›å»ºbdevæ—¶ |
| `spdk_get_io_channel` | è·å–I/Oé€šé“ | è·å–é€šé“æ—¶ |
| `spdk_poller_register` | æ³¨å†Œpoller | åˆ›å»ºé€šé“æ—¶ |
| `spdk_bdev_readv_blocks` | è¯»å–åº•å±‚bdev | RAID/ECè¯»å–æ—¶ |
| `spdk_bdev_writev_blocks` | å†™å…¥åº•å±‚bdev | RAID/ECå†™å…¥æ—¶ |
| `ec_encode_data` | ISA-Lç¼–ç  | ECç¼–ç æ—¶ |
| `gf_gen_cauchy1_matrix` | ç”Ÿæˆç¼–ç çŸ©é˜µ | ECåˆå§‹åŒ–æ—¶ |

### å¸¸è§é—®é¢˜

**Q1: ä¸ºä»€ä¹ˆ`spdk_bdev`å¿…é¡»æ”¾åœ¨ç¬¬ä¸€ä¸ªå­—æ®µï¼Ÿ**

**A**: SPDKä½¿ç”¨`container_of`å®ä»`spdk_bdev`æŒ‡é’ˆè·å–æˆ‘ä»¬çš„ç»“æ„ï¼Œè¦æ±‚`spdk_bdev`å¿…é¡»æ˜¯ç¬¬ä¸€ä¸ªå­—æ®µã€‚

**Q2: ä¸ºä»€ä¹ˆéœ€è¦I/Oé€šé“ï¼Ÿ**

**A**: I/Oé€šé“æ˜¯çº¿ç¨‹æœ¬åœ°çš„ï¼Œç”¨äºç®¡ç†è¯¥çº¿ç¨‹çš„I/Oè¯·æ±‚ï¼Œé¿å…é”ç«äº‰ï¼Œæé«˜æ€§èƒ½ã€‚

**Q3: ISA-Lç¼–ç è¡¨ä¸ºä»€ä¹ˆéœ€è¦64å­—èŠ‚å¯¹é½ï¼Ÿ**

**A**: ISA-Lä½¿ç”¨SIMDæŒ‡ä»¤ï¼ˆSSE/AVXï¼‰ï¼Œè¿™äº›æŒ‡ä»¤è¦æ±‚æ•°æ®64å­—èŠ‚å¯¹é½æ‰èƒ½å‘æŒ¥æœ€ä½³æ€§èƒ½ã€‚

**Q4: RMWè·¯å¾„ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ï¼Ÿ**

**A**: å½“å†™å…¥çš„I/Oä¸æ˜¯å®Œæ•´æ¡å¸¦æ—¶ï¼Œéœ€è¦ä½¿ç”¨RMWè·¯å¾„ï¼šå…ˆè¯»å–æ•´ä¸ªæ¡å¸¦ï¼Œæ›´æ–°æ•°æ®ï¼Œé‡æ–°ç¼–ç ï¼Œç„¶åå†™å…¥ã€‚

**Q5: ECå¦‚ä½•é€‰æ‹©æ•°æ®å—å’Œæ ¡éªŒå—çš„ä½ç½®ï¼Ÿ**

**A**: ECä½¿ç”¨è½®è¯¢æ–¹å¼é€‰æ‹©æ•°æ®å—å’Œæ ¡éªŒå—çš„ä½ç½®ï¼Œç¡®ä¿è´Ÿè½½å‡è¡¡ã€‚å¯ä»¥é€šè¿‡`ec_select_base_bdevs_default`å‡½æ•°è‡ªå®šä¹‰é€‰æ‹©ç­–ç•¥ã€‚

---

## ä¸‹ä¸€æ­¥

å®Œæˆæœ¬æŒ‡å—åï¼Œä½ å¯ä»¥ï¼š

1. **é˜…è¯»SPDKå®˜æ–¹æ–‡æ¡£** - äº†è§£æ›´å¤šé«˜çº§ç‰¹æ€§
2. **é˜…è¯»å…¶ä»–bdevæ¨¡å—** - å­¦ä¹ æ›´å¤šå®ç°æŠ€å·§
3. **åˆ›å»ºè‡ªå·±çš„æ¨¡å—** - åŸºäºæœ¬æŒ‡å—åˆ›å»ºæ–°åŠŸèƒ½
4. **æ€§èƒ½ä¼˜åŒ–** - å­¦ä¹ æ€§èƒ½ä¼˜åŒ–æŠ€å·§ï¼ˆé¢„å–ã€ç¼“å†²åŒºæ± ç­‰ï¼‰

---

**ç¥ä½ å¼€å‘é¡ºåˆ©ï¼** ğŸš€
