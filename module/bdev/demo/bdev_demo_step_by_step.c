/*   SPDX-License-Identifier: BSD-3-Clause
 *   
 *   æ‰‹æŠŠæ‰‹æ„å»ºSPDK Bdevæ¨¡å— - é€æ­¥åˆ†è§£ä¸å®ç°ç‰ˆæœ¬
 *   
 *   æ•™å­¦æ–¹å¼ï¼š
 *   1. ä»é¡¶å±‚ç›®æ ‡å¼€å§‹ï¼š"æˆ‘è¦å®ç°ä»€ä¹ˆ"
 *   2. ä¸æ–­åˆ†è§£ï¼š"å®ç°è¿™ä¸ªéœ€è¦ä»€ä¹ˆ"
 *   3. åˆ†è§£åˆ°æœ€åº•å±‚åï¼Œå¼€å§‹å®ç°
 *   4. æ¯å®ç°ä¸€å±‚ï¼ŒéªŒè¯ä¸€å±‚ï¼Œç„¶åç»§ç»­å¾€ä¸Š
 */

#include "spdk/stdinc.h"
#include "spdk/bdev.h"
#include "spdk/bdev_module.h"
#include "spdk/thread.h"
#include "spdk/log.h"
#include "spdk/string.h"
#include "spdk/util.h"

#include "bdev_demo.h"

/* ========================================================================
 * ã€é¡¶å±‚ç›®æ ‡ã€‘
 * ========================================================================
 * 
 * ğŸ¯ æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ
 * 
 * ç›®æ ‡ï¼šåˆ›å»ºä¸€ä¸ªSPDK Bdevæ¨¡å—ï¼Œå¯ä»¥é€šè¿‡RPCåˆ›å»ºè™šæ‹Ÿç£ç›˜ï¼Œæ”¯æŒè¯»å†™æ“ä½œ
 * 
 * ========================================================================
 * ã€ç¬¬ä¸€å±‚åˆ†è§£ã€‘
 * ========================================================================
 * 
 * â“ å®ç°ä¸€ä¸ªSPDK Bdevæ¨¡å—éœ€è¦ä»€ä¹ˆï¼Ÿ
 * 
 * éœ€è¦3ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼š
 * 1. åˆ›å»ºBdev - èƒ½å¤Ÿé€šè¿‡RPCåˆ›å»ºä¸€ä¸ªè™šæ‹Ÿç£ç›˜
 * 2. å¤„ç†I/O  - èƒ½å¤Ÿå¤„ç†è¯»å†™ç­‰I/Oè¯·æ±‚  
 * 3. åˆ é™¤Bdev - èƒ½å¤Ÿé€šè¿‡RPCåˆ é™¤è™šæ‹Ÿç£ç›˜
 * 
 * ========================================================================
 * ã€ç¬¬äºŒå±‚åˆ†è§£ï¼šåˆ›å»ºBdevã€‘
 * ========================================================================
 * 
 * â“ åˆ›å»ºBdevéœ€è¦ä»€ä¹ˆï¼Ÿ
 * 
 * éœ€è¦5ä¸ªå­åŠŸèƒ½ï¼š
 * 1. å®šä¹‰Bdevç»“æ„ - å­˜å‚¨bdevçš„ä¿¡æ¯ï¼ˆåç§°ã€å¤§å°ç­‰ï¼‰
 * 2. æ³¨å†Œåˆ°SPDKæ¡†æ¶ - è®©SPDKçŸ¥é“è¿™ä¸ªbdevå­˜åœ¨
 * 3. æä¾›RPCæ¥å£ - è®©ç”¨æˆ·å¯ä»¥é€šè¿‡RPCåˆ›å»º
 * 4. åˆå§‹åŒ–I/Oé€šé“ - ä¸ºæ¯ä¸ªçº¿ç¨‹å‡†å¤‡I/Oå¤„ç†èµ„æº
 * 5. è®¾ç½®Bdevå±æ€§ - è®¾ç½®å—å¤§å°ã€å—æ•°é‡ç­‰
 * 
 * ========================================================================
 * ã€ç¬¬ä¸‰å±‚åˆ†è§£ï¼šå®šä¹‰Bdevç»“æ„ã€‘
 * ========================================================================
 * 
 * â“ å®šä¹‰Bdevç»“æ„éœ€è¦ä»€ä¹ˆï¼Ÿ
 * 
 * éœ€è¦å®šä¹‰3ä¸ªæ•°æ®ç»“æ„ï¼š
 * 1. demo_bdev_io - æ¯ä¸ªI/Oè¯·æ±‚çš„ä¸Šä¸‹æ–‡
 * 2. demo_bdev    - ä»£è¡¨ä¸€ä¸ªbdevè®¾å¤‡
 * 3. demo_io_channel - æ¯ä¸ªçº¿ç¨‹çš„I/Oé€šé“
 * 
 * ========================================================================
 * ã€æœ€åº•å±‚å®ç°ï¼šæ­¥éª¤1 - å®šä¹‰I/Oä¸Šä¸‹æ–‡ç»“æ„ã€‘
 * ========================================================================
 * 
 * ğŸ¯ æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ
 * å®šä¹‰ä¸€ä¸ªç»“æ„æ¥å­˜å‚¨æ¯ä¸ªI/Oè¯·æ±‚çš„ç§æœ‰æ•°æ®
 * 
 * â“ ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªï¼Ÿ
 * - SPDKæ¡†æ¶çš„spdk_bdev_ioç»“æ„æ˜¯å›ºå®šçš„ï¼Œæˆ‘ä»¬ä¸èƒ½ä¿®æ”¹
 * - æˆ‘ä»¬éœ€è¦ä¸€ä¸ªåœ°æ–¹å­˜å‚¨æ¯ä¸ªI/Oçš„ç§æœ‰æ•°æ®ï¼ˆæ¯”å¦‚é˜Ÿåˆ—èŠ‚ç‚¹ï¼‰
 * - è¿™ä¸ªæ•°æ®å­˜å‚¨åœ¨spdk_bdev_ioçš„driver_ctxå­—æ®µä¸­
 * 
 * âœ… å¦‚ä½•å®ç°ï¼Ÿ
 */

struct demo_bdev_io {
	/* ç”¨äºå°†I/Oæ”¾å…¥é˜Ÿåˆ—çš„é“¾è¡¨èŠ‚ç‚¹ */
	TAILQ_ENTRY(demo_bdev_io) link;
};

/* ========================================================================
 * ã€æœ€åº•å±‚å®ç°ï¼šæ­¥éª¤2 - å®šä¹‰Bdevç»“æ„ã€‘
 * ========================================================================
 * 
 * ğŸ¯ æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ
 * å®šä¹‰ä¸€ä¸ªç»“æ„æ¥å­˜å‚¨bdevè®¾å¤‡çš„ä¿¡æ¯
 * 
 * â“ ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªï¼Ÿ
 * - éœ€è¦å­˜å‚¨bdevçš„åç§°ã€å¤§å°ç­‰ä¿¡æ¯
 * - å¿…é¡»åŒ…å«SPDKæ¡†æ¶çš„spdk_bdevç»“æ„ï¼ˆå¿…é¡»æ”¾åœ¨ç¬¬ä¸€ä¸ªå­—æ®µï¼‰
 * - éœ€è¦èƒ½å¤Ÿæ‰¾åˆ°è¿™ä¸ªbdevï¼ˆé€šè¿‡é“¾è¡¨ï¼‰
 * 
 * âœ… å¦‚ä½•å®ç°ï¼Ÿ
 */

struct demo_bdev {
	/* è¿™æ˜¯SPDKæ¡†æ¶è¦æ±‚çš„ï¼Œå¿…é¡»æ”¾åœ¨ç¬¬ä¸€ä¸ªå­—æ®µ */
	struct spdk_bdev bdev;
	
	/* ç”¨äºå°†bdevæ”¾å…¥å…¨å±€é“¾è¡¨çš„èŠ‚ç‚¹ */
	TAILQ_ENTRY(demo_bdev) tailq;
};

/* ========================================================================
 * ã€æœ€åº•å±‚å®ç°ï¼šæ­¥éª¤3 - å®šä¹‰I/Oé€šé“ç»“æ„ã€‘
 * ========================================================================
 * 
 * ğŸ¯ æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ
 * å®šä¹‰ä¸€ä¸ªç»“æ„æ¥å­˜å‚¨æ¯ä¸ªçº¿ç¨‹çš„I/Oå¤„ç†èµ„æº
 * 
 * â“ ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªï¼Ÿ
 * - æ¯ä¸ªçº¿ç¨‹éœ€è¦ä¸€ä¸ªç‹¬ç«‹çš„I/Oé˜Ÿåˆ—ï¼ˆé¿å…é”ç«äº‰ï¼‰
 * - æ¯ä¸ªçº¿ç¨‹éœ€è¦ä¸€ä¸ªpolleræ¥å¤„ç†I/Oï¼ˆå¼‚æ­¥å¤„ç†ï¼‰
 * - è¿™æ˜¯çº¿ç¨‹æœ¬åœ°èµ„æºï¼Œæé«˜æ€§èƒ½
 * 
 * âœ… å¦‚ä½•å®ç°ï¼Ÿ
 */

struct demo_io_channel {
	/* ä¸€ä¸ªpollerï¼Œç”¨äºå¼‚æ­¥å¤„ç†I/O */
	struct spdk_poller *poller;
	
	/* I/Oè¯·æ±‚é˜Ÿåˆ— */
	TAILQ_HEAD(, demo_bdev_io) io_queue;
};

/* ========================================================================
 * ã€å…¨å±€å˜é‡ã€‘
 * ========================================================================
 */

/* æ‰€æœ‰demo bdevè®¾å¤‡çš„é“¾è¡¨å¤´ */
static TAILQ_HEAD(, demo_bdev) g_demo_bdevs = TAILQ_HEAD_INITIALIZER(g_demo_bdevs);

/* å‡½æ•°å‰å‘å£°æ˜ */
static int bdev_demo_poll_io(void *arg);
static int bdev_demo_create_channel(void *io_device, void *ctx_buf);
static void bdev_demo_destroy_channel(void *io_device, void *ctx_buf);

/* ========================================================================
 * ã€ç¬¬äºŒå±‚åˆ†è§£ï¼šæ³¨å†Œåˆ°SPDKæ¡†æ¶ã€‘
 * ========================================================================
 * 
 * â“ æ³¨å†Œåˆ°SPDKæ¡†æ¶éœ€è¦ä»€ä¹ˆï¼Ÿ
 * 
 * éœ€è¦3ä¸ªç»„ä»¶ï¼š
 * 1. æ¨¡å—æ¥å£ç»“æ„ (struct spdk_bdev_module) - å‘Šè¯‰SPDKæ¨¡å—çš„åŸºæœ¬ä¿¡æ¯
 * 2. æ¨¡å—æ³¨å†Œå® (SPDK_BDEV_MODULE_REGISTER) - è‡ªåŠ¨æ³¨å†Œæ¨¡å—
 * 3. Bdevæ³¨å†Œå‡½æ•° (spdk_bdev_register) - æ³¨å†Œå…·ä½“çš„bdev
 * 
 * ========================================================================
 * ã€ç¬¬ä¸‰å±‚åˆ†è§£ï¼šæ¨¡å—æ¥å£ç»“æ„ã€‘
 * ========================================================================
 * 
 * â“ æ¨¡å—æ¥å£ç»“æ„éœ€è¦ä»€ä¹ˆï¼Ÿ
 * 
 * éœ€è¦å®šä¹‰ä»¥ä¸‹å‡½æ•°æŒ‡é’ˆï¼š
 * 1. module_init - æ¨¡å—åˆå§‹åŒ–å‡½æ•°
 * 2. module_fini - æ¨¡å—æ¸…ç†å‡½æ•°
 * 3. get_ctx_size - è¿”å›I/Oä¸Šä¸‹æ–‡å¤§å°
 * 
 * ========================================================================
 * ã€æœ€åº•å±‚å®ç°ï¼šæ­¥éª¤4 - å®ç°get_ctx_sizeå‡½æ•°ã€‘
 * ========================================================================
 * 
 * ğŸ¯ æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ
 * å‘Šè¯‰SPDKæ¡†æ¶I/Oä¸Šä¸‹æ–‡çš„å¤§å°
 * 
 * â“ ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªï¼Ÿ
 * - SPDKæ¡†æ¶éœ€è¦çŸ¥é“ä¸ºæ¯ä¸ªI/Oåˆ†é…å¤šå°‘å†…å­˜
 * - è¿™ä¸ªå†…å­˜ç”¨äºå­˜å‚¨demo_bdev_ioç»“æ„
 * - æ¡†æ¶ä¼šåœ¨åˆ›å»ºspdk_bdev_ioæ—¶åˆ†é…è¿™ä¸ªå†…å­˜
 * 
 * âœ… å¦‚ä½•å®ç°ï¼Ÿ
 */

static int
bdev_demo_get_ctx_size(void)
{
	return sizeof(struct demo_bdev_io);
}

/* ========================================================================
 * ã€æœ€åº•å±‚å®ç°ï¼šæ­¥éª¤5 - å®ç°æ¨¡å—åˆå§‹åŒ–å‡½æ•°ã€‘
 * ========================================================================
 * 
 * ğŸ¯ æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ
 * æ¨¡å—åŠ è½½æ—¶æ‰§è¡Œåˆå§‹åŒ–
 * 
 * â“ ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªï¼Ÿ
 * - SPDKæ¡†æ¶åœ¨åŠ è½½æ¨¡å—æ—¶ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°
 * - å¯ä»¥åœ¨è¿™é‡Œåšä¸€äº›å…¨å±€åˆå§‹åŒ–å·¥ä½œ
 * - å¯¹äºdemoæ¨¡å—ï¼Œæš‚æ—¶ä¸éœ€è¦åšä»€ä¹ˆ
 * 
 * âœ… å¦‚ä½•å®ç°ï¼Ÿ
 */

static int
bdev_demo_initialize(void)
{
	SPDK_NOTICELOG("Demo bdev module initialized\n");
	return 0;
}

/* ========================================================================
 * ã€æœ€åº•å±‚å®ç°ï¼šæ­¥éª¤6 - å®ç°æ¨¡å—æ¸…ç†å‡½æ•°ã€‘
 * ========================================================================
 * 
 * ğŸ¯ æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ
 * æ¨¡å—å¸è½½æ—¶æ‰§è¡Œæ¸…ç†
 * 
 * â“ ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªï¼Ÿ
 * - SPDKæ¡†æ¶åœ¨å¸è½½æ¨¡å—æ—¶ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°
 * - å¯ä»¥åœ¨è¿™é‡Œåšä¸€äº›å…¨å±€æ¸…ç†å·¥ä½œ
 * - æ³¨æ„ï¼šæ­¤æ—¶æ‰€æœ‰çš„bdevåº”è¯¥å·²ç»è¢«åˆ é™¤äº†
 * 
 * âœ… å¦‚ä½•å®ç°ï¼Ÿ
 */

static void
bdev_demo_finish(void)
{
	SPDK_NOTICELOG("Demo bdev module finished\n");
}

/* ========================================================================
 * ã€æœ€åº•å±‚å®ç°ï¼šæ­¥éª¤7 - å®šä¹‰æ¨¡å—æ¥å£ç»“æ„ã€‘
 * ========================================================================
 * 
 * ğŸ¯ æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ
 * å‘Šè¯‰SPDKæ¡†æ¶æ¨¡å—çš„åŸºæœ¬ä¿¡æ¯
 * 
 * â“ ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªï¼Ÿ
 * - SPDKæ¡†æ¶é€šè¿‡è¿™ä¸ªç»“æ„äº†è§£æ¨¡å—
 * - æ¡†æ¶ä¼šè°ƒç”¨è¿™é‡Œå®šä¹‰çš„å‡½æ•°
 * - è¿™æ˜¯æ¨¡å—å’Œæ¡†æ¶ä¹‹é—´çš„å¥‘çº¦
 * 
 * âœ… å¦‚ä½•å®ç°ï¼Ÿ
 */

static struct spdk_bdev_module demo_if = {
	.name = "demo",                    /* æ¨¡å—åç§° */
	.module_init = bdev_demo_initialize,  /* åˆå§‹åŒ–å‡½æ•° */
	.module_fini = bdev_demo_finish,       /* æ¸…ç†å‡½æ•° */
	.async_fini = false,                  /* æ˜¯å¦å¼‚æ­¥æ¸…ç† */
	.get_ctx_size = bdev_demo_get_ctx_size, /* è¿”å›I/Oä¸Šä¸‹æ–‡å¤§å° */
};

/* ========================================================================
 * ã€æœ€åº•å±‚å®ç°ï¼šæ­¥éª¤8 - æ³¨å†Œæ¨¡å—åˆ°æ¡†æ¶ã€‘
 * ========================================================================
 * 
 * ğŸ¯ æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ
 * è®©SPDKæ¡†æ¶çŸ¥é“è¿™ä¸ªæ¨¡å—å­˜åœ¨
 * 
 * â“ ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªï¼Ÿ
 * - æ²¡æœ‰æ³¨å†Œï¼ŒSPDKæ¡†æ¶å°±ä¸çŸ¥é“è¿™ä¸ªæ¨¡å—
 * - è¿™ä¸ªå®ä¼šåœ¨ç¨‹åºå¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œï¼ˆé€šè¿‡constructorå±æ€§ï¼‰
 * - æ¡†æ¶ä¼šè°ƒç”¨module_initå‡½æ•°æ¥åˆå§‹åŒ–æ¨¡å—
 * 
 * âœ… å¦‚ä½•å®ç°ï¼Ÿ
 */

SPDK_BDEV_MODULE_REGISTER(demo, &demo_if)

/* ========================================================================
 * ã€ç¬¬äºŒå±‚åˆ†è§£ï¼šå¤„ç†I/Oã€‘
 * ========================================================================
 * 
 * â“ å¤„ç†I/Oéœ€è¦ä»€ä¹ˆï¼Ÿ
 * 
 * éœ€è¦4ä¸ªå­åŠŸèƒ½ï¼š
 * 1. æ¥æ”¶I/Oè¯·æ±‚ - SPDKæ¡†æ¶è°ƒç”¨æˆ‘ä»¬çš„å‡½æ•°æäº¤I/O
 * 2. é˜Ÿåˆ—ç®¡ç† - å°†I/Oæ”¾å…¥é˜Ÿåˆ—ç­‰å¾…å¤„ç†
 * 3. å¼‚æ­¥å¤„ç† - ä½¿ç”¨pollerå¼‚æ­¥å¤„ç†I/O
 * 4. å®ŒæˆI/O - å¤„ç†å®Œåé€šçŸ¥SPDKæ¡†æ¶
 * 
 * ========================================================================
 * ã€ç¬¬ä¸‰å±‚åˆ†è§£ï¼šå¼‚æ­¥å¤„ç†ã€‘
 * ========================================================================
 * 
 * â“ å¼‚æ­¥å¤„ç†éœ€è¦ä»€ä¹ˆï¼Ÿ
 * 
 * éœ€è¦3ä¸ªç»„ä»¶ï¼š
 * 1. I/Oé€šé“ç»“æ„ - å­˜å‚¨æ¯ä¸ªçº¿ç¨‹çš„I/Oé˜Ÿåˆ—ï¼ˆå·²å®šä¹‰ï¼‰
 * 2. Pollerå‡½æ•° - å®šæœŸå¤„ç†é˜Ÿåˆ—ä¸­çš„I/O
 * 3. é˜Ÿåˆ—æ“ä½œ - å…¥é˜Ÿã€å‡ºé˜Ÿ
 * 
 * ========================================================================
 * ã€æœ€åº•å±‚å®ç°ï¼šæ­¥éª¤9 - å®ç°I/Oå¤„ç†pollerå‡½æ•°ã€‘
 * ========================================================================
 * 
 * ğŸ¯ æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ
 * å¼‚æ­¥å¤„ç†é˜Ÿåˆ—ä¸­çš„I/Oè¯·æ±‚
 * 
 * â“ ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªï¼Ÿ
 * - I/Oå¤„ç†æ˜¯å¼‚æ­¥çš„ï¼Œä¸èƒ½é˜»å¡
 * - Pollerä¼šåœ¨æ¯ä¸ªäº‹ä»¶å¾ªç¯ä¸­è¢«è°ƒç”¨
 * - ä»é˜Ÿåˆ—ä¸­å–å‡ºI/Oå¹¶å¤„ç†
 * 
 * â“ å®ç°è¿™ä¸ªéœ€è¦ä»€ä¹ˆï¼Ÿ
 * - ä»é˜Ÿåˆ—å–å‡ºI/O
 * - æ ¹æ®I/Oç±»å‹å¤„ç†ï¼ˆREAD/WRITEç­‰ï¼‰
 * - è°ƒç”¨spdk_bdev_io_completeå®ŒæˆI/O
 * 
 * âœ… å¦‚ä½•å®ç°ï¼Ÿ
 */

static int
bdev_demo_poll_io(void *arg)
{
	struct demo_io_channel *ch = arg;
	struct demo_bdev_io *demo_io;
	struct spdk_bdev_io *bdev_io;
	
	/* ä»é˜Ÿåˆ—å–å‡ºI/O */
	demo_io = TAILQ_FIRST(&ch->io_queue);
	if (demo_io == NULL) {
		return 0;  /* é˜Ÿåˆ—ä¸ºç©ºï¼Œä¸éœ€è¦ç«‹å³å†æ¬¡è°ƒç”¨ */
	}
	
	/* ä»é˜Ÿåˆ—ä¸­ç§»é™¤ */
	TAILQ_REMOVE(&ch->io_queue, demo_io, link);
	
	/* è·å–spdk_bdev_ioç»“æ„ */
	bdev_io = spdk_bdev_io_from_ctx(demo_io);
	
	/* æ ¹æ®I/Oç±»å‹å¤„ç† */
	switch (bdev_io->type) {
	case SPDK_BDEV_IO_TYPE_READ:
		/* å¯¹äºREADï¼Œdemo bdevè¿”å›é›¶æ•°æ®
		 * å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥ä»å­˜å‚¨è®¾å¤‡è¯»å–æ•°æ®
		 */
		{
			uint64_t bytes_to_read = bdev_io->u.bdev.num_blocks * bdev_io->bdev->blocklen;
			uint64_t bytes_read = 0;
			int i;
			
			/* å¤„ç†å¤šä¸ªiovçš„æƒ…å†µ */
			for (i = 0; i < bdev_io->u.bdev.iovcnt && bytes_read < bytes_to_read; i++) {
				uint64_t to_zero = spdk_min(bytes_to_read - bytes_read,
							     bdev_io->u.bdev.iovs[i].iov_len);
				memset(bdev_io->u.bdev.iovs[i].iov_base, 0, to_zero);
				bytes_read += to_zero;
			}
		}
		spdk_bdev_io_complete(bdev_io, SPDK_BDEV_IO_STATUS_SUCCESS);
		break;
		
	case SPDK_BDEV_IO_TYPE_WRITE:
		/* å¯¹äºWRITEï¼Œdemo bdevç›´æ¥ä¸¢å¼ƒæ•°æ®
		 * å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥å†™å…¥å­˜å‚¨è®¾å¤‡
		 */
		spdk_bdev_io_complete(bdev_io, SPDK_BDEV_IO_STATUS_SUCCESS);
		break;
		
	case SPDK_BDEV_IO_TYPE_WRITE_ZEROES:
		/* WRITE_ZEROESï¼šç›´æ¥æˆåŠŸ */
		spdk_bdev_io_complete(bdev_io, SPDK_BDEV_IO_STATUS_SUCCESS);
		break;
		
	case SPDK_BDEV_IO_TYPE_RESET:
		/* RESETï¼šæ¸…ç©ºæ‰€æœ‰å¾…å¤„ç†çš„I/O */
		/* å¯¹äºdemoï¼Œæˆ‘ä»¬ç®€å•åœ°å®Œæˆè¿™ä¸ªI/O */
		spdk_bdev_io_complete(bdev_io, SPDK_BDEV_IO_STATUS_SUCCESS);
		break;
		
	default:
		spdk_bdev_io_complete(bdev_io, SPDK_BDEV_IO_STATUS_FAILED);
		break;
	}
	
	/* è¿”å›1è¡¨ç¤ºéœ€è¦ç«‹å³å†æ¬¡è°ƒç”¨ï¼ˆå¦‚æœè¿˜æœ‰I/Oï¼‰ */
	return 1;
}

/* ========================================================================
 * ã€æœ€åº•å±‚å®ç°ï¼šæ­¥éª¤10 - å®ç°I/Oé€šé“åˆ›å»ºå›è°ƒã€‘
 * ========================================================================
 * 
 * ğŸ¯ æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ
 * åˆå§‹åŒ–æ¯ä¸ªçº¿ç¨‹çš„I/Oé€šé“
 * 
 * â“ ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªï¼Ÿ
 * - å½“çº¿ç¨‹ç¬¬ä¸€æ¬¡è®¿é—®bdevæ—¶ï¼Œéœ€è¦åˆ›å»ºé€šé“
 * - éœ€è¦åˆå§‹åŒ–é˜Ÿåˆ—å’Œpoller
 * - SPDKæ¡†æ¶ä¼šè‡ªåŠ¨è°ƒç”¨è¿™ä¸ªå‡½æ•°
 * 
 * â“ å®ç°è¿™ä¸ªéœ€è¦ä»€ä¹ˆï¼Ÿ
 * - åˆå§‹åŒ–I/Oé˜Ÿåˆ—
 * - æ³¨å†Œpolleræ¥å¤„ç†I/O
 * 
 * âœ… å¦‚ä½•å®ç°ï¼Ÿ
 */

static int
bdev_demo_create_channel(void *io_device, void *ctx_buf)
{
	struct demo_io_channel *ch = ctx_buf;
	
	/* åˆå§‹åŒ–I/Oé˜Ÿåˆ— */
	TAILQ_INIT(&ch->io_queue);
	
	/* åˆ›å»ºpolleræ¥å¤„ç†I/O
	 * pollerå‡½æ•°ä¼šåœ¨æ¯ä¸ªäº‹ä»¶å¾ªç¯ä¸­è¢«è°ƒç”¨
	 * å‚æ•°ï¼šå‡½æ•°ã€å‚æ•°ã€å‘¨æœŸï¼ˆ0è¡¨ç¤ºæ¯ä¸ªäº‹ä»¶å¾ªç¯éƒ½è°ƒç”¨ï¼‰
	 */
	ch->poller = spdk_poller_register(bdev_demo_poll_io, ch, 0);
	
	return 0;
}

/* ========================================================================
 * ã€æœ€åº•å±‚å®ç°ï¼šæ­¥éª¤11 - å®ç°I/Oé€šé“é”€æ¯å›è°ƒã€‘
 * ========================================================================
 * 
 * ğŸ¯ æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ
 * æ¸…ç†æ¯ä¸ªçº¿ç¨‹çš„I/Oé€šé“
 * 
 * â“ ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªï¼Ÿ
 * - å½“çº¿ç¨‹ä¸å†ä½¿ç”¨bdevæ—¶ï¼Œéœ€è¦æ¸…ç†èµ„æº
 * - éœ€è¦å–æ¶ˆpoller
 * - SPDKæ¡†æ¶ä¼šè‡ªåŠ¨è°ƒç”¨è¿™ä¸ªå‡½æ•°
 * 
 * âœ… å¦‚ä½•å®ç°ï¼Ÿ
 */

static void
bdev_demo_destroy_channel(void *io_device, void *ctx_buf)
{
	struct demo_io_channel *ch = ctx_buf;
	
	/* å–æ¶ˆæ³¨å†Œpoller */
	spdk_poller_unregister(&ch->poller);
}

/* ========================================================================
 * ã€æœ€åº•å±‚å®ç°ï¼šæ­¥éª¤12 - å®ç°get_io_channelå‡½æ•°ã€‘
 * ========================================================================
 * 
 * ğŸ¯ æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ
 * è·å–I/Oé€šé“
 * 
 * â“ ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªï¼Ÿ
 * - SPDKæ¡†æ¶éœ€è¦è·å–I/Oé€šé“æ¥æäº¤I/O
 * - æ¡†æ¶ä¼šè‡ªåŠ¨è°ƒç”¨create_channelå›è°ƒæ¥åˆ›å»ºé€šé“
 * - é€šé“æ˜¯çº¿ç¨‹æœ¬åœ°çš„ï¼Œæ¯ä¸ªçº¿ç¨‹ä¸€ä¸ª
 * 
 * âœ… å¦‚ä½•å®ç°ï¼Ÿ
 */

static struct spdk_io_channel *
bdev_demo_get_io_channel(void *ctx)
{
	/* è·å–æˆ–åˆ›å»ºI/Oé€šé“
	 * å‚æ•°ctxå°±æ˜¯demo_bdevç»“æ„ï¼ˆåœ¨bdev_demo_createä¸­æ³¨å†Œçš„ï¼‰
	 * SPDKæ¡†æ¶ä¼šè‡ªåŠ¨è°ƒç”¨create_channelå›è°ƒæ¥åˆ›å»ºé€šé“
	 */
	return spdk_get_io_channel(ctx);
}

/* ========================================================================
 * ã€ç¬¬ä¸‰å±‚åˆ†è§£ï¼šæ¥æ”¶I/Oè¯·æ±‚ã€‘
 * ========================================================================
 * 
 * â“ æ¥æ”¶I/Oè¯·æ±‚éœ€è¦ä»€ä¹ˆï¼Ÿ
 * 
 * éœ€è¦3ä¸ªç»„ä»¶ï¼š
 * 1. å‡½æ•°è¡¨ (struct spdk_bdev_fn_table) - å®šä¹‰bdevçš„æ“ä½œå‡½æ•°
 * 2. submit_requestå‡½æ•° - æ¥æ”¶I/Oè¯·æ±‚çš„å‡½æ•°
 * 3. I/Oä¸Šä¸‹æ–‡ç»“æ„ - å­˜å‚¨æ¯ä¸ªI/Oçš„ç§æœ‰æ•°æ®ï¼ˆå·²å®šä¹‰ï¼‰
 * 
 * ========================================================================
 * ã€æœ€åº•å±‚å®ç°ï¼šæ­¥éª¤13 - å®ç°submit_requestå‡½æ•°ã€‘
 * ========================================================================
 * 
 * ğŸ¯ æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ
 * æ¥æ”¶I/Oè¯·æ±‚å¹¶æ”¾å…¥é˜Ÿåˆ—
 * 
 * â“ ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªï¼Ÿ
 * - SPDKæ¡†æ¶é€šè¿‡è¿™ä¸ªå‡½æ•°æäº¤I/O
 * - æˆ‘ä»¬éœ€è¦å°†I/Oæ”¾å…¥é˜Ÿåˆ—ï¼Œç”±pollerå¤„ç†
 * - è¿™æ˜¯I/Oå¤„ç†çš„å…¥å£ç‚¹
 * 
 * â“ å®ç°è¿™ä¸ªéœ€è¦ä»€ä¹ˆï¼Ÿ
 * - è·å–I/Oé€šé“
 * - è·å–I/Oä¸Šä¸‹æ–‡
 * - æ ¹æ®I/Oç±»å‹å¤„ç†
 * - å°†I/Oæ”¾å…¥é˜Ÿåˆ—æˆ–ç›´æ¥å®Œæˆ
 * 
 * âœ… å¦‚ä½•å®ç°ï¼Ÿ
 */

static void
bdev_demo_submit_request(struct spdk_io_channel *_ch, struct spdk_bdev_io *bdev_io)
{
	struct demo_io_channel *ch = spdk_io_channel_get_ctx(_ch);
	struct demo_bdev_io *demo_io = (struct demo_bdev_io *)bdev_io->driver_ctx;
	
	/* æ ¹æ®I/Oç±»å‹è¿›è¡Œå¤„ç† */
	switch (bdev_io->type) {
	case SPDK_BDEV_IO_TYPE_READ:
		/* å¯¹äºREADè¯·æ±‚ï¼Œæˆ‘ä»¬éœ€è¦ï¼š
		 * 1. å°†I/Oæ”¾å…¥é˜Ÿåˆ—
		 * 2. Pollerä¼šå¼‚æ­¥å¤„ç†å¹¶å®ŒæˆI/O
		 */
		TAILQ_INSERT_TAIL(&ch->io_queue, demo_io, link);
		break;
		
	case SPDK_BDEV_IO_TYPE_WRITE:
		/* å¯¹äºWRITEè¯·æ±‚ï¼ŒåŒæ ·æ”¾å…¥é˜Ÿåˆ— */
		TAILQ_INSERT_TAIL(&ch->io_queue, demo_io, link);
		break;
		
	case SPDK_BDEV_IO_TYPE_WRITE_ZEROES:
		/* WRITE_ZEROESï¼šå†™å…¥é›¶ */
		TAILQ_INSERT_TAIL(&ch->io_queue, demo_io, link);
		break;
		
	case SPDK_BDEV_IO_TYPE_RESET:
		/* RESETï¼šé‡ç½®è®¾å¤‡ */
		TAILQ_INSERT_TAIL(&ch->io_queue, demo_io, link);
		break;
		
	case SPDK_BDEV_IO_TYPE_ABORT:
		/* ABORTï¼šå–æ¶ˆä¸€ä¸ªæ­£åœ¨è¿›è¡Œçš„I/O */
		/* å¯¹äºdemoï¼Œæˆ‘ä»¬ç›´æ¥è¿”å›å¤±è´¥ */
		spdk_bdev_io_complete(bdev_io, SPDK_BDEV_IO_STATUS_FAILED);
		break;
		
	case SPDK_BDEV_IO_TYPE_FLUSH:
	case SPDK_BDEV_IO_TYPE_UNMAP:
	default:
		/* ä¸æ”¯æŒçš„æ“ä½œ */
		spdk_bdev_io_complete(bdev_io, SPDK_BDEV_IO_STATUS_FAILED);
		break;
	}
}

/* ========================================================================
 * ã€æœ€åº•å±‚å®ç°ï¼šæ­¥éª¤14 - å®ç°io_type_supportedå‡½æ•°ã€‘
 * ========================================================================
 * 
 * ğŸ¯ æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ
 * å‘Šè¯‰æ¡†æ¶æ”¯æŒå“ªäº›I/Oç±»å‹
 * 
 * â“ ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªï¼Ÿ
 * - æ¡†æ¶éœ€è¦çŸ¥é“å“ªäº›æ“ä½œæ˜¯æ”¯æŒçš„
 * - ä¸æ”¯æŒçš„æ“ä½œä¼šè¢«æ¡†æ¶æ‹’ç»
 * - é¿å…æäº¤ä¸æ”¯æŒçš„I/Oç±»å‹
 * 
 * âœ… å¦‚ä½•å®ç°ï¼Ÿ
 */

static bool
bdev_demo_io_type_supported(void *ctx, enum spdk_bdev_io_type io_type)
{
	switch (io_type) {
	case SPDK_BDEV_IO_TYPE_READ:
	case SPDK_BDEV_IO_TYPE_WRITE:
	case SPDK_BDEV_IO_TYPE_WRITE_ZEROES:
	case SPDK_BDEV_IO_TYPE_RESET:
		return true;
	case SPDK_BDEV_IO_TYPE_ABORT:
	case SPDK_BDEV_IO_TYPE_FLUSH:
	case SPDK_BDEV_IO_TYPE_UNMAP:
	default:
		return false;
	}
}

/* ========================================================================
 * ã€æœ€åº•å±‚å®ç°ï¼šæ­¥éª¤15 - å®šä¹‰å‡½æ•°è¡¨ã€‘
 * ========================================================================
 * 
 * ğŸ¯ æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ
 * å°†bdevçš„æ“ä½œå‡½æ•°ç»„ç»‡åœ¨ä¸€èµ·
 * 
 * â“ ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªï¼Ÿ
 * - SPDKæ¡†æ¶é€šè¿‡å‡½æ•°è¡¨è°ƒç”¨bdevçš„æ“ä½œ
 * - è¿™æ˜¯bdevå’Œæ¡†æ¶ä¹‹é—´çš„æ¥å£
 * - æ¡†æ¶é€šè¿‡è¿™ä¸ªè¡¨çŸ¥é“å¦‚ä½•æ“ä½œbdev
 * 
 * âœ… å¦‚ä½•å®ç°ï¼Ÿ
 */

static const struct spdk_bdev_fn_table demo_fn_table = {
	.destruct = bdev_demo_destruct,              /* é”€æ¯bdev */
	.submit_request = bdev_demo_submit_request, /* æäº¤I/Oè¯·æ±‚ */
	.io_type_supported = bdev_demo_io_type_supported, /* æ£€æŸ¥I/Oç±»å‹æ”¯æŒ */
	.get_io_channel = bdev_demo_get_io_channel, /* è·å–I/Oé€šé“ */
};

/* ========================================================================
 * ã€æœ€åº•å±‚å®ç°ï¼šæ­¥éª¤16 - å®ç°destructå‡½æ•°ã€‘
 * ========================================================================
 * 
 * ğŸ¯ æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ
 * é”€æ¯bdevæ—¶æ¸…ç†èµ„æº
 * 
 * â“ ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªï¼Ÿ
 * - å½“bdevè¢«åˆ é™¤æ—¶ï¼Œéœ€è¦æ¸…ç†èµ„æº
 * - éœ€è¦ä»å…¨å±€é“¾è¡¨ä¸­ç§»é™¤
 * - éœ€è¦é‡Šæ”¾å†…å­˜
 * 
 * â“ å®ç°è¿™ä¸ªéœ€è¦ä»€ä¹ˆï¼Ÿ
 * - ä»å…¨å±€é“¾è¡¨ç§»é™¤
 * - é‡Šæ”¾bdevåç§°çš„å†…å­˜
 * - é‡Šæ”¾bdevç»“æ„æœ¬èº«
 * 
 * âœ… å¦‚ä½•å®ç°ï¼Ÿ
 */

static int
bdev_demo_destruct(void *ctx)
{
	struct demo_bdev *demo_bdev = ctx;
	
	/* ä»å…¨å±€é“¾è¡¨ä¸­ç§»é™¤ */
	TAILQ_REMOVE(&g_demo_bdevs, demo_bdev, tailq);
	
	/* é‡Šæ”¾bdevåç§°çš„å†…å­˜ */
	free(demo_bdev->bdev.name);
	
	/* é‡Šæ”¾bdevç»“æ„æœ¬èº« */
	free(demo_bdev);
	
	return 0;
}

/* ========================================================================
 * ã€æœ€åº•å±‚å®ç°ï¼šæ­¥éª¤17 - å®ç°bdevåˆ›å»ºå‡½æ•°ã€‘
 * ========================================================================
 * 
 * ğŸ¯ æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ
 * åˆ›å»ºå¹¶æ³¨å†Œä¸€ä¸ªbdev
 * 
 * â“ ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªï¼Ÿ
 * - ç”¨æˆ·éœ€è¦èƒ½å¤Ÿåˆ›å»ºbdev
 * - éœ€è¦åˆ†é…å†…å­˜ã€è®¾ç½®å±æ€§ã€æ³¨å†Œåˆ°æ¡†æ¶
 * 
 * â“ å®ç°è¿™ä¸ªéœ€è¦ä»€ä¹ˆï¼Ÿ
 * - åˆ†é…demo_bdevç»“æ„
 * - è®¾ç½®bdevå±æ€§ï¼ˆåç§°ã€å¤§å°ç­‰ï¼‰
 * - æ³¨å†ŒI/Oè®¾å¤‡ï¼ˆç”¨äºåˆ›å»ºI/Oé€šé“ï¼‰
 * - æ³¨å†Œbdevåˆ°æ¡†æ¶
 * - æ·»åŠ åˆ°å…¨å±€é“¾è¡¨
 * 
 * âœ… å¦‚ä½•å®ç°ï¼Ÿ
 */

int
bdev_demo_create(struct spdk_bdev **bdev, const char *name,
		 uint64_t num_blocks, uint32_t block_size)
{
	struct demo_bdev *demo_bdev;
	int rc;
	
	/* æ£€æŸ¥å‚æ•° */
	if (name == NULL || strlen(name) == 0) {
		SPDK_ERRLOG("bdev name cannot be empty\n");
		return -EINVAL;
	}
	
	if (num_blocks == 0) {
		SPDK_ERRLOG("num_blocks cannot be zero\n");
		return -EINVAL;
	}
	
	if (block_size == 0 || block_size % 512 != 0) {
		SPDK_ERRLOG("block_size must be a multiple of 512\n");
		return -EINVAL;
	}
	
	/* åˆ†é…bdevç»“æ„ */
	demo_bdev = calloc(1, sizeof(struct demo_bdev));
	if (demo_bdev == NULL) {
		SPDK_ERRLOG("Failed to allocate demo_bdev\n");
		return -ENOMEM;
	}
	
	/* è®¾ç½®bdevçš„åŸºæœ¬ä¿¡æ¯ */
	demo_bdev->bdev.name = strdup(name);
	if (demo_bdev->bdev.name == NULL) {
		free(demo_bdev);
		return -ENOMEM;
	}
	
	demo_bdev->bdev.product_name = "Demo Disk";
	demo_bdev->bdev.write_cache = 0;
	demo_bdev->bdev.blocklen = block_size;
	demo_bdev->bdev.blockcnt = num_blocks;
	demo_bdev->bdev.ctxt = demo_bdev;
	demo_bdev->bdev.module = &demo_if;
	demo_bdev->bdev.fn_table = &demo_fn_table;
	
	/* æ³¨å†ŒI/Oè®¾å¤‡
	 * è¿™æ ·SPDKæ¡†æ¶å°±çŸ¥é“å¦‚ä½•åˆ›å»ºI/Oé€šé“äº†
	 * å‚æ•°ï¼š
	 *   - io_device: I/Oè®¾å¤‡ï¼ˆå°±æ˜¯demo_bdevï¼‰
	 *   - create_cb: åˆ›å»ºé€šé“çš„å›è°ƒ
	 *   - destroy_cb: é”€æ¯é€šé“çš„å›è°ƒ
	 *   - ctx_size: é€šé“ç»“æ„çš„å¤§å°
	 *   - name: I/Oè®¾å¤‡åç§°ï¼ˆç”¨äºè°ƒè¯•ï¼‰
	 */
	spdk_io_device_register(demo_bdev, bdev_demo_create_channel,
				 bdev_demo_destroy_channel,
				 sizeof(struct demo_io_channel),
				 "demo_bdev");
	
	/* æ³¨å†Œbdevåˆ°SPDKæ¡†æ¶ */
	rc = spdk_bdev_register(&demo_bdev->bdev);
	if (rc != 0) {
		SPDK_ERRLOG("Failed to register bdev: %s\n", spdk_strerror(-rc));
		spdk_io_device_unregister(demo_bdev, NULL);
		free(demo_bdev->bdev.name);
		free(demo_bdev);
		return rc;
	}
	
	/* æ·»åŠ åˆ°å…¨å±€é“¾è¡¨ */
	TAILQ_INSERT_TAIL(&g_demo_bdevs, demo_bdev, tailq);
	
	*bdev = &demo_bdev->bdev;
	
	SPDK_NOTICELOG("Created demo bdev: %s (blocks: %lu, block_size: %u)\n",
		       name, num_blocks, block_size);
	
	return 0;
}

/* ========================================================================
 * ã€æœ€åº•å±‚å®ç°ï¼šæ­¥éª¤18 - å®ç°bdevåˆ é™¤å‡½æ•°ã€‘
 * ========================================================================
 * 
 * ğŸ¯ æˆ‘è¦å®ç°ä»€ä¹ˆï¼Ÿ
 * åˆ é™¤ä¸€ä¸ªbdev
 * 
 * â“ ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªï¼Ÿ
 * - ç”¨æˆ·éœ€è¦èƒ½å¤Ÿåˆ é™¤bdev
 * - éœ€è¦ä»æ¡†æ¶ä¸­ç§»é™¤
 * 
 * â“ å®ç°è¿™ä¸ªéœ€è¦ä»€ä¹ˆï¼Ÿ
 * - åœ¨å…¨å±€é“¾è¡¨ä¸­æŸ¥æ‰¾bdev
 * - è°ƒç”¨spdk_bdev_unregisteråˆ é™¤
 * - å¤„ç†å¼‚æ­¥å›è°ƒ
 * 
 * âœ… å¦‚ä½•å®ç°ï¼Ÿ
 */

void
bdev_demo_delete(const char *name, spdk_bdev_unregister_cb cb_fn, void *cb_arg)
{
	struct demo_bdev *demo_bdev, *tmp;
	
	/* åœ¨å…¨å±€é“¾è¡¨ä¸­æŸ¥æ‰¾ */
	TAILQ_FOREACH_SAFE(demo_bdev, &g_demo_bdevs, tailq, tmp) {
		if (strcmp(demo_bdev->bdev.name, name) == 0) {
			/* æ‰¾åˆ°äº†ï¼Œå¼€å§‹åˆ é™¤ */
			spdk_bdev_unregister(&demo_bdev->bdev, cb_fn, cb_arg);
			return;
		}
	}
	
	/* æ²¡æ‰¾åˆ° */
	if (cb_fn) {
		cb_fn(cb_arg, -ENOENT);
	}
}

