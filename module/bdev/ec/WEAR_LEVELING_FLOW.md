


# ç£¨æŸå‡è¡¡æ‰©å±•æ¨¡å—æµç¨‹è¯¦è§£

## ğŸ“‹ æ¦‚è¿°

ç£¨æŸå‡è¡¡æ‰©å±•æ¨¡å—ï¼ˆWear Leveling Extensionï¼‰ä¸ºECæ¨¡å—æä¾›ç£¨æŸæ„ŸçŸ¥çš„I/Oè°ƒåº¦åŠŸèƒ½ï¼Œé€šè¿‡ç›‘æ§å„base bdevçš„ç£¨æŸç¨‹åº¦ï¼Œæ™ºèƒ½åˆ†é…å†™å…¥è´Ÿè½½ï¼Œå»¶é•¿SSDå¯¿å‘½ã€‚

### æ ¸å¿ƒç‰¹æ€§

- **ä¸‰çº§æ¨¡å¼**ï¼šDISABLED/SIMPLE/FULLï¼Œå¯æ ¹æ®éœ€æ±‚é€‰æ‹©å¤æ‚åº¦
- **ç¡®å®šæ€§è°ƒåº¦**ï¼šåŒä¸€stripeå§‹ç»ˆé€‰æ‹©ç›¸åŒçš„base bdevï¼ˆåŸºäºstripe_indexï¼‰
- **è‡ªåŠ¨é™çº§**ï¼šæ£€æµ‹åˆ°æ•…éšœæ—¶è‡ªåŠ¨ä»å¤æ‚æ¨¡å¼é€€å›åˆ°ç®€å•æ¨¡å¼
- **ä½å¼€é”€**ï¼šç¼“å­˜æœºåˆ¶å‡å°‘NVMeå‘½ä»¤è°ƒç”¨
- **å¿«ç…§æœºåˆ¶**ï¼šç¡®ä¿è¯»å–ä¸€è‡´æ€§ï¼Œå³ä½¿ç£¨æŸåˆ†å¸ƒå˜åŒ–

---

## ğŸ—ï¸ ä¸€ã€æ¨¡å—åˆå§‹åŒ–

### 1.1 æ³¨å†Œæµç¨‹

```
RPCå‘½ä»¤ï¼ˆ-w 2ï¼ŒFULLæ¨¡å¼ï¼‰
    â†“
ec_bdev_create()
    â†“
wear_leveling_ext_register()
    â”œâ”€ åˆ†é…wear_leveling_extç»“æ„
    â”œâ”€ åˆå§‹åŒ–æ‰©å±•æ¥å£
    â”œâ”€ åˆå§‹åŒ–ç£¨æŸä¿¡æ¯ç¼“å­˜
    â”‚   â”œâ”€ è®¾ç½®æ‰¹é‡åˆ·æ–°å‚æ•°
    â”‚   â”‚   â”œâ”€ æ¯1000æ¬¡I/Oåˆ·æ–°
    â”‚   â”‚   â””â”€ æˆ–æ¯60ç§’åˆ·æ–°
    â”‚   â””â”€ åˆå§‹åŒ–ç£¨æŸé¢„æµ‹å‚æ•°
    â”œâ”€ åˆå§‹åŒ–å¿«ç…§å­˜å‚¨
    â”‚   â”œâ”€ åŠ¨æ€è®¡ç®—stripeæ•°é‡
    â”‚   â”œâ”€ åˆ†é…ä½å›¾å’Œå¿«ç…§æ•°ç»„
    â”‚   â””â”€ è®¾ç½®æ‰¹é‡åˆ·æ–°å‚æ•°
    â”‚       â”œâ”€ æ¯500æ¬¡I/Oåˆ·æ–°
    â”‚       â””â”€ æˆ–æ¯10ç§’åˆ·æ–°
    â””â”€ æ³¨å†Œåˆ°EC bdev
```

### 1.2 æ•°æ®ç»“æ„

```c
struct wear_leveling_ext {
    struct ec_bdev_extension_if ext_if;  // æ‰©å±•æ¥å£
    struct wear_data_provider data;      // æ•°æ®é‡‡é›†æ¨¡å—
    struct wear_scheduler_state sched;   // è°ƒåº¦ç­–ç•¥æ¨¡å—
    struct snapshot_storage snapshot;   // å¿«ç…§å­˜å‚¨
    // ...
};
```

---

## âœï¸ äºŒã€å†™å…¥æµç¨‹ï¼ˆç£¨æŸå‡è¡¡ï¼‰

### 2.1 å®Œæ•´æµç¨‹å›¾

```
å†™å…¥è¯·æ±‚
    â†“
ec_submit_rw_request()
    â”œâ”€ è®¡ç®—stripe_index
    â”œâ”€ è°ƒç”¨wear_leveling_select_base_bdevs()
    â”‚   â”œâ”€ æ‰¹é‡åˆ·æ–°æ£€æŸ¥
    â”‚   â”œâ”€ è·å–é»˜è®¤é€‰æ‹©ï¼ˆç¡®å®šæ€§ï¼‰
    â”‚   â”œâ”€ æ”¶é›†ç£¨æŸä¿¡æ¯
    â”‚   â”œâ”€ å¿«é€Ÿè·¯å¾„æ£€æŸ¥
    â”‚   â”œâ”€ ç¡®å®šæ€§åŠ æƒé€‰æ‹©
    â”‚   â””â”€ è¿”å›data_indiceså’Œparity_indices
    â”œâ”€ ISA-Lç¼–ç 
    â”œâ”€ å¹¶è¡Œå†™å…¥
    â””â”€ å­˜å‚¨å¿«ç…§
```

### 2.2 è¯¦ç»†æ­¥éª¤

#### æ­¥éª¤1: Stripeè®¡ç®—

```c
// åœ¨ec_submit_rw_request()ä¸­
start_strip = offset_blocks >> strip_size_shift;
stripe_index = start_strip / k;
```

**å…³é”®ç‚¹**ï¼š`stripe_index`æ˜¯ç¡®å®šæ€§çš„ï¼ŒåŒä¸€stripeæ€»æ˜¯å¾—åˆ°ç›¸åŒçš„ç´¢å¼•ã€‚

#### æ­¥éª¤2: Base Bdevé€‰æ‹©ï¼ˆç£¨æŸå‡è¡¡ï¼‰

```c
wear_leveling_select_base_bdevs()
    â”œâ”€ 1. æ‰¹é‡åˆ·æ–°æ£€æŸ¥
    â”‚   â””â”€ _collect_and_validate_wear_info_batch_refresh()
    â”‚       â”œâ”€ æ£€æŸ¥I/Oè®¡æ•°ï¼ˆæ¯1000æ¬¡ï¼‰
    â”‚       â”œâ”€ æ£€æŸ¥æ—¶é—´é—´éš”ï¼ˆæ¯60ç§’ï¼‰
    â”‚       â””â”€ å¦‚æœè¾¾åˆ°é˜ˆå€¼ï¼Œæ ‡è®°æ‰€æœ‰base bdevéœ€è¦åˆ·æ–°
    â”‚
    â”œâ”€ 2. è·å–é»˜è®¤é€‰æ‹©ï¼ˆç¡®å®šæ€§ï¼‰
    â”‚   â””â”€ ec_select_base_bdevs_default()
    â”‚       â””â”€ åŸºäºstripe_indexçš„è½®è¯¢åˆ†å¸ƒ
    â”‚           â””â”€ ä¾‹å¦‚ï¼šstripe_index=0 â†’ [0,1]æ•°æ®ï¼Œ[2,3]æ ¡éªŒ
    â”‚
    â”œâ”€ 3. æ”¶é›†ç£¨æŸä¿¡æ¯
    â”‚   â””â”€ _collect_and_validate_wear_info()
    â”‚       â”œâ”€ æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°ï¼ˆneeds_rereadæ ‡å¿—ï¼‰
    â”‚       â”œâ”€ å¦‚æœéœ€è¦ï¼ŒæŸ¥è¯¢NVMeå¥åº·ä¿¡æ¯
    â”‚       â”œâ”€ è®¡ç®—æƒé‡ï¼šweight = (100 - wear_level) Ã— 10 + 1
    â”‚       â””â”€ ç¼“å­˜ç£¨æŸä¿¡æ¯
    â”‚
    â”œâ”€ 4. å¿«é€Ÿè·¯å¾„æ£€æŸ¥
    â”‚   â””â”€ å¦‚æœç£¨æŸå·®å¼‚ < 5%ï¼Œä½¿ç”¨é»˜è®¤é€‰æ‹©
    â”‚       â””â”€ é¿å…ä¸å¿…è¦çš„è®¡ç®—å¼€é”€
    â”‚
    â””â”€ 5. ç¡®å®šæ€§åŠ æƒé€‰æ‹©
        â””â”€ _deterministic_weighted_selection()
            â”œâ”€ ä½¿ç”¨stripe_indexä½œä¸ºéšæœºç§å­
            â”œâ”€ LCGç”Ÿæˆç¡®å®šæ€§éšæœºæ•°
            â”œâ”€ æ ¹æ®æƒé‡æ¦‚ç‡é€‰æ‹©kä¸ªæ•°æ®å—
            â””â”€ æ ¡éªŒå—ä½¿ç”¨é»˜è®¤é€‰æ‹©
```

**æƒé‡è®¡ç®—ç¤ºä¾‹**ï¼š
```
å‡è®¾4ä¸ªNVMeçš„ç£¨æŸç¨‹åº¦ï¼š
  NVMe0n1: 10% â†’ æƒé‡ 901
  NVMe0n2: 20% â†’ æƒé‡ 801
  NVMe0n3: 30% â†’ æƒé‡ 701
  NVMe0n4: 40% â†’ æƒé‡ 601

æ€»æƒé‡ = 901 + 801 + 701 + 601 = 3004

é€‰æ‹©æ¦‚ç‡ï¼š
  NVMe0n1: 901/3004 â‰ˆ 30%
  NVMe0n2: 801/3004 â‰ˆ 27%
  NVMe0n3: 701/3004 â‰ˆ 23%
  NVMe0n4: 601/3004 â‰ˆ 20%
```

**ç¡®å®šæ€§ä¿è¯**ï¼š
- ä½¿ç”¨`stripe_index`ä½œä¸ºéšæœºç§å­
- åŒä¸€stripeæ€»æ˜¯å¾—åˆ°ç›¸åŒçš„éšæœºæ•°åºåˆ—
- ç¡®ä¿å†™å…¥å’Œè¯»å–æ—¶é€‰æ‹©ä¸€è‡´

#### æ­¥éª¤3: å¿«ç…§å­˜å‚¨

```c
// åœ¨I/Oå®Œæˆå›è°ƒä¸­
wear_leveling_ext_store_snapshot()
    â”œâ”€ å­˜å‚¨data_indiceså’Œparity_indicesåˆ°å¿«ç…§æ•°ç»„
    â”œâ”€ è®¾ç½®ä½å›¾æ ‡è®°ï¼ˆstripe_indexæœ‰å¿«ç…§ï¼‰
    â”œâ”€ æ›´æ–°pending_bitmap_updatesè®¡æ•°å™¨
    â””â”€ æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰¹é‡åˆ·æ–°
        â”œâ”€ æ¯500æ¬¡I/Oåˆ·æ–°
        â””â”€ æˆ–æ¯10ç§’åˆ·æ–°
```

**å¿«ç…§ç»“æ„**ï¼š
```c
struct bdev_selection_snapshot {
    uint8_t data_indices[EC_MAX_K];   // æ•°æ®å—ç´¢å¼•
    uint8_t parity_indices[EC_MAX_P]; // æ ¡éªŒå—ç´¢å¼•
};
```

---

## ğŸ“– ä¸‰ã€è¯»å–æµç¨‹ï¼ˆå¿«ç…§åŠ è½½ï¼‰

### 3.1 å®Œæ•´æµç¨‹å›¾

```
è¯»å–è¯·æ±‚
    â†“
ec_submit_rw_request()
    â”œâ”€ è®¡ç®—stripe_index
    â”œâ”€ è°ƒç”¨wear_leveling_load_snapshot()
    â”‚   â”œâ”€ æ£€æŸ¥å¿«ç…§ä½å›¾
    â”‚   â”œâ”€ å¦‚æœæœ‰å¿«ç…§ï¼Œä»æ•°ç»„è¯»å–
    â”‚   â””â”€ å¦‚æœæ²¡æœ‰å¿«ç…§ï¼Œè¿”å›falseï¼ˆä½¿ç”¨é»˜è®¤é€‰æ‹©ï¼‰
    â”œâ”€ ç¡®å®šç›®æ ‡æ•°æ®å—
    â””â”€ ç›´æ¥è¯»å–ï¼ˆæ— éœ€è§£ç ï¼‰
```

### 3.2 è¯¦ç»†æ­¥éª¤

#### æ­¥éª¤1: å¿«ç…§åŠ è½½

```c
wear_leveling_load_snapshot()
    â”œâ”€ æ£€æŸ¥å¿«ç…§å­˜å‚¨æ˜¯å¦å·²åˆå§‹åŒ–
    â”œâ”€ æ£€æŸ¥stripe_indexæ˜¯å¦åœ¨èŒƒå›´å†…
    â”œâ”€ æ£€æŸ¥ä½å›¾ï¼šstripe_indexæ˜¯å¦æœ‰å¿«ç…§ï¼Ÿ
    â”œâ”€ å¦‚æœæœ‰å¿«ç…§
    â”‚   â”œâ”€ ä»å¿«ç…§æ•°ç»„è¯»å–data_indiceså’Œparity_indices
    â”‚   â””â”€ è¿”å›true
    â””â”€ å¦‚æœæ²¡æœ‰å¿«ç…§
        â””â”€ è¿”å›falseï¼ˆä½¿ç”¨é»˜è®¤é€‰æ‹©ï¼‰
```

**ä¸ºä»€ä¹ˆéœ€è¦å¿«ç…§ï¼Ÿ**

1. **å†™å…¥æ—¶**ï¼šæ ¹æ®ç£¨æŸç¨‹åº¦é€‰æ‹©base bdevï¼ˆå¯èƒ½å˜åŒ–ï¼‰
2. **è¯»å–æ—¶**ï¼šå¿…é¡»ä»å†™å…¥æ—¶é€‰æ‹©çš„base bdevè¯»å–
3. **é—®é¢˜**ï¼šå¦‚æœç£¨æŸåˆ†å¸ƒå˜åŒ–ï¼Œé»˜è®¤é€‰æ‹©å¯èƒ½ä¸åŒ
4. **è§£å†³**ï¼šå¿«ç…§è®°å½•å†™å…¥æ—¶çš„é€‰æ‹©ï¼Œç¡®ä¿è¯»å–ä¸€è‡´æ€§

**ç¤ºä¾‹**ï¼š
```
å†™å…¥æ—¶ï¼ˆç£¨æŸï¼š[10,20,30,40]ï¼‰ï¼š
  stripe_index=0 â†’ é€‰æ‹©[0,1]ä½œä¸ºæ•°æ®å—
  å­˜å‚¨å¿«ç…§ï¼šdata_indices=[0,1], parity_indices=[2,3]

è¯»å–æ—¶ï¼ˆç£¨æŸå¯èƒ½å·²å˜åŒ–ï¼‰ï¼š
  åŠ è½½å¿«ç…§ï¼šdata_indices=[0,1], parity_indices=[2,3]
  ä»NVMe0n1è¯»å–æ•°æ®ï¼ˆè€Œä¸æ˜¯é‡æ–°è®¡ç®—ï¼‰
```

---

## ğŸ”„ å››ã€ç£¨æŸä¿¡æ¯ç®¡ç†

### 4.1 ç£¨æŸä¿¡æ¯é‡‡é›†

#### æ–¹å¼1: æ‰¹é‡åˆ·æ–°ï¼ˆä¼˜åŒ–ï¼‰

```c
_collect_and_validate_wear_info_batch_refresh()
    â”œâ”€ æ£€æŸ¥I/Oè®¡æ•°é˜ˆå€¼ï¼ˆæ¯1000æ¬¡I/Oï¼‰
    â”œâ”€ æ£€æŸ¥æ—¶é—´é˜ˆå€¼ï¼ˆæ¯60ç§’ï¼‰
    â””â”€ å¦‚æœè¾¾åˆ°é˜ˆå€¼
        â”œâ”€ æ ‡è®°æ‰€æœ‰base bdevéœ€è¦åˆ·æ–°
        â”œâ”€ é‡ç½®I/Oè®¡æ•°å™¨
        â””â”€ æ›´æ–°æ—¶é—´æˆ³
```

**ä¼˜åŠ¿**ï¼š
- å‡å°‘NVMeå¥åº·ä¿¡æ¯æŸ¥è¯¢é¢‘ç‡
- é™ä½ç³»ç»Ÿå¼€é”€
- æ‰¹é‡å¤„ç†ï¼Œæå‡æ•ˆç‡

#### æ–¹å¼2: æŒ‰éœ€åˆ·æ–°

```c
should_reread_wear_level()
    â”œâ”€ æ£€æŸ¥æœ€å°è¯»å–é—´éš”ï¼ˆ30ç§’ï¼‰
    â”œâ”€ æ£€æŸ¥å†™å…¥é‡é˜ˆå€¼ï¼ˆ10GBï¼‰
    â””â”€ æ£€æŸ¥é¢„æµ‹ç£¨æŸå˜åŒ–é˜ˆå€¼ï¼ˆ5%ï¼‰
```

**è§¦å‘æ¡ä»¶**ï¼š
- è·ç¦»ä¸Šæ¬¡è¯»å–è¶…è¿‡30ç§’
- å†™å…¥é‡è¶…è¿‡10GB
- é¢„æµ‹ç£¨æŸå˜åŒ–è¶…è¿‡5%

### 4.2 ç£¨æŸé¢„æµ‹

```c
predict_wear_level_for_reread_check()
    â”œâ”€ è®¡ç®—å†™å…¥GBæ•°
    â”œâ”€ æ ¹æ®TBWè®¡ç®—ç£¨æŸå¢åŠ 
    â”‚   â””â”€ wear_increase = (gb_written / (TBW Ã— 1024)) Ã— 100
    â””â”€ æ›´æ–°predicted_wear_level
```

**é¢„æµ‹å…¬å¼**ï¼š
```
ç£¨æŸå¢åŠ (%) = (å†™å…¥GBæ•° / (TBW Ã— 1024)) Ã— 100

ä¾‹å¦‚ï¼š
  TBW = 180TB = 184,320 GB
  å†™å…¥100GB â†’ ç£¨æŸå¢åŠ  = (100 / 184320) Ã— 100 = 0.0543%
```

---

## âš¡ äº”ã€æ€§èƒ½ä¼˜åŒ–

### 5.1 æ‰¹é‡åˆ·æ–°ä¼˜åŒ–

| ä¼˜åŒ–é¡¹ | è¯´æ˜ | æ•ˆæœ |
|--------|------|------|
| ç£¨æŸä¿¡æ¯æ‰¹é‡åˆ·æ–° | æ¯1000æ¬¡I/Oæˆ–60ç§’æ‰¹é‡åˆ·æ–° | å‡å°‘NVMeæŸ¥è¯¢é¢‘ç‡90%+ |
| å¿«ç…§ä½å›¾æ‰¹é‡åˆ·æ–° | æ¯500æ¬¡I/Oæˆ–10ç§’æ‰¹é‡åˆ·æ–° | å‡å°‘ç¼“å­˜è¡Œå†™å…¥æ“ä½œ |
| æ—¶é—´å€’é€€ä¿æŠ¤ | å¤„ç†ç³»ç»Ÿæ—¶é—´è°ƒæ•´ | é˜²æ­¢æº¢å‡ºå’Œé”™è¯¯è®¡ç®— |

### 5.2 Write Countå¿«é€Ÿè·¯å¾„ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼Œå€Ÿé‰´FTLï¼‰

| ä¼˜åŒ–é¡¹ | è¯´æ˜ | æ•ˆæœ |
|--------|------|------|
| Write Countå¿«é€Ÿè·¯å¾„ | å½“write countå·®å¼‚>10%æ—¶ï¼ŒåŸºäºwrite counté€‰æ‹©ï¼Œè·³è¿‡NVMeæŸ¥è¯¢ | å»¶è¿Ÿé™ä½50-500å€ |
| é˜ˆå€¼åˆ¤æ–­ä¼˜åŒ– | å€Ÿé‰´FTLçš„10%é˜ˆå€¼è®¾è®¡ï¼Œå‡å°‘ä¸å¿…è¦çš„NVMeæŸ¥è¯¢ | å¹³å‡æ€§èƒ½æå‡çº¦50% |
| Write Countæƒé‡è®¡ç®— | åŸºäºwrite countè®¡ç®—æƒé‡ï¼Œçº¯å†…å­˜æ“ä½œ | æ— I/Oå¼€é”€ï¼Œ<1Î¼så®Œæˆ |

**æ€§èƒ½å¯¹æ¯”**ï¼š
- **ä¼˜åŒ–å‰**ï¼šæ€»æ˜¯æŸ¥è¯¢NVMeå¥åº·ä¿¡æ¯ï¼ˆ100-500Î¼sï¼‰
- **ä¼˜åŒ–å**ï¼šwrite countå·®å¼‚>10%æ—¶è·³è¿‡NVMeæŸ¥è¯¢ï¼ˆ<1Î¼sï¼‰
- **æå‡**ï¼šåœ¨å·®å¼‚æ˜æ˜¾æ—¶ï¼Œå»¶è¿Ÿé™ä½50-500å€

### 5.3 ç¼“å­˜ä¼˜åŒ–

| ä¼˜åŒ–é¡¹ | è¯´æ˜ | æ•ˆæœ |
|--------|------|------|
| ç£¨æŸä¿¡æ¯ç¼“å­˜ | ç¼“å­˜NVMeå¥åº·ä¿¡æ¯ | é¿å…é‡å¤æŸ¥è¯¢ |
| å¿«é€Ÿè·¯å¾„ | ç£¨æŸå·®å¼‚<5%æ—¶ä½¿ç”¨é»˜è®¤é€‰æ‹© | å‡å°‘è®¡ç®—å¼€é”€ |
| å¿«ç…§ä½å›¾ | å¿«é€Ÿæ£€æŸ¥stripeæ˜¯å¦æœ‰å¿«ç…§ | O(1)æŸ¥æ‰¾ |

### 5.3 ç¡®å®šæ€§ç®—æ³•ä¼˜åŒ–

| ä¼˜åŒ–é¡¹ | è¯´æ˜ | æ•ˆæœ |
|--------|------|------|
| LCGéšæœºæ•°ç”Ÿæˆå™¨ | ä½¿ç”¨stripe_indexä½œä¸ºç§å­ | ä¿è¯ç¡®å®šæ€§ |
| æƒé‡é¢„è®¡ç®— | é¢„è®¡ç®—æƒé‡è¡¨ | å‡å°‘è¿è¡Œæ—¶è®¡ç®— |
| ä½å›¾æŸ¥æ‰¾ | ä½¿ç”¨ä½å›¾ä¼˜åŒ–æŸ¥æ‰¾ | O(1)å¤æ‚åº¦ |

---

## ğŸ›¡ï¸ å…­ã€é”™è¯¯å¤„ç†å’Œé™çº§

### 6.1 è‡ªåŠ¨é™çº§æœºåˆ¶

```
æ£€æµ‹åˆ°è¿ç»­å¤±è´¥
    â†“
æ£€æŸ¥å¤±è´¥è®¡æ•°
    â”œâ”€ FULLæ¨¡å¼ï¼šè¿ç»­5æ¬¡å¤±è´¥ â†’ SIMPLEæ¨¡å¼
    â”œâ”€ SIMPLEæ¨¡å¼ï¼šè¿ç»­5æ¬¡å¤±è´¥ â†’ DISABLEDæ¨¡å¼
    â””â”€ DISABLEDæ¨¡å¼ï¼šä½¿ç”¨é»˜è®¤é€‰æ‹©
```

**é™çº§åœºæ™¯**ï¼š
- NVMeå¥åº·ä¿¡æ¯æŸ¥è¯¢å¤±è´¥
- ç£¨æŸä¿¡æ¯æ— æ•ˆ
- è®¾å¤‡ä¸å¯ç”¨

### 6.2 é”™è¯¯å¤„ç†ç­–ç•¥

| é”™è¯¯ç±»å‹ | å¤„ç†æ–¹å¼ |
|---------|---------|
| ç£¨æŸä¿¡æ¯æŸ¥è¯¢å¤±è´¥ | å›é€€åˆ°é»˜è®¤é€‰æ‹©ï¼Œå¢åŠ å¤±è´¥è®¡æ•° |
| å¿«ç…§å­˜å‚¨å¤±è´¥ | è®°å½•è­¦å‘Šï¼Œä¸å½±å“å†™å…¥ï¼ˆéå…³é”®ï¼‰ |
| å¿«ç…§åŠ è½½å¤±è´¥ | ä½¿ç”¨é»˜è®¤é€‰æ‹© |
| è®¾å¤‡æ•…éšœ | æ ‡è®°ä¸ºfailedï¼Œä½¿ç”¨å…¶ä»–è®¾å¤‡ |

---

## ğŸ“Š ä¸ƒã€å¿«ç…§å­˜å‚¨æœºåˆ¶

### 7.1 å¿«ç…§å­˜å‚¨ç»“æ„

```c
struct snapshot_storage {
    uint8_t *bitmap;  // ä½å›¾ï¼šæ ‡è®°å“ªäº›stripeæœ‰å¿«ç…§
    struct bdev_selection_snapshot *snapshots;  // å¿«ç…§æ•°ç»„
    uint64_t total_stripes;  // æ€»stripeæ•°ï¼ˆåŠ¨æ€è®¡ç®—ï¼‰
    uint64_t stored_snapshots;  // å®é™…å­˜å‚¨çš„å¿«ç…§æ•°
    // æ‰¹é‡åˆ·æ–°ç›¸å…³
    uint64_t pending_bitmap_updates;
    uint64_t last_bitmap_flush_timestamp;
    uint64_t bitmap_flush_interval_ios;  // 500
    uint64_t bitmap_flush_interval_us;   // 10ç§’
};
```

### 7.2 åŠ¨æ€å¤§å°è®¡ç®—

```c
calculate_snapshot_stripes()
    â”œâ”€ è®¡ç®—ï¼šstripe_count = total_blocks / (k Ã— strip_size)
    â”œâ”€ æ·»åŠ 10%ä½™é‡
    â”œâ”€ åº”ç”¨é™åˆ¶ï¼š
    â”‚   â”œâ”€ æœ€å°å€¼ï¼š1M
    â”‚   â”œâ”€ æœ€å¤§å€¼ï¼š256M
    â”‚   â””â”€ é»˜è®¤å€¼ï¼š64Mï¼ˆå¦‚æœè®¡ç®—å¤±è´¥ï¼‰
    â””â”€ è¿”å›stripe_count
```

**ç¤ºä¾‹**ï¼ˆ8ä¸ª3.8TB NVMeï¼Œk=2, p=2, strip_size=64KBï¼‰ï¼š
```
total_blocks = 8 Ã— 3.8TB / 512B â‰ˆ 62,500,000,000 blocks
stripe_count = 62,500,000,000 / (2 Ã— 128) â‰ˆ 244,140,625
æ·»åŠ 10%ä½™é‡ â†’ 268,554,688
åº”ç”¨æœ€å¤§å€¼é™åˆ¶ â†’ 256M
```

### 7.3 ä½å›¾æ“ä½œ

```c
// è®¾ç½®ä½å›¾ä½
snapshot_bitmap_set(snapshot, stripe_index)
    â”œâ”€ byte_idx = stripe_index / 8
    â”œâ”€ bit_idx = stripe_index % 8
    â””â”€ bitmap[byte_idx] |= (1U << bit_idx)

// æ£€æŸ¥ä½å›¾ä½
snapshot_bitmap_get(snapshot, stripe_index)
    â””â”€ è¿”å› (bitmap[byte_idx] & (1U << bit_idx)) != 0
```

---

## ğŸ¯ å…«ã€å…³é”®ç®—æ³•

### 8.1 ç¡®å®šæ€§åŠ æƒé€‰æ‹©ç®—æ³•

```c
_deterministic_weighted_selection()
    â”œâ”€ 1. ä½¿ç”¨stripe_indexç”Ÿæˆç¡®å®šæ€§ç§å­
    â”‚   â””â”€ seed = hash(stripe_index)
    â”‚
    â”œâ”€ 2. å¯¹æ¯ä¸ªæ•°æ®å—ä½ç½®ï¼ˆkæ¬¡å¾ªç¯ï¼‰
    â”‚   â”œâ”€ LCGç”Ÿæˆéšæœºæ•°ï¼šseed = seed Ã— 1664525 + 1013904223
    â”‚   â”œâ”€ è®¡ç®—éšæœºå€¼ï¼šrandom = seed % total_weight
    â”‚   â”œâ”€ ç´¯ç§¯æƒé‡æŸ¥æ‰¾
    â”‚   â””â”€ é€‰æ‹©å¯¹åº”çš„å€™é€‰base bdev
    â”‚
    â””â”€ 3. å¦‚æœæœªæ‰¾åˆ°ï¼Œå›é€€åˆ°æœ€å°ç£¨æŸé€‰æ‹©
```

**ç®—æ³•ç‰¹ç‚¹**ï¼š
- **ç¡®å®šæ€§**ï¼šåŒä¸€stripe_indexæ€»æ˜¯å¾—åˆ°ç›¸åŒç»“æœ
- **åŠ æƒéšæœº**ï¼šæ ¹æ®æƒé‡æ¦‚ç‡é€‰æ‹©ï¼Œç£¨æŸä½çš„è®¾å¤‡æ›´å®¹æ˜“è¢«é€‰ä¸­
- **å›é€€æœºåˆ¶**ï¼šå¦‚æœéšæœºé€‰æ‹©å¤±è´¥ï¼Œé€‰æ‹©ç£¨æŸæœ€ä½çš„è®¾å¤‡

**æƒé‡æ¥æº**ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰ï¼š
- **Write Countå¿«é€Ÿè·¯å¾„**ï¼šå¦‚æœwrite countå·®å¼‚>10%ï¼ŒåŸºäºwrite countè®¡ç®—æƒé‡
  - æƒé‡å…¬å¼ï¼š`weight = (max_write_count - write_count) Ã— 1001 / max_write_count`
  - ä¼˜åŠ¿ï¼šæ— éœ€NVMeæŸ¥è¯¢ï¼Œçº¯å†…å­˜è®¡ç®—ï¼ˆ<1Î¼sï¼‰
- **Wear Levelè·¯å¾„**ï¼šå¦‚æœwrite countå·®å¼‚<10%ï¼ŒåŸºäºwear levelè®¡ç®—æƒé‡
  - æƒé‡å…¬å¼ï¼š`weight = (100 - wear_level) Ã— 10 + 1`
  - éœ€è¦NVMeæŸ¥è¯¢ï¼ˆ100-500Î¼sï¼‰

### 8.2 æƒé‡è®¡ç®—å…¬å¼

#### æ–¹å¼1: åŸºäºWear Levelï¼ˆéœ€è¦NVMeæŸ¥è¯¢ï¼‰

```
weight = (100 - wear_level) Ã— 10 + 1

ç£¨æŸç­‰çº§èŒƒå›´ï¼š0-100
æƒé‡èŒƒå›´ï¼š1-1001

ç¤ºä¾‹ï¼š
  wear_level = 0  â†’ weight = 1001ï¼ˆæœ€é«˜ï¼‰
  wear_level = 50 â†’ weight = 501ï¼ˆä¸­ç­‰ï¼‰
  wear_level = 100 â†’ weight = 1ï¼ˆæœ€ä½ï¼Œä½†ä¸ä¸º0ï¼‰
```

**ä¸ºä»€ä¹ˆ+1ï¼Ÿ**
- ç¡®ä¿æƒé‡ä¸ä¸º0
- å³ä½¿ç£¨æŸ100%çš„è®¾å¤‡ä¹Ÿæœ‰è¢«é€‰ä¸­çš„æœºä¼š
- é¿å…å®Œå…¨æ’é™¤é«˜ç£¨æŸè®¾å¤‡

#### æ–¹å¼2: åŸºäºWrite Countï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼Œæ— éœ€NVMeæŸ¥è¯¢ï¼‰

```
weight = (max_write_count - write_count) Ã— 1001 / max_write_count

Write countèŒƒå›´ï¼š0 - max_write_count
æƒé‡èŒƒå›´ï¼š1-1001

ç¤ºä¾‹ï¼ˆmax_write_count = 1000ï¼‰ï¼š
  write_count = 0    â†’ weight = 1001ï¼ˆæœ€é«˜ï¼‰
  write_count = 500  â†’ weight = 501ï¼ˆä¸­ç­‰ï¼‰
  write_count = 1000 â†’ weight = 1ï¼ˆæœ€ä½ï¼Œä½†ä¸ä¸º0ï¼‰
```

**æ€§èƒ½ä¼˜åŠ¿**ï¼š
- **æ— éœ€NVMeæŸ¥è¯¢**ï¼šçº¯å†…å­˜è®¡ç®—ï¼Œå»¶è¿Ÿ<1Î¼sï¼ˆvs 100-500Î¼sï¼‰
- **è‡ªåŠ¨è§¦å‘**ï¼šå½“write countå·®å¼‚>10%æ—¶è‡ªåŠ¨ä½¿ç”¨
- **ä¸wear levelæƒé‡å…¼å®¹**ï¼šæƒé‡èŒƒå›´ç›¸åŒï¼ˆ1-1001ï¼‰ï¼Œç®—æ³•ä¸€è‡´

---

## ğŸ“ ä¹ã€é…ç½®å‚æ•°

### 9.1 ç£¨æŸå‡è¡¡å‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `wear_cache_refresh_interval_ios` | 1000 | æ¯Næ¬¡I/Oæ‰¹é‡åˆ·æ–°ç£¨æŸä¿¡æ¯ |
| `wear_cache_refresh_interval_us` | 60000000 | æ¯Må¾®ç§’æ‰¹é‡åˆ·æ–°ï¼ˆ60ç§’ï¼‰ |
| `wear_predict_threshold_blocks` | 20971520 | å†™å…¥é‡é˜ˆå€¼ï¼ˆ10GBï¼‰ |
| `wear_predict_threshold_percent` | 5 | é¢„æµ‹ç£¨æŸå˜åŒ–é˜ˆå€¼ï¼ˆ5%ï¼‰ |
| `wear_read_interval_us` | 30000000 | æœ€å°è¯»å–é—´éš”ï¼ˆ30ç§’ï¼‰ |
| `WRITE_COUNT_DIFF_THRESHOLD_PERCENT` | 10 | Write countå·®å¼‚é˜ˆå€¼ï¼ˆ10%ï¼Œå€Ÿé‰´FTLï¼‰ |

### 9.2 å¿«ç…§å‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `bitmap_flush_interval_ios` | 500 | æ¯Næ¬¡I/Oåˆ·æ–°ä½å›¾ |
| `bitmap_flush_interval_us` | 10000000 | æ¯Må¾®ç§’åˆ·æ–°ä½å›¾ï¼ˆ10ç§’ï¼‰ |
| `SNAPSHOT_STRIPES_MIN` | 1048576 | æœ€å°stripeæ•°ï¼ˆ1Mï¼‰ |
| `SNAPSHOT_STRIPES_MAX` | 268435456 | æœ€å¤§stripeæ•°ï¼ˆ256Mï¼‰ |
| `SNAPSHOT_STRIPES_DEFAULT` | 67108864 | é»˜è®¤stripeæ•°ï¼ˆ64Mï¼‰ |

---

## ğŸ” åã€è°ƒè¯•å’Œç›‘æ§

### 10.1 ç»Ÿè®¡ä¿¡æ¯

```c
struct wear_scheduler_state {
    uint64_t fast_path_hits;           // å¿«é€Ÿè·¯å¾„å‘½ä¸­æ¬¡æ•°ï¼ˆwear diff < thresholdï¼‰
    uint64_t write_count_fast_path_hits; // Write countå¿«é€Ÿè·¯å¾„å‘½ä¸­æ¬¡æ•°ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
    uint64_t wear_based_selections;    // åŸºäºç£¨æŸçš„é€‰æ‹©æ¬¡æ•°
    uint8_t consecutive_failures;      // è¿ç»­å¤±è´¥æ¬¡æ•°
    // ...
};

struct snapshot_storage {
    uint64_t stored_snapshots;  // å®é™…å­˜å‚¨çš„å¿«ç…§æ•°
    uint64_t default_selections;  // ä½¿ç”¨é»˜è®¤é€‰æ‹©çš„æ¬¡æ•°
    // ...
};
```

**ç»Ÿè®¡è¯´æ˜**ï¼š
- `fast_path_hits`ï¼šç£¨æŸå·®å¼‚<5%æ—¶ä½¿ç”¨é»˜è®¤é€‰æ‹©çš„æ¬¡æ•°
- `write_count_fast_path_hits`ï¼šwrite countå·®å¼‚>10%æ—¶ä½¿ç”¨å¿«é€Ÿè·¯å¾„çš„æ¬¡æ•°ï¼ˆæ–°å¢ï¼‰
- ä¸¤ä¸ªå¿«é€Ÿè·¯å¾„å¯ä»¥åŒæ—¶å·¥ä½œï¼Œè¿›ä¸€æ­¥æå‡æ€§èƒ½

### 10.2 æ—¥å¿—çº§åˆ«

- **ERROR**ï¼šä¸¥é‡é”™è¯¯ï¼Œå¯èƒ½å¯¼è‡´é™çº§
- **WARN**ï¼šè­¦å‘Šä¿¡æ¯ï¼Œä¸å½±å“åŠŸèƒ½
- **NOTICE**ï¼šé‡è¦ä¿¡æ¯ï¼Œå¦‚å¿«ç…§å­˜å‚¨åˆå§‹åŒ–
- **DEBUG**ï¼šè°ƒè¯•ä¿¡æ¯ï¼Œè¯¦ç»†æµç¨‹

---

## ğŸ“š åä¸€ã€ç›¸å…³æ–‡æ¡£

- [ECæ¨¡å—I/Oæµè½¬è¯¦è§£](./EC_IO_FLOW_GUIDE.md)
- [ECæ¨¡å—è¯¦ç»†è¯´æ˜](./EC_MODULE_DETAILED_GUIDE.md)
- [ECæ¨¡å—æ¶æ„æ–‡æ¡£](./EC_BDEV_ARCHITECTURE.md)

---

## ğŸ¯ åäºŒã€æ€»ç»“

### æ ¸å¿ƒè®¾è®¡åŸåˆ™

1. **ç¡®å®šæ€§**ï¼šåŒä¸€stripeæ€»æ˜¯é€‰æ‹©ç›¸åŒçš„base bdev
2. **ä½å¼€é”€**ï¼šæ‰¹é‡åˆ·æ–°å’Œç¼“å­˜æœºåˆ¶å‡å°‘æŸ¥è¯¢é¢‘ç‡
3. **è‡ªåŠ¨é™çº§**ï¼šæ£€æµ‹åˆ°æ•…éšœæ—¶è‡ªåŠ¨é™çº§ï¼Œä¿è¯å¯ç”¨æ€§
4. **ä¸€è‡´æ€§**ï¼šå¿«ç…§æœºåˆ¶ç¡®ä¿è¯»å–ä¸€è‡´æ€§

### æ€§èƒ½ä¼˜åŒ–äº®ç‚¹

- âœ… æ‰¹é‡åˆ·æ–°æœºåˆ¶ï¼ˆå‡å°‘90%+æŸ¥è¯¢ï¼‰
- âœ… **Write Countå¿«é€Ÿè·¯å¾„**ï¼ˆå€Ÿé‰´FTLï¼Œå·®å¼‚>10%æ—¶è·³è¿‡NVMeæŸ¥è¯¢ï¼Œå»¶è¿Ÿé™ä½50-500å€ï¼‰
- âœ… å¿«é€Ÿè·¯å¾„ä¼˜åŒ–ï¼ˆç£¨æŸå·®å¼‚å°æ—¶è·³è¿‡è®¡ç®—ï¼‰
- âœ… å¿«ç…§æ‰¹é‡åˆ·æ–°ï¼ˆå‡å°‘ç¼“å­˜è¡Œå†™å…¥ï¼‰
- âœ… ç¡®å®šæ€§ç®—æ³•ï¼ˆä¿è¯ä¸€è‡´æ€§ï¼‰

### å…³é”®ä»£ç è·¯å¾„

- **å†™å…¥é€‰æ‹©**ï¼š`wear_leveling_select_base_bdevs()` â†’ `select_wear_based_strategy()`
- **å¿«ç…§å­˜å‚¨**ï¼š`wear_leveling_ext_store_snapshot()`
- **å¿«ç…§åŠ è½½**ï¼š`wear_leveling_load_snapshot()`
- **ç£¨æŸé‡‡é›†**ï¼š`_collect_and_validate_wear_info()`
